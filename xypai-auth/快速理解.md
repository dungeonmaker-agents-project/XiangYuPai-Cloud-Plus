# XyPai-Auth 认证模块快速理解

## 📌 核心定位
向娱拍 App 用户认证授权服务，基于 Spring Cloud 微服务架构。

**本模块职责**：提供认证 API，不直接连接数据库，通过 Dubbo RPC 调用 `xypai-user` 服务获取用户数据。

## 🎯 主要功能
- **SMS 登录**：验证码登录 + 自动注册
- **密码登录**：手机号/邮箱 + 密码
- **忘记密码**：短信验证 → 重置密码
- **支付密码**：设置、修改、验证支付密码
- **Token 管理**：JWT token 签发、刷新、登出

## 🏗️ 技术栈
```
Spring Boot 3.x + Sa-Token + Nacos + Dubbo RPC
Redis (验证码缓存 + Token 存储)
```

## 📁 核心目录结构
```
xypai-auth/
├── controller/          # API 控制器（对外提供认证接口）
│   ├── AppAuthController.java           # App 登录接口
│   ├── ForgotPasswordController.java    # 忘记密码
│   ├── PaymentPasswordController.java   # 支付密码
│   └── SmsController.java               # 短信验证码
├── service/             # 认证策略（Strategy 模式）
│   └── impl/
│       ├── AppSmsAuthStrategy.java      # SMS 登录 + 自动注册
│       ├── AppPasswordAuthStrategy.java # 密码登录
│       └── ...（通过 Dubbo 调用 xypai-user 服务）
└── domain/
    ├── dto/             # 请求 DTO
    └── vo/              # 响应 VO
```

## 🔑 核心接口
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /auth/login/sms` | 验证码登录 | `isNewUser` 标识是否新用户 |
| `POST /auth/login/password` | 密码登录 | - |
| `POST /auth/forgot-password/verify-mobile` | 忘记密码：验证手机 | - |
| `POST /auth/forgot-password/reset` | 忘记密码：重置密码 | - |
| `POST /auth/payment-password/set` | 设置支付密码 | 6 位数字 |
| `POST /auth/payment-password/verify` | 验证支付密码 | 用于支付前验证 |
| `POST /auth/sms/send` | 发送验证码 | 限流 60s/次 |

## 🏛️ 微服务架构
```
┌─────────────────┐
│  xypai-auth     │  ← 本模块（认证服务，无数据库）
│  (认证 API)     │
└────────┬────────┘
         │ Dubbo RPC
         ↓
┌─────────────────┐
│ xypai-user      │  ← 用户服务（连接数据库）
│ (用户数据 CRUD) │
└────────┬────────┘
         │ MyBatis Plus
         ↓
┌─────────────────┐
│ xypai_user.xy_user │  ← MySQL 数据库表（33 字段）
└─────────────────┘
```

## 🔥 技术亮点
1. **微服务解耦**：认证服务与用户数据服务分离，本模块不直接连接数据库
2. **策略模式**：每种登录方式独立策略类（SMS、密码、社交登录等）
3. **Dubbo RPC**：通过 `RemoteAppUserService` 远程调用用户服务
4. **自动注册**：SMS 登录时未注册用户自动创建（调用远程服务）
5. **无租户设计**：App 用户无需租户概念，简化认证流程

## 📦 依赖关系
```
xypai-auth (本模块)
  ↓ Dubbo RPC 调用
xypai-api-appuser (远程接口)
  ↓ 实现
xypai-user (用户服务)
  ↓ 连接
xypai_user 数据库 → xy_user 表
```

## 🚀 快速启动
```bash
# 1. 确保依赖服务已启动
#    - Nacos（服务注册中心）
#    - Redis（验证码 + Token）
#    - xypai-user 服务（提供用户数据，需连接 MySQL）

# 2. 启动本服务
cd xypai-auth
mvn clean package -DskipTests
java -jar target/xypai-auth.jar

# 默认端口：8200
# Swagger UI: http://localhost:8200/doc.html
```

## 📌 注意事项
- **无数据库连接**：本模块不直接连接数据库，所有用户数据操作通过 Dubbo RPC 调用 `xypai-user` 服务
- **依赖服务**：必须先启动 Nacos、Redis、xypai-user 服务，否则无法正常工作
- SMS 验证码依赖 Redis，60 秒有效期
- 密码使用 BCrypt 加密，前端不需加密
- `isNewUser` 字段用于前端判断跳转（完善资料 vs 主页）
- 支付密码必须 6 位数字
- 所有接口返回统一格式 `R<T>` (code, message, data)
