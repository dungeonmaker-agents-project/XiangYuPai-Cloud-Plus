<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.dromara.auth.mapper.XyUserMapper">

    <resultMap id="XyUserResult" type="org.dromara.auth.domain.entity.XyUser">
        <id property="userId" column="user_id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="username" column="username"/>
        <result property="nickname" column="nickname"/>
        <result property="email" column="email"/>
        <result property="mobile" column="mobile"/>
        <result property="password" column="password"/>
        <result property="avatar" column="avatar"/>
        <result property="gender" column="gender"/>
        <result property="birthday" column="birthday"/>
        <result property="bio" column="bio"/>
        <result property="isRealVerified" column="is_real_verified"/>
        <result property="realName" column="real_name"/>
        <result property="idCardEncrypted" column="id_card_encrypted"/>
        <result property="idCardLast4" column="id_card_last4"/>
        <result property="isGodVerified" column="is_god_verified"/>
        <result property="isActivityExpert" column="is_activity_expert"/>
        <result property="isVip" column="is_vip"/>
        <result property="vipExpireTime" column="vip_expire_time"/>
        <result property="status" column="status"/>
        <result property="onlineStatus" column="online_status"/>
        <result property="lastLoginTime" column="last_login_time"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deletedAt" column="deleted_at"/>
        <result property="version" column="version"/>
        <result property="profileJson" column="profile_json"/>
        <result property="certificationJson" column="certification_json"/>
        <result property="statsJson" column="stats_json"/>
        <result property="walletJson" column="wallet_json"/>
        <result property="settingsJson" column="settings_json"/>
        <result property="socialJson" column="social_json"/>
        <result property="preferencesJson" column="preferences_json"/>
        <result property="customJson" column="custom_json"/>
    </resultMap>

    <sql id="selectXyUserVo">
        select user_id, tenant_id, username, nickname, email, mobile, password,
               avatar, gender, birthday, bio,
               is_real_verified, real_name, id_card_encrypted, id_card_last4,
               is_god_verified, is_activity_expert, is_vip, vip_expire_time,
               status, online_status, last_login_time,
               created_at, updated_at, deleted_at, version,
               profile_json, certification_json, stats_json, wallet_json,
               settings_json, social_json, preferences_json, custom_json
        from xy_user
    </sql>

    <!-- 根据用户名查询用户 -->
    <select id="selectByUsername" parameterType="String" resultMap="XyUserResult">
        <include refid="selectXyUserVo"/>
        where username = #{username}
          and tenant_id = #{tenantId}
          and deleted_at is null
    </select>

    <!-- 根据邮箱查询用户 -->
    <select id="selectByEmail" parameterType="String" resultMap="XyUserResult">
        <include refid="selectXyUserVo"/>
        where email = #{email}
          and tenant_id = #{tenantId}
          and deleted_at is null
    </select>

    <!-- 根据手机号查询用户 -->
    <select id="selectByMobile" parameterType="String" resultMap="XyUserResult">
        <include refid="selectXyUserVo"/>
        where mobile = #{mobile}
          and tenant_id = #{tenantId}
          and deleted_at is null
    </select>

    <!-- 根据用户ID查询用户 -->
    <select id="selectByUserId" resultMap="XyUserResult">
        <include refid="selectXyUserVo"/>
        where user_id = #{userId}
          and tenant_id = #{tenantId}
          and deleted_at is null
    </select>

    <!-- 根据OpenID查询用户（从social_json中查询） -->
    <select id="selectByOpenid" parameterType="String" resultMap="XyUserResult">
        <include refid="selectXyUserVo"/>
        where JSON_CONTAINS(social_json, JSON_QUOTE(#{openid}), '$.openid')
          or JSON_CONTAINS(social_json, JSON_QUOTE(#{openid}), '$.wechat_openid')
          or JSON_CONTAINS(social_json, JSON_QUOTE(#{openid}), '$.unionid')
          and deleted_at is null
        limit 1
    </select>

    <!-- 更新用户最后登录时间 -->
    <update id="updateLastLoginTime">
        update xy_user
        set last_login_time = now(),
            updated_at = now()
        where user_id = #{userId}
          and deleted_at is null
    </update>

    <!-- 更新用户在线状态 -->
    <update id="updateOnlineStatus">
        update xy_user
        set online_status = #{onlineStatus},
            updated_at = now()
        where user_id = #{userId}
          and deleted_at is null
    </update>

    <!-- 检查用户名是否存在 -->
    <select id="checkUsernameExists" resultType="int">
        select count(1)
        from xy_user
        where username = #{username}
          and tenant_id = #{tenantId}
          and deleted_at is null
    </select>

    <!-- 检查邮箱是否存在 -->
    <select id="checkEmailExists" resultType="int">
        select count(1)
        from xy_user
        where email = #{email}
          and tenant_id = #{tenantId}
          and deleted_at is null
    </select>

    <!-- 检查手机号是否存在 -->
    <select id="checkMobileExists" resultType="int">
        select count(1)
        from xy_user
        where mobile = #{mobile}
          and tenant_id = #{tenantId}
          and deleted_at is null
    </select>

</mapper>

