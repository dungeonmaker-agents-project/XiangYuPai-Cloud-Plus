# xypai-auth 接口对接文档

## 概述

本文档记录 xypai-auth 认证服务与前端 App 的接口对接情况。

**更新日期**: 2025-11-25

**前端项目**: XiangYuPai-RNExpoAPP
**后端项目**: RuoYi-Cloud-Plus/xypai-auth

---

## Gateway 路由规则

```yaml
# 前端请求 → Gateway → 后端服务
前端请求: http://gateway:8080/xypai-auth/auth/xxx
Gateway StripPrefix=1 后转发: http://xypai-auth/auth/xxx
```

---

## 已实现接口清单

### 1. 登录相关

| 接口 | 方法 | 前端路径 | 后端路径 | Controller | 状态 |
|------|------|---------|---------|------------|------|
| SMS验证码登录 | POST | `/xypai-auth/auth/login/sms` | `/auth/login/sms` | AppAuthController | ✅ 已实现 |
| 密码登录 | POST | `/xypai-auth/auth/login/password` | `/auth/login/password` | AppAuthController | ✅ 已实现 |

#### SMS登录请求/响应

**请求**:
```json
POST /xypai-auth/auth/login/sms
{
  "countryCode": "+86",
  "mobile": "13800138000",
  "verificationCode": "123456"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expireIn": 7200,
    "userId": "1001",
    "nickname": "138****8000",
    "avatar": null,
    "isNewUser": true
  }
}
```

**关键字段说明**:
- `isNewUser`: true=新用户（前端跳转完善资料页），false=老用户（前端跳转主页）

### 2. 验证码相关

| 接口 | 方法 | 前端路径 | 后端路径 | Controller | 状态 |
|------|------|---------|---------|------------|------|
| 发送验证码 | POST | `/xypai-auth/auth/sms/send` | `/auth/sms/send` | SmsController | ✅ 已实现 |

#### 发送验证码请求/响应

**请求**:
```json
POST /xypai-auth/auth/sms/send
{
  "phoneNumber": "13800138000",
  "purpose": "LOGIN",
  "countryCode": "+86"
}
```

**purpose 可选值**:
- `LOGIN` - 登录验证码
- `RESET_PASSWORD` - 重置密码验证码

**响应**:
```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "codeId": "xxx",
    "expiresIn": 300,
    "nextSendTime": 60,
    "phoneNumber": "13800138000",
    "code": "123456"  // 仅开发环境返回
  }
}
```

### 3. Token管理

| 接口 | 方法 | 前端路径 | 后端路径 | Controller | 状态 |
|------|------|---------|---------|------------|------|
| 刷新Token | POST | `/xypai-auth/auth/token/refresh` | `/auth/token/refresh` | AppTokenController | ✅ 已实现 |
| 登出 | POST | `/xypai-auth/auth/logout` | `/auth/logout` | AppTokenController | ✅ 已实现 |

#### 刷新Token请求/响应

**请求**:
```json
POST /xypai-auth/auth/token/refresh
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**响应**:
```json
{
  "code": 200,
  "message": "Token刷新成功",
  "data": {
    "token": "新的access_token",
    "refreshToken": "refresh_token",
    "expireIn": 7200
  }
}
```

### 4. 忘记密码流程

| 接口 | 方法 | 前端路径 | 后端路径 | Controller | 状态 |
|------|------|---------|---------|------------|------|
| 验证重置密码验证码 | POST | `/xypai-auth/auth/password/reset/verify` | `/auth/password/reset/verify` | ForgotPasswordController | ✅ 已实现 |
| 重置密码 | POST | `/xypai-auth/auth/password/reset/confirm` | `/auth/password/reset/confirm` | ForgotPasswordController | ✅ 已实现 |

#### 完整流程

1. **步骤1**: 发送验证码 → `POST /xypai-auth/auth/sms/send` (purpose="RESET_PASSWORD")
2. **步骤2**: 验证验证码 → `POST /xypai-auth/auth/password/reset/verify`
3. **步骤3**: 重置密码 → `POST /xypai-auth/auth/password/reset/confirm`

#### 验证验证码请求

```json
POST /xypai-auth/auth/password/reset/verify
{
  "mobile": "13800138000",
  "countryCode": "+86",
  "verificationCode": "123456"
}
```

#### 重置密码请求

```json
POST /xypai-auth/auth/password/reset/confirm
{
  "mobile": "13800138000",
  "countryCode": "+86",
  "verificationCode": "123456",
  "newPassword": "newPassword123"
}
```

---

## 未实现接口（待定）

以下接口前端代码中存在，但后端暂未实现。如需使用，需要先添加后端接口。

| 接口 | 方法 | 前端路径 | 用途 | 优先级 | 备注 |
|------|------|---------|------|--------|------|
| 检查用户是否存在 | POST | `/xypai-auth/auth/user/exists` | 注册前检查手机号 | 低 | SMS登录已自动注册，可能不需要 |
| 单独验证验证码 | POST | `/xypai-auth/auth/sms/verify` | 独立验证验证码 | 低 | 重置密码流程已包含验证逻辑 |

### 如需实现 `/auth/user/exists`

**请求格式**:
```json
POST /xypai-auth/auth/user/exists
{
  "phone": "13800138000",
  "region": "+86"
}
```

**响应格式**:
```json
{
  "code": 200,
  "data": {
    "exists": true,
    "verified": true
  }
}
```

### 如需实现 `/auth/sms/verify`

**请求格式**:
```json
POST /xypai-auth/auth/sms/verify
{
  "phone": "13800138000",
  "code": "123456",
  "region": "+86"
}
```

**响应格式**:
```json
{
  "code": 200,
  "message": "验证成功"
}
```

---

## 用户资料接口

用户资料接口位于 **xypai-user** 服务，不在 xypai-auth 服务中。

| 接口 | 方法 | 前端路径 | 后端服务 | 状态 |
|------|------|---------|---------|------|
| 获取用户资料 | GET | `/xypai-user/api/v1/user/profile` | xypai-user | ✅ 已实现 |

---

## Gateway 白名单配置

以下接口需要在 Gateway 白名单中配置（无需登录即可访问）：

```yaml
# ruoyi-gateway.yml
security:
  ignore:
    whites:
      # XYPai Auth 模块白名单
      - /xypai-auth/auth/login/sms
      - /xypai-auth/auth/login/password
      - /xypai-auth/auth/sms/send
      - /xypai-auth/auth/password/reset/verify
      - /xypai-auth/auth/password/reset/confirm
```

---

## 测试文件

| 测试文件 | 测试内容 |
|---------|---------|
| `SmsRegisterAndLoginTest.java` | SMS注册即登录功能测试 |
| `AppSmsRegistrationTest.java` | App SMS注册/登录集成测试 |
| `SimpleSaTokenTest.java` | Sa-Token集成测试 |

---

## 前端文件

| 文件 | 说明 |
|------|------|
| `src/features/AuthModule/api/authApi.ts` | 前端认证API封装 |
| `src/features/AuthModule/快速理解.md` | 前端模块文档 |

---

## 更新记录

| 日期 | 更新内容 |
|------|---------|
| 2025-11-25 | 创建文档，完成接口对接分析 |
