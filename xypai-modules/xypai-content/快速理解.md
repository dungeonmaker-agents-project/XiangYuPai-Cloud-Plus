# XyPai-Content 内容服务快速理解

## 📌 核心定位
向娱拍内容服务，基于 Spring Cloud 微服务架构。

**本模块职责**：提供动态 Feed 流、评论系统、话题管理、互动功能（点赞/收藏/分享）、**组局活动管理**，直接连接 `xypai_content` 数据库。

## 🎯 主要功能
- **Feed 流**：关注 Tab + 热门 Tab + 同城 Tab（空间查询）
- **评论系统**：一级评论 + 二级回复 + 点赞 + 置顶
- **话题管理**：话题创建、关联、热度排序
- **互动功能**：点赞、收藏、分享 + 实时统计
- **内容举报**：举报动态/评论 + 审核流程
- **组局活动**：活动发布、报名、审核、取消（2025-11-27 新增）

## 🏗️ 技术栈
```
Spring Boot 3.x + MyBatis Plus + Nacos + Elasticsearch
MySQL (xypai_content 数据库，15 张表) + Redis (缓存 + 热度计算)
```

## 📁 核心目录结构
```
xypai-content/
├── controller/
│   ├── FeedController.java            # Feed 流管理（发布/删除/查询）
│   ├── CommentController.java         # 评论系统（一级/二级）
│   ├── TopicController.java           # 话题管理（创建/关联）
│   ├── InteractionController.java     # 互动功能（点赞/收藏/分享）
│   ├── ReportController.java          # 举报功能
│   └── ActivityController.java        # 组局活动管理（新增）
├── service/impl/
│   ├── FeedServiceImpl.java           # Feed 服务（含推荐算法）
│   ├── CommentServiceImpl.java        # 评论服务（树形结构）
│   ├── TopicServiceImpl.java          # 话题服务（热度排序）
│   ├── InteractionServiceImpl.java    # 互动服务（统计更新）
│   ├── ReportServiceImpl.java         # 举报服务
│   └── ActivityServiceImpl.java       # 活动服务（新增）
├── mapper/
│   ├── FeedMapper.java
│   ├── CommentMapper.java
│   ├── ActivityMapper.java            # 活动 Mapper（新增）
│   ├── ActivityParticipantMapper.java # 参与者 Mapper（新增）
│   ├── ActivityTypeMapper.java        # 活动类型 Mapper（新增）
│   └── ...
└── domain/
    ├── entity/
    │   ├── Feed.java                  # 动态主表
    │   ├── FeedMedia.java             # 动态媒体（图片/视频）
    │   ├── Comment.java               # 评论表
    │   ├── Like.java                  # 点赞表
    │   ├── Activity.java              # 活动主表（新增）
    │   ├── ActivityParticipant.java   # 活动参与者（新增）
    │   └── ActivityType.java          # 活动类型配置（新增）
    ├── dto/
    │   ├── ActivityListQueryDTO.java  # 活动列表查询（新增）
    │   ├── ActivityPublishDTO.java    # 发布活动（新增）
    │   └── ActivityRegisterDTO.java   # 报名活动（新增）
    └── vo/
        ├── ActivityListVO.java        # 活动列表（新增）
        └── ActivityDetailVO.java      # 活动详情（新增）
```

## 🔑 核心接口

### Feed 流
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /content/feed` | 发布动态 | 支持图片（最多9张）/视频（1个） |
| `GET /content/feed/following` | 关注 Tab | 时间倒序 |
| `GET /content/feed/hot` | 热门 Tab | 热度算法排序 |
| `GET /content/feed/nearby` | 同城 Tab | 空间查询（基于经纬度） |
| `DELETE /content/feed/:id` | 删除动态 | 级联删除评论/点赞 |

### 评论系统
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /content/comment` | 发表评论 | 一级/二级回复 |
| `GET /content/comment/:feedId` | 评论列表 | 树形结构，二级前3条展开 |
| `DELETE /content/comment/:id` | 删除评论 | 级联删除二级回复 |
| `PUT /content/comment/:id/pin` | 置顶评论 | 仅作者可操作 |

### 互动功能
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /content/like/:feedId` | 点赞动态 | 幂等性处理 |
| `POST /content/collect/:feedId` | 收藏动态 | - |
| `POST /content/share/:feedId` | 分享动态 | 分享计数 +1 |
| `GET /content/like/my` | 我的点赞列表 | 分页 |

### 话题管理
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `GET /content/topic/hot` | 热门话题 | 热度排序（讨论数 + 关注数） |
| `GET /content/topic/:id/feeds` | 话题下的动态 | 时间倒序 |

### 组局活动（新增）
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `GET /api/v1/activity/list` | 活动列表 | 支持分页、类型/城市/性别筛选、排序 |
| `GET /api/v1/activity/detail/:id` | 活动详情 | 含参与者列表、当前用户状态 |
| `POST /api/v1/activity/publish` | 发布活动 | 需登录，限流 10次/分钟 |
| `POST /api/v1/activity/register` | 报名活动 | 自动/需审核两种模式 |
| `POST /api/v1/activity/cancel-registration` | 取消报名 | - |
| `POST /api/v1/activity/approve` | 审核报名 | 仅发起人可操作 |
| `POST /api/v1/activity/cancel/:id` | 取消活动 | 仅发起人可操作 |
| `GET /api/v1/activity/types` | 活动类型列表 | 获取所有启用的活动类型 |
| `GET /api/v1/activity/types/hot` | 热门活动类型 | 按热度排序 |
| `POST /api/v1/activity/share/:id` | 分享活动 | 分享计数 +1 |

## 💾 数据库：xypai_content（15 张表）
```sql
-- Feed 相关（3 张表）
feed                   # 动态主表（内容、位置、可见范围）
feed_media             # 动态媒体（图片/视频 URL）
feed_topic             # 动态-话题关联表

-- 评论（1 张表）
comment                # 评论表（parent_id 区分一级/二级）

-- 互动（3 张表）
like                   # 点赞表（用户-动态/评论）
content_collection     # 收藏表
share                  # 分享表

-- 话题（1 张表）
topic                  # 话题表（名称、热度、封面）

-- 举报（1 张表）
report                 # 举报表（类型、原因、状态）

-- 组局活动（6 张表，新增）
activity               # 活动主表（标题、时间、地点、人数限制）
activity_type          # 活动类型配置（运动、聚餐、桌游等）
activity_image         # 活动图片（多图支持）
activity_tag           # 活动标签关联
activity_participant   # 活动参与者（报名、审核状态）
activity_payment       # 活动支付记录
```

## 🏛️ 微服务架构
```
┌─────────────────┐
│  App 客户端      │
└────────┬────────┘
         │ REST API
         ↓
┌─────────────────┐
│ xypai-content   │  ← 本模块（内容服务，独立运行）
│ (Feed/评论/活动) │
└────────┬────────┘
         │ MyBatis Plus
         ↓
┌─────────────────┐
│ xypai_content   │  ← MySQL 数据库（15 张表）
└─────────────────┘

         ↓ Elasticsearch（可选）
┌─────────────────┐
│ 内容搜索索引     │  ← Feed/话题全文搜索
└─────────────────┘
```

## 🔥 技术亮点
1. **三 Tab 设计**：关注流（时间序）+ 热门流（热度算法）+ 同城流（空间查询 Spatial Index）
2. **评论树形结构**：一级评论 + 二级回复，前 3 条二级自动展开，优化查询性能
3. **热度算法**：点赞数 × 1 + 评论数 × 2 + 分享数 × 3 + 时间衰减，实时计算热度
4. **幂等性设计**：点赞/收藏接口防重复提交（Redis + 唯一索引）
5. **Elasticsearch 集成**：Feed 内容全文搜索 + 话题搜索（可选开启）
6. **组局活动**：完整的活动发布、报名、审核流程，支持自动通过和人工审核两种模式

## 📦 依赖关系
```
xypai-content (本模块，独立服务)
  ↓ MyBatis Plus
xypai_content 数据库 (15 张表)
  ↓ Elasticsearch（可选）
内容搜索索引
```

## 🚀 快速启动
```bash
# 1. 确保依赖服务已启动
#    - Nacos（服务注册中心）
#    - MySQL（xypai_content 数据库，导入 sql/xypai_content.sql）
#    - Redis（缓存 + 热度计算）
#    - Elasticsearch（可选，用于搜索功能）

# 2. 启动本服务
cd xypai-content
mvn clean package -DskipTests
java -jar target/xypai-content.jar

# 默认端口：9403
# Swagger UI: http://localhost:9403/doc.html
```

## 📌 注意事项
- **独立服务**：本模块不依赖其他微服务，可独立启动和运行
- **数据库初始化**：首次启动前需导入 `sql/xypai_content.sql` 创建基础表，导入 `sql/activity_tables.sql` 创建活动相关表
- **媒体限制**：动态支持图片最多 9 张，视频最多 1 个
- **评论嵌套**：仅支持二级评论（一级评论 + 一级回复），不支持多级嵌套
- **话题关联**：一个动态最多关联 5 个话题
- **热度更新**：热度分数每 5 分钟异步计算一次（定时任务 + Redis）
- **Elasticsearch**：搜索功能为可选模块，不影响核心功能运行
- **活动报名**：支持自动通过和发起人审核两种模式，满员后自动更新状态
- 所有接口返回统一格式 `R<T>` (code, message, data)
