# XyPai-User ç”¨æˆ·æœåŠ¡å¿«é€Ÿç†è§£

## ğŸ“Œ æ ¸å¿ƒå®šä½
å‘å¨±æ‹ç”¨æˆ·æœåŠ¡ï¼ŒåŸºäº Spring Cloud å¾®æœåŠ¡æ¶æ„ã€‚

**æœ¬æ¨¡å—èŒè´£**ï¼šæä¾›ç”¨æˆ·èµ„æ–™ã€ç¤¾äº¤å…³ç³»ã€æŠ€èƒ½ç®¡ç†åŠŸèƒ½ï¼Œç›´æ¥è¿æ¥ `xypai_user` æ•°æ®åº“ï¼ŒåŒæ—¶ä½œä¸º Dubbo RPC Provider ä¸º `xypai-auth` æä¾›ç”¨æˆ·æ•°æ®æœåŠ¡ã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½
- **ç”¨æˆ·èµ„æ–™ç®¡ç†**ï¼š11 ä¸ªå¯ç¼–è¾‘å­—æ®µ + å®æ—¶ä¿å­˜
- **ç¤¾äº¤å…³ç³»**ï¼šå…³æ³¨/å–å…³ã€ç²‰ä¸/å…³æ³¨åˆ—è¡¨ã€æ‹‰é»‘ã€ä¸¾æŠ¥
- **æŠ€èƒ½å¸‚åœº**ï¼šçº¿ä¸ŠæŠ€èƒ½ï¼ˆæ¸¸æˆé™ªç©ï¼‰+ çº¿ä¸‹æŠ€èƒ½ï¼ˆæœ¬åœ°æœåŠ¡ï¼‰
- **RPC æœåŠ¡**ï¼šä¸ºè®¤è¯æœåŠ¡æä¾›ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æŸ¥è¯¢æ¥å£

## ğŸ—ï¸ æŠ€æœ¯æ ˆ
```
Spring Boot 3.x + MyBatis Plus + Dubbo RPC + Nacos
MySQL (xypai_user æ•°æ®åº“ï¼Œ9 å¼ è¡¨) + Redis (ç¼“å­˜) + OSS (æ–‡ä»¶å­˜å‚¨)
```

## ğŸ“ æ ¸å¿ƒç›®å½•ç»“æ„
```
xypai-user/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ app/                                # App ç«¯ API æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ ProfileController.java         # ç”¨æˆ·èµ„æ–™ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ RelationController.java        # ç¤¾äº¤å…³ç³»ï¼ˆå…³æ³¨/æ‹‰é»‘/ä¸¾æŠ¥ï¼‰
â”‚   â”‚   â””â”€â”€ SkillController.java           # æŠ€èƒ½ç®¡ç†ï¼ˆçº¿ä¸Š/çº¿ä¸‹ï¼‰
â”‚   â””â”€â”€ feign/
â”‚       â””â”€â”€ RemoteAppUserServiceImpl.java  # Dubbo RPC Provider
â”œâ”€â”€ service/impl/
â”‚   â”œâ”€â”€ UserServiceImpl.java               # ç”¨æˆ·æœåŠ¡ï¼ˆå« CRUDï¼‰
â”‚   â”œâ”€â”€ RelationServiceImpl.java           # å…³ç³»æœåŠ¡ï¼ˆåŒå‘ç®¡ç†ï¼‰
â”‚   â””â”€â”€ SkillServiceImpl.java              # æŠ€èƒ½æœåŠ¡ï¼ˆç©ºé—´æŸ¥è¯¢ï¼‰
â”œâ”€â”€ mapper/                                 # MyBatis Plus Mapperï¼ˆ9 ä¸ªï¼‰
â”‚   â”œâ”€â”€ UserMapper.java
â”‚   â”œâ”€â”€ UserRelationMapper.java
â”‚   â””â”€â”€ SkillMapper.java ...
â””â”€â”€ domain/
    â”œâ”€â”€ entity/                             # å®ä½“ç±»ï¼ˆ9 å¼ è¡¨ï¼‰
    â”œâ”€â”€ dto/                                # è¯·æ±‚ DTO
    â””â”€â”€ vo/                                 # å“åº” VO
```

## ğŸ”‘ æ ¸å¿ƒæ¥å£

### ç”¨æˆ·èµ„æ–™
| æ¥å£ | è¯´æ˜ | ç‰¹æ®Šå­—æ®µ |
|------|------|----------|
| `GET /api/user/profile/me` | è·å–æˆ‘çš„èµ„æ–™ | 11 ä¸ªå¯ç¼–è¾‘å­—æ®µ + JSON æ‰©å±• |
| `PUT /api/user/profile` | æ›´æ–°ç”¨æˆ·èµ„æ–™ | æ”¯æŒæ‰¹é‡æ›´æ–°å¤šä¸ªå­—æ®µ |
| `PUT /api/user/profile/nickname` | æ›´æ–°æ˜µç§° | - |
| `PUT /api/user/profile/avatar` | æ›´æ–°å¤´åƒ | OSS ä¸Šä¼  |
| `PUT /api/user/profile/birthday` | æ›´æ–°ç”Ÿæ—¥ | - |
| `PUT /api/user/profile/gender` | æ›´æ–°æ€§åˆ« | male/female |

### ç¤¾äº¤å…³ç³»
| æ¥å£ | è¯´æ˜ | ç‰¹æ®Šå­—æ®µ |
|------|------|----------|
| `POST /api/user/relation/follow/:followingId` | å…³æ³¨ç”¨æˆ· | åŒå‘ç»Ÿè®¡æ›´æ–° |
| `DELETE /api/user/relation/unfollow/:followingId` | å–æ¶ˆå…³æ³¨ | - |
| `GET /api/user/relation/followers` | ç²‰ä¸åˆ—è¡¨ | åˆ†é¡µ |
| `GET /api/user/relation/following` | å…³æ³¨åˆ—è¡¨ | åˆ†é¡µ |
| `POST /api/user/relation/block/:blockedUserId` | æ‹‰é»‘ç”¨æˆ· | - |
| `POST /api/user/relation/report/:reportedUserId` | ä¸¾æŠ¥ç”¨æˆ· | ä¸¾æŠ¥ç±»å‹ + åŸå›  |

### æŠ€èƒ½ç®¡ç†
| æ¥å£ | è¯´æ˜ | ç‰¹æ®Šå­—æ®µ |
|------|------|----------|
| `POST /api/user/skills/online` | åˆ›å»ºçº¿ä¸ŠæŠ€èƒ½ | gameName, gameRank, skillName, description, price, serviceHours, isOnline |
| `POST /api/user/skills/offline` | åˆ›å»ºçº¿ä¸‹æŠ€èƒ½ | serviceName, serviceType, description, price, latitude, longitude |
| `GET /api/user/skills/my` | æˆ‘çš„æŠ€èƒ½åˆ—è¡¨ | åˆ†é¡µæŸ¥è¯¢ |
| `PUT /api/user/skills/:skillId` | æ›´æ–°æŠ€èƒ½ | - |
| `DELETE /api/user/skills/:skillId` | åˆ é™¤æŠ€èƒ½ | - |
| `PUT /api/user/skills/:skillId/online` | ä¸Šæ¶æŠ€èƒ½ | è®¾ç½® is_online = 1 |
| `PUT /api/user/skills/:skillId/offline` | ä¸‹æ¶æŠ€èƒ½ | è®¾ç½® is_online = 0 |

## ğŸ’¾ æ•°æ®åº“ï¼šxypai_userï¼ˆ9 å¼ è¡¨ï¼‰
```sql
-- ç”¨æˆ·ç›¸å…³ï¼ˆ3 å¼ è¡¨ï¼‰
xy_user                # ç”¨æˆ·ä¸»è¡¨ï¼ˆ33 å­—æ®µ + 8 ä¸ª JSON æ‰©å±•å­—æ®µï¼‰
user_stats             # ç”¨æˆ·ç»Ÿè®¡ï¼ˆå…³æ³¨æ•°ã€ç²‰ä¸æ•°ã€æŠ€èƒ½æ•°ç­‰ï¼‰
user_relation          # å…³æ³¨å…³ç³»ï¼ˆåŒå‘è®°å½•ï¼‰

-- ç¤¾äº¤ç›¸å…³ï¼ˆ2 å¼ è¡¨ï¼‰
user_blacklist         # é»‘åå•
user_report            # ä¸¾æŠ¥è®°å½•

-- æŠ€èƒ½ç›¸å…³ï¼ˆ4 å¼ è¡¨ï¼‰
skill                  # æŠ€èƒ½ä¸»è¡¨ï¼ˆçº¿ä¸Š/çº¿ä¸‹åŒºåˆ†ï¼‰
skill_image            # æŠ€èƒ½å›¾ç‰‡
skill_promise          # æŠ€èƒ½æ‰¿è¯ºï¼ˆé™ªç©ä¿è¯ï¼‰
skill_available_time   # å¯ç”¨æ—¶é—´æ®µï¼ˆçº¿ä¸‹æŠ€èƒ½ï¼‰
```

## ğŸ›ï¸ å¾®æœåŠ¡æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  xypai-auth     â”‚  â† è®¤è¯æœåŠ¡ï¼ˆæ— æ•°æ®åº“ï¼‰
â”‚  (è®¤è¯ API)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Dubbo RPC è°ƒç”¨
         â”‚ RemoteAppUserService
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  xypai-user     â”‚  â† æœ¬æ¨¡å—ï¼ˆç”¨æˆ·æœåŠ¡ï¼‰
â”‚  (ç”¨æˆ· CRUD)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ MyBatis Plus
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ xypai_user      â”‚  â† MySQL æ•°æ®åº“ï¼ˆ9 å¼ è¡¨ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”¥ æŠ€æœ¯äº®ç‚¹
1. **Dubbo RPC Provider**ï¼šä¸º `xypai-auth` å’Œ `xypai-app-bff` æä¾›ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æŸ¥è¯¢ã€æŠ€èƒ½æŸ¥è¯¢ç­‰è¿œç¨‹æ¥å£
2. **MyBatis Plus + è‡ªå®šä¹‰ XML**ï¼šå¤§éƒ¨åˆ†ä½¿ç”¨ LambdaQueryWrapperï¼Œå¤æ‚æŸ¥è¯¢ä½¿ç”¨ UserMapper.xml
3. **é™æ—¶ä¸“äº«æŸ¥è¯¢**ï¼š`queryLimitedTimeUsers` é€šè¿‡ INNER JOIN skills æŸ¥è¯¢æœ‰ä¸Šæ¶æŠ€èƒ½çš„ç”¨æˆ·
4. **æŠ€èƒ½ç­›é€‰æŸ¥è¯¢**ï¼š`queryFilteredUsers` æ”¯æŒå¤šç»´åº¦ç­›é€‰ï¼ˆç±»å‹ã€æ€§åˆ«ã€å¹´é¾„ã€ä»·æ ¼ã€æ®µä½ç­‰ï¼‰
5. **åŒå‘ç»Ÿè®¡ç®¡ç†**ï¼šå…³æ³¨/å–å…³è‡ªåŠ¨æ›´æ–°åŒæ–¹çš„ç²‰ä¸æ•°å’Œå…³æ³¨æ•°
6. **æŠ€èƒ½å¸‚åœºè®¾è®¡**ï¼šçº¿ä¸ŠæŠ€èƒ½ï¼ˆæ¸¸æˆé™ªç©ï¼‰+ çº¿ä¸‹æŠ€èƒ½ï¼ˆæœ¬åœ°æœåŠ¡ + ç©ºé—´æŸ¥è¯¢ï¼‰
7. **JSON æ‰©å±•å­—æ®µ**ï¼š8 ä¸ª JSON å­—æ®µé¿å…é¢‘ç¹ä¿®è¡¨ï¼ˆprofile_json, stats_json, wallet_json ç­‰ï¼‰
8. **ç©ºé—´è·ç¦»è®¡ç®—**ï¼šä½¿ç”¨ MySQL ST_Distance_Sphere è®¡ç®—ç”¨æˆ·ä¸æŠ€èƒ½çš„è·ç¦»

## ğŸ“¦ ä¾èµ–å…³ç³»
```
xypai-auth (è®¤è¯æœåŠ¡)
  â†“ Dubbo RPC è°ƒç”¨ (ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æŸ¥è¯¢)
xypai-user (æœ¬æ¨¡å—) â† å®ç° xypai-api-appuser æ¥å£
  â†“ MyBatis Plus + UserMapper.xml
xypai_user æ•°æ®åº“ (9 å¼ è¡¨)

xypai-app-bff (èšåˆæœåŠ¡)
  â†“ Dubbo RPC è°ƒç”¨ (é™æ—¶ä¸“äº«ã€æŠ€èƒ½ç­›é€‰)
xypai-user (æœ¬æ¨¡å—)
  â†“ UserMapper.xml è‡ªå®šä¹‰æŸ¥è¯¢
  - queryLimitedTimeUsers: æŸ¥è¯¢æœ‰ä¸Šæ¶æŠ€èƒ½çš„ç”¨æˆ·
  - queryFilteredUsers: å¤šç»´åº¦ç­›é€‰ç”¨æˆ·
  - countLimitedTimeUsers: ç»Ÿè®¡ç”¨æˆ·æ•°
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨
```bash
# 1. ç¡®ä¿ä¾èµ–æœåŠ¡å·²å¯åŠ¨
#    - Nacosï¼ˆæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼‰
#    - MySQLï¼ˆxypai_user æ•°æ®åº“ï¼Œå¯¼å…¥ sql/xypai_user.sqlï¼‰
#    - Redisï¼ˆç¼“å­˜ï¼‰
#    - OSSï¼ˆæ–‡ä»¶å­˜å‚¨ï¼Œå¯é€‰ï¼‰

# 2. å¯åŠ¨æœ¬æœåŠ¡
cd xypai-user
mvn clean package -DskipTests
java -jar target/xypai-user.jar

# é»˜è®¤ç«¯å£ï¼š9401
# Swagger UI: http://localhost:9401/doc.html
```

## ğŸ“Œ æ³¨æ„äº‹é¡¹
- **ç›´æ¥è¿æ¥æ•°æ®åº“**ï¼šæœ¬æ¨¡å—ç›´æ¥è¿æ¥ `xypai_user` æ•°æ®åº“ï¼ŒåŒ…å« 9 å¼ è¡¨
- **Dubbo RPC Provider**ï¼šå¿…é¡»å…ˆå¯åŠ¨æœ¬æœåŠ¡ï¼Œ`xypai-auth` å’Œ `xypai-app-bff` æ‰èƒ½æ­£å¸¸è°ƒç”¨
- **æ•°æ®åº“åˆå§‹åŒ–**ï¼šé¦–æ¬¡å¯åŠ¨å‰éœ€å¯¼å…¥ `sql/xypai_user.sql` åˆ›å»ºè¡¨ç»“æ„
- **æµ‹è¯•æ•°æ®åˆå§‹åŒ–**ï¼šå¯æ‰§è¡Œ `script/sql/Xuser/sql/05_init_skills_test_data.sql` æ·»åŠ æŠ€èƒ½æµ‹è¯•æ•°æ®
- `xy_user` è¡¨æœ‰ 8 ä¸ª JSON æ‰©å±•å­—æ®µï¼Œå­˜å‚¨éç»“æ„åŒ–æ•°æ®
- ç¤¾äº¤å…³ç³»é‡‡ç”¨åŒå‘ç»Ÿè®¡ï¼Œå…³æ³¨/å–å…³ä¼šåŒæ—¶æ›´æ–°ä¸¤ä¸ªç”¨æˆ·çš„ç»Ÿè®¡æ•°æ®
- çº¿ä¸‹æŠ€èƒ½æ”¯æŒç©ºé—´æŸ¥è¯¢ï¼ˆåŸºäºç»çº¬åº¦æŸ¥æ‰¾é™„è¿‘æœåŠ¡ï¼‰
- é™æ—¶ä¸“äº«æŸ¥è¯¢éœ€è¦ç”¨æˆ·æœ‰ä¸Šæ¶çš„æŠ€èƒ½ï¼ˆskills.is_online = 1ï¼‰
- æ‰€æœ‰æ¥å£è¿”å›ç»Ÿä¸€æ ¼å¼ `R<T>` (code, message, data)

## ğŸ§ª é›†æˆæµ‹è¯•
```bash
# é™æ—¶ä¸“äº«åŠŸèƒ½æµ‹è¯•ï¼ˆéœ€è¦å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®ï¼‰
# æµ‹è¯•æ–‡ä»¶: xypai-aggregation/xypai-app-bff/src/test/java/org/dromara/appbff/pages/Page05_LimitedTimeTest.java
# è¯¥æµ‹è¯•ä¼šé€šè¿‡ API è‡ªåŠ¨åˆ›å»ºæµ‹è¯•ç”¨æˆ·å’ŒæŠ€èƒ½

mvn test -Dtest=Page05_LimitedTimeTest
```
