# XyPai-Payment æ”¯ä»˜æœåŠ¡å¿«é€Ÿç†è§£

## ğŸ“Œ æ ¸å¿ƒå®šä½
å‘å¨±æ‹æ”¯ä»˜æœåŠ¡ï¼ŒåŸºäº Spring Cloud å¾®æœåŠ¡æ¶æ„ã€‚

**æœ¬æ¨¡å—èŒè´£**ï¼šæä¾›æ”¯ä»˜å¤„ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä½™é¢æ”¯ä»˜ã€æ”¯ä»˜å®/å¾®ä¿¡ç¬¬ä¸‰æ–¹æ”¯ä»˜ã€æ”¯ä»˜å¯†ç éªŒè¯ã€ä½™é¢ç®¡ç†ã€äº¤æ˜“æµæ°´è®°å½•ï¼Œä½œä¸º Dubbo RPC Provider ä¸ºè®¢å•æœåŠ¡æä¾›æ”¯ä»˜èƒ½åŠ›ï¼Œç›´æ¥è¿æ¥ `xypai_payment` æ•°æ®åº“ã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½
- **æ”¯ä»˜å¤„ç†**ï¼šä½™é¢æ”¯ä»˜ + æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜ + æ”¯ä»˜å¯†ç éªŒè¯
- **ä½™é¢ç®¡ç†**ï¼šå……å€¼ã€æç°ã€ä½™é¢æŸ¥è¯¢ã€å†»ç»“/è§£å†»
- **æ”¯ä»˜æµæ°´**ï¼šäº¤æ˜“è®°å½•æŸ¥è¯¢ + è´¦å•æ˜ç»†
- **é€€æ¬¾å¤„ç†**ï¼šè®¢å•é€€æ¬¾ + é€€æ¬¾åˆ°åŸæ”¯ä»˜æ–¹å¼
- **æ”¯ä»˜å›è°ƒ**ï¼šå¤„ç†æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜å›è°ƒ

## ğŸ—ï¸ æŠ€æœ¯æ ˆ
```
Spring Boot 3.x + MyBatis Plus + Dubbo RPC + Nacos + Seata
MySQL (xypai_payment æ•°æ®åº“ï¼Œ3 å¼ è¡¨) + Redis (æ”¯ä»˜é˜²é‡ + å¯†ç é”™è¯¯è®¡æ•°)
```

## ğŸ“ æ ¸å¿ƒç›®å½•ç»“æ„
```
xypai-payment/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ PaymentController.java         # æ”¯ä»˜ REST API
â”‚   â””â”€â”€ feign/
â”‚       â””â”€â”€ RemotePaymentServiceImpl.java  # Dubbo RPC Provider
â”œâ”€â”€ service/impl/
â”‚   â”œâ”€â”€ PaymentServiceImpl.java        # æ”¯ä»˜æœåŠ¡ï¼ˆç¬¬ä¸‰æ–¹æ”¯ä»˜é›†æˆï¼‰
â”‚   â””â”€â”€ AccountServiceImpl.java        # è´¦æˆ·æœåŠ¡ï¼ˆä½™é¢ç®¡ç†ï¼‰
â”œâ”€â”€ mapper/
â”‚   â”œâ”€â”€ PaymentMapper.java             # æ”¯ä»˜è®°å½•æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ AccountMapper.java             # è´¦æˆ·æ•°æ®è®¿é—®
â”‚   â””â”€â”€ TransactionMapper.java         # äº¤æ˜“æµæ°´æ•°æ®è®¿é—®
â””â”€â”€ domain/
    â”œâ”€â”€ entity/
    â”‚   â”œâ”€â”€ Payment.java               # æ”¯ä»˜è®°å½•å®ä½“
    â”‚   â”œâ”€â”€ Account.java               # è´¦æˆ·å®ä½“
    â”‚   â””â”€â”€ Transaction.java           # äº¤æ˜“æµæ°´å®ä½“
    â”œâ”€â”€ dto/
    â”‚   â”œâ”€â”€ PaymentCreateDTO.java      # åˆ›å»ºæ”¯ä»˜ DTO
    â”‚   â””â”€â”€ PaymentCallbackDTO.java    # æ”¯ä»˜å›è°ƒ DTO
    â””â”€â”€ vo/
        â”œâ”€â”€ PaymentVO.java             # æ”¯ä»˜ VO
        â””â”€â”€ AccountVO.java             # è´¦æˆ·ä½™é¢ VO
```

## ğŸ”‘ æ ¸å¿ƒæ¥å£

### æ”¯ä»˜å¤„ç†
| æ¥å£ | è¯´æ˜ | ç‰¹æ®Šå­—æ®µ |
|------|------|----------|
| `POST /payment/create` | åˆ›å»ºæ”¯ä»˜å• | æ”¯ä»˜æ–¹å¼ï¼ˆbalance/alipay/wechatï¼‰ |
| `POST /payment/pay/:paymentNo` | æ‰§è¡Œæ”¯ä»˜ | ä½™é¢æ”¯ä»˜éœ€éªŒè¯æ”¯ä»˜å¯†ç  |
| `POST /payment/callback/alipay` | æ”¯ä»˜å®å›è°ƒ | å¼‚æ­¥é€šçŸ¥å¤„ç† |
| `POST /payment/callback/wechat` | å¾®ä¿¡å›è°ƒ | å¼‚æ­¥é€šçŸ¥å¤„ç† |

### ä½™é¢ç®¡ç†
| æ¥å£ | è¯´æ˜ | ç‰¹æ®Šå­—æ®µ |
|------|------|----------|
| `GET /payment/account/balance` | æŸ¥è¯¢ä½™é¢ | å¯ç”¨ä½™é¢ + å†»ç»“ä½™é¢ |
| `POST /payment/account/recharge` | å……å€¼ | é‡‘é¢ + æ”¯ä»˜æ–¹å¼ |
| `POST /payment/account/withdraw` | æç° | é‡‘é¢ + æç°è´¦æˆ· |
| `POST /payment/verify-password` | éªŒè¯æ”¯ä»˜å¯†ç  | 3 æ¬¡é”™è¯¯é”å®š 30 åˆ†é’Ÿ |

### é€€æ¬¾å¤„ç†
| æ¥å£ | è¯´æ˜ | ç‰¹æ®Šå­—æ®µ |
|------|------|----------|
| `POST /payment/refund/:paymentNo` | ç”³è¯·é€€æ¬¾ | é€€æ¬¾é‡‘é¢ + é€€æ¬¾åŸå›  |
| `GET /payment/refund/status/:refundNo` | é€€æ¬¾çŠ¶æ€æŸ¥è¯¢ | - |

### äº¤æ˜“æµæ°´
| æ¥å£ | è¯´æ˜ | ç‰¹æ®Šå­—æ®µ |
|------|------|----------|
| `GET /payment/transaction/list` | äº¤æ˜“è®°å½• | åˆ†é¡µ + ç±»å‹ç­›é€‰ï¼ˆæ”¶å…¥/æ”¯å‡ºï¼‰ |
| `GET /payment/transaction/:id` | äº¤æ˜“è¯¦æƒ… | å®Œæ•´äº¤æ˜“ä¿¡æ¯ |

## ğŸ’¾ æ•°æ®åº“ï¼šxypai_paymentï¼ˆ3 å¼ è¡¨ï¼‰
```sql
-- æ”¯ä»˜è®°å½•è¡¨
payment                # æ”¯ä»˜è®°å½•ä¸»è¡¨
  - id                # æ”¯ä»˜ ID
  - payment_no        # æ”¯ä»˜å•å·ï¼ˆå”¯ä¸€ï¼‰
  - order_no          # è®¢å•ç¼–å·
  - user_id           # ç”¨æˆ· ID
  - amount            # æ”¯ä»˜é‡‘é¢
  - payment_method    # æ”¯ä»˜æ–¹å¼ï¼ˆbalance/alipay/wechatï¼‰
  - status            # æ”¯ä»˜çŠ¶æ€ï¼ˆpending/success/failed/refundedï¼‰
  - paid_at           # æ”¯ä»˜æ—¶é—´
  - third_party_no    # ç¬¬ä¸‰æ–¹æ”¯ä»˜æµæ°´å·
  - callback_data     # å›è°ƒåŸå§‹æ•°æ®ï¼ˆJSONï¼‰
  - refund_amount     # é€€æ¬¾é‡‘é¢
  - refunded_at       # é€€æ¬¾æ—¶é—´
  - version           # ä¹è§‚é”ç‰ˆæœ¬å·

-- è´¦æˆ·è¡¨
account                # ç”¨æˆ·è´¦æˆ·è¡¨
  - id                # è´¦æˆ· ID
  - user_id           # ç”¨æˆ· IDï¼ˆå”¯ä¸€ï¼‰
  - balance           # å¯ç”¨ä½™é¢
  - frozen_balance    # å†»ç»“ä½™é¢
  - total_income      # ç´¯è®¡æ”¶å…¥
  - total_expense     # ç´¯è®¡æ”¯å‡º
  - payment_password  # æ”¯ä»˜å¯†ç ï¼ˆBCryptï¼‰
  - password_error_count  # å¯†ç é”™è¯¯æ¬¡æ•°
  - password_locked_until # å¯†ç é”å®šæˆªæ­¢æ—¶é—´
  - version           # ä¹è§‚é”ç‰ˆæœ¬å·

-- äº¤æ˜“æµæ°´è¡¨
transaction            # äº¤æ˜“æµæ°´è¡¨
  - id                # æµæ°´ ID
  - transaction_no    # æµæ°´å·ï¼ˆå”¯ä¸€ï¼‰
  - user_id           # ç”¨æˆ· ID
  - type              # äº¤æ˜“ç±»å‹ï¼ˆrecharge/payment/refund/withdrawï¼‰
  - amount            # äº¤æ˜“é‡‘é¢
  - balance_before    # äº¤æ˜“å‰ä½™é¢
  - balance_after     # äº¤æ˜“åä½™é¢
  - related_no        # å…³è”å•å·ï¼ˆè®¢å•å·/æ”¯ä»˜å•å·ï¼‰
  - remark            # å¤‡æ³¨
  - create_time       # äº¤æ˜“æ—¶é—´
```

## ğŸ›ï¸ å¾®æœåŠ¡æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ xypai-order     â”‚  â† è®¢å•æœåŠ¡ï¼ˆå‘èµ·æ”¯ä»˜ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Dubbo RPC è°ƒç”¨
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ xypai-payment   â”‚  â† æœ¬æ¨¡å—ï¼ˆæ”¯ä»˜æœåŠ¡ï¼‰
â”‚ (æ”¯ä»˜å¤„ç†)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ MyBatis Plus
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ xypai_payment   â”‚  â† MySQL æ•°æ®åº“ï¼ˆ3 å¼ è¡¨ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â†“ ç¬¬ä¸‰æ–¹æ”¯ä»˜ SDK
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ”¯ä»˜å® / å¾®ä¿¡æ”¯ä»˜  â”‚  â† ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â†“ Seataï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å• + æ”¯ä»˜ + è´¦æˆ·  â”‚  â† ä¿è¯æ•°æ®ä¸€è‡´æ€§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”¥ æŠ€æœ¯äº®ç‚¹
1. **æ”¯ä»˜å¯†ç ä¿æŠ¤**ï¼šBCrypt åŠ å¯† + é”™è¯¯ 3 æ¬¡é”å®š 30 åˆ†é’Ÿï¼ˆRedis è®¡æ•°ï¼‰
2. **æ”¯ä»˜é˜²é‡**ï¼šRedis åˆ†å¸ƒå¼é” + æ•°æ®åº“å”¯ä¸€ç´¢å¼•ï¼Œé˜²æ­¢é‡å¤æ”¯ä»˜
3. **ä½™é¢å†»ç»“æœºåˆ¶**ï¼šè®¢å•åˆ›å»ºæ—¶å†»ç»“ä½™é¢ï¼Œæ”¯ä»˜æˆåŠŸåæ‰£é™¤ï¼Œå–æ¶ˆè®¢å•è§£å†»
4. **è´¦æˆ·ä½™é¢ä¸€è‡´æ€§**ï¼šä½¿ç”¨ä¹è§‚é”ï¼ˆversion å­—æ®µï¼‰+ Seata åˆ†å¸ƒå¼äº‹åŠ¡ä¿è¯
5. **æ”¯ä»˜å›è°ƒå¹‚ç­‰æ€§**ï¼šå›è°ƒæ•°æ®å­˜å‚¨ + æ”¯ä»˜çŠ¶æ€é˜²é‡å¤æ›´æ–°
6. **äº¤æ˜“æµæ°´å®Œæ•´æ€§**ï¼šæ¯ç¬”ä½™é¢å˜åŠ¨éƒ½è®°å½•æµæ°´ï¼ŒåŒ…å«äº¤æ˜“å‰åä½™é¢

## ğŸ“¡ RPC æ¥å£ï¼ˆä¾›å…¶ä»–æœåŠ¡è°ƒç”¨ï¼‰

### RemotePaymentService - æ”¯ä»˜æœåŠ¡ RPC
| æ–¹æ³• | è¯´æ˜ | è°ƒç”¨æ–¹ |
|------|------|--------|
| `getUserBalance(Long userId)` | è·å–ç”¨æˆ·å¯ç”¨ä½™é¢ | xypai-app-bff |
| `hasPaymentPassword(Long userId)` | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¾ç½®æ”¯ä»˜å¯†ç  | xypai-app-bff |
| `verifyPaymentPassword(Long userId, String password)` | éªŒè¯æ”¯ä»˜å¯†ç  (å«é”™è¯¯è®¡æ•°/é”å®š) | xypai-app-bff |
| `deductBalance(Long userId, BigDecimal amount, String orderNo, String remark)` | æ‰£å‡ä½™é¢ (åˆ›å»ºäº¤æ˜“æµæ°´) | xypai-order |
| `refundBalance(Long userId, BigDecimal amount, String orderNo)` | é€€æ¬¾åˆ°ä½™é¢ | xypai-order |

## ğŸ“¦ ä¾èµ–å…³ç³»
```
xypai-app-bff (BFF æœåŠ¡)
  â†“ Dubbo RPC (è®¢å•ç¡®è®¤æ—¶è°ƒç”¨)
xypai-order (è®¢å•æœåŠ¡)
  â†“ Dubbo RPC (åˆ›å»ºè®¢å•æ—¶è°ƒç”¨)
xypai-payment (æœ¬æ¨¡å—ï¼Œæ”¯ä»˜æœåŠ¡)
  â†“ MyBatis Plus
xypai_payment æ•°æ®åº“ (3 å¼ è¡¨)
  â†“ SDK è°ƒç”¨
ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨
```bash
# 1. ç¡®ä¿ä¾èµ–æœåŠ¡å·²å¯åŠ¨
#    - Nacosï¼ˆæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼‰
#    - MySQLï¼ˆxypai_payment æ•°æ®åº“ï¼‰
#    - Redisï¼ˆæ”¯ä»˜é˜²é‡ + å¯†ç é”å®šï¼‰
#    - Seataï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡åè°ƒå™¨ï¼‰

# 2. é…ç½®ç¬¬ä¸‰æ–¹æ”¯ä»˜
#    - æ”¯ä»˜å®ï¼šé…ç½® app_idã€private_keyã€public_key
#    - å¾®ä¿¡æ”¯ä»˜ï¼šé…ç½® mch_idã€api_keyã€cert_path

# 3. å¯åŠ¨æœ¬æœåŠ¡
cd xypai-payment
mvn clean package -DskipTests
java -jar target/xypai-payment.jar

# é»˜è®¤ç«¯å£ï¼š9406
# Swagger UI: http://localhost:9406/doc.html
```

## ğŸ“Œ æ³¨æ„äº‹é¡¹
- **æ•°æ®åº“åˆå§‹åŒ–**ï¼šé¦–æ¬¡å¯åŠ¨å‰éœ€åˆ›å»º `xypai_payment` æ•°æ®åº“å’Œ 3 å¼ è¡¨
- **æ”¯ä»˜å¯†ç è®¾ç½®**ï¼šç”¨æˆ·é¦–æ¬¡ä½¿ç”¨ä½™é¢æ”¯ä»˜å‰éœ€è®¾ç½® 6 ä½æ”¯ä»˜å¯†ç 
- **æ”¯ä»˜å¯†ç ä¿æŠ¤**ï¼šé”™è¯¯ 3 æ¬¡é”å®š 30 åˆ†é’Ÿï¼ŒRedis è®°å½•é”™è¯¯æ¬¡æ•°
- **ä½™é¢å†»ç»“é€»è¾‘**ï¼š
  - è®¢å•åˆ›å»ºï¼šå†»ç»“è®¢å•é‡‘é¢ï¼ˆavailable_balance - amount â†’ frozen_balance + amountï¼‰
  - æ”¯ä»˜æˆåŠŸï¼šæ‰£é™¤å†»ç»“é‡‘é¢ï¼ˆfrozen_balance - amountï¼‰
  - è®¢å•å–æ¶ˆï¼šè§£å†»é‡‘é¢ï¼ˆfrozen_balance - amount â†’ available_balance + amountï¼‰
- **æ”¯ä»˜å›è°ƒå¤„ç†**ï¼š
  - éªŒè¯ç­¾åï¼šé˜²æ­¢ä¼ªé€ å›è°ƒ
  - å¹‚ç­‰æ€§ï¼šåŒä¸€æ”¯ä»˜å•åªå¤„ç†ä¸€æ¬¡å›è°ƒ
  - å¼‚æ­¥æ›´æ–°ï¼šå›è°ƒæˆåŠŸåå¼‚æ­¥æ›´æ–°è®¢å•çŠ¶æ€
- **é€€æ¬¾é™åˆ¶**ï¼šä»…å·²æ”¯ä»˜è®¢å•å¯é€€æ¬¾ï¼Œé€€æ¬¾é‡‘é¢ä¸è¶…è¿‡å®ä»˜é‡‘é¢
- **æ”¯ä»˜æ–¹å¼**ï¼š
  - `balance`ï¼šä½™é¢æ”¯ä»˜ï¼ˆéœ€æ”¯ä»˜å¯†ç ï¼‰
  - `alipay`ï¼šæ”¯ä»˜å®ï¼ˆè·³è½¬æ”¯ä»˜å® App/ç½‘é¡µï¼‰
  - `wechat`ï¼šå¾®ä¿¡æ”¯ä»˜ï¼ˆè°ƒèµ·å¾®ä¿¡æ”¯ä»˜ï¼‰
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šæ”¯ä»˜æ¶‰åŠæ”¯ä»˜è¡¨ã€è´¦æˆ·è¡¨ã€è®¢å•è¡¨ï¼Œä½¿ç”¨ Seata AT æ¨¡å¼ä¿è¯å¼ºä¸€è‡´æ€§
- æ‰€æœ‰æ¥å£è¿”å›ç»Ÿä¸€æ ¼å¼ `R<T>` (code, message, data)

---

**æœ€åæ›´æ–°**: 2025-12-04
**çŠ¶æ€**: âœ… å·²å®Œæˆ RPC æ¥å£æ‰©å±•ï¼Œæ”¯æŒè®¢å•ç¡®è®¤æ”¯ä»˜æµç¨‹
