# XyPai-Chat èŠå¤©æœåŠ¡å¿«é€Ÿç†è§£

## ğŸ“Œ æ ¸å¿ƒå®šä½
å‘å¨±æ‹èŠå¤©æœåŠ¡ï¼ŒåŸºäº Spring Cloud å¾®æœåŠ¡æ¶æ„ã€‚

**æœ¬æ¨¡å—èŒè´£**ï¼šæä¾›å³æ—¶é€šè®¯åŠŸèƒ½ï¼Œæ”¯æŒç§èŠã€å¤šç§æ¶ˆæ¯æ ¼å¼ï¼ˆæ–‡å­—/å›¾ç‰‡/è¯­éŸ³/è§†é¢‘ï¼‰ï¼ŒåŸºäº WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼Œç›´æ¥è¿æ¥ `xypai_chat` æ•°æ®åº“ï¼Œä½œä¸ºå¹³å°ç¤¾äº¤çš„æ ¸å¿ƒé€šè®¯åŸºç¡€è®¾æ–½ã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½
- **ç§èŠæ¶ˆæ¯**ï¼šä¸€å¯¹ä¸€èŠå¤© + ä¼šè¯ç®¡ç†
- **å¤šæ ¼å¼æ¶ˆæ¯**ï¼šæ–‡å­—ã€å›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘æ¶ˆæ¯
- **å®æ—¶é€šè®¯**ï¼šWebSocket æ¨é€ + åœ¨çº¿çŠ¶æ€è¿½è¸ª
- **æ¶ˆæ¯ç®¡ç†**ï¼šå·²è¯»å›æ‰§ + æ¶ˆæ¯æ’¤å›ï¼ˆ2åˆ†é’Ÿå†…ï¼‰ + åˆ é™¤
- **ä¼šè¯åˆ—è¡¨**ï¼šæœªè¯»ç»Ÿè®¡ + æœ€åæ¶ˆæ¯é¢„è§ˆ + æ—¶é—´æ’åº

## ğŸ—ï¸ æŠ€æœ¯æ ˆ
```
Spring Boot 3.x + MyBatis Plus + WebSocket + Nacos
MySQL (xypai_chat æ•°æ®åº“ï¼Œ2 å¼ è¡¨) + Redis (åœ¨çº¿çŠ¶æ€ + ç¦»çº¿æ¶ˆæ¯)
```

## ğŸ“ æ ¸å¿ƒç›®å½•ç»“æ„
```
xypai-chat/
â”œâ”€â”€ controller/app/
â”‚   â””â”€â”€ MessageController.java         # æ¶ˆæ¯ REST APIï¼ˆå‘é€/æŸ¥è¯¢/æ’¤å›ï¼‰
â”œâ”€â”€ websocket/
â”‚   â””â”€â”€ MessageWebSocketHandler.java   # WebSocket æ¶ˆæ¯æ¨é€
â”œâ”€â”€ service/impl/
â”‚   â”œâ”€â”€ MessageServiceImpl.java        # æ¶ˆæ¯æœåŠ¡ï¼ˆCRUD + æ¨é€ï¼‰
â”‚   â””â”€â”€ FileUploadServiceImpl.java     # æ–‡ä»¶ä¸Šä¼ ï¼ˆå›¾ç‰‡/è¯­éŸ³/è§†é¢‘ï¼‰
â”œâ”€â”€ mapper/
â”‚   â”œâ”€â”€ ConversationMapper.java        # ä¼šè¯æ•°æ®è®¿é—®
â”‚   â””â”€â”€ MessageMapper.java             # æ¶ˆæ¯æ•°æ®è®¿é—®
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ Conversation.java          # ä¼šè¯å®ä½“
â”‚   â”‚   â””â”€â”€ Message.java               # æ¶ˆæ¯å®ä½“
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ MessageSendDTO.java        # å‘é€æ¶ˆæ¯ DTO
â”‚   â”‚   â””â”€â”€ ChatHistoryQueryDTO.java   # èŠå¤©è®°å½•æŸ¥è¯¢ DTO
â”‚   â””â”€â”€ vo/
â”‚       â”œâ”€â”€ ConversationVO.java        # ä¼šè¯åˆ—è¡¨ VO
â”‚       â”œâ”€â”€ MessageVO.java             # æ¶ˆæ¯ VO
â”‚       â””â”€â”€ UnreadCountVO.java         # æœªè¯»ç»Ÿè®¡ VO
â””â”€â”€ dubbo/
    â””â”€â”€ RemoteChatServiceImpl.java     # RPC Providerï¼ˆå¯é€‰ï¼‰
```

## ğŸ”‘ æ ¸å¿ƒæ¥å£

### æ¶ˆæ¯å‘é€
| æ¥å£ | è¯´æ˜ | ç‰¹æ®Šå­—æ®µ |
|------|------|----------|
| `POST /chat/message/send` | å‘é€æ¶ˆæ¯ | æ¶ˆæ¯ç±»å‹ï¼ˆtext/image/voice/videoï¼‰ |
| `POST /chat/message/recall/:id` | æ’¤å›æ¶ˆæ¯ | 2 åˆ†é’Ÿå†…å¯æ’¤å› |
| `DELETE /chat/message/:id` | åˆ é™¤æ¶ˆæ¯ | è½¯åˆ é™¤ |

### æ¶ˆæ¯æŸ¥è¯¢
| æ¥å£ | è¯´æ˜ | ç‰¹æ®Šå­—æ®µ |
|------|------|----------|
| `GET /chat/conversation/list` | ä¼šè¯åˆ—è¡¨ | æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ’åº |
| `GET /chat/message/history/:userId` | èŠå¤©è®°å½• | åˆ†é¡µåŠ è½½ + æ—¶é—´å€’åº |
| `GET /chat/message/unread` | æœªè¯»ç»Ÿè®¡ | æ€»æœªè¯»æ•° + å„ä¼šè¯æœªè¯»æ•° |
| `PUT /chat/message/read/:conversationId` | æ ‡è®°å·²è¯» | æ‰¹é‡æ›´æ–° |

### WebSocket
| è¿æ¥ | è¯´æ˜ | ç‰¹æ®Šå­—æ®µ |
|------|------|----------|
| `ws://host:9404/ws/chat` | WebSocket è¿æ¥ | æºå¸¦ token è¿›è¡Œé‰´æƒ |
| å¿ƒè·³åŒ… | 30 ç§’å‘é€ä¸€æ¬¡ ping | ä¿æŒè¿æ¥æ´»è·ƒ |
| æ¶ˆæ¯æ¨é€ | å®æ—¶æ¨é€æ–°æ¶ˆæ¯ | JSON æ ¼å¼æ¶ˆæ¯ä½“ |

## ğŸ’¾ æ•°æ®åº“ï¼šxypai_chatï¼ˆ2 å¼ è¡¨ï¼‰
```sql
-- ä¼šè¯è¡¨
conversation           # ä¼šè¯è¡¨ï¼ˆç”¨æˆ·é—´çš„èŠå¤©ä¼šè¯ï¼‰
  - id                # ä¼šè¯ ID
  - user_id           # ç”¨æˆ· ID
  - other_user_id     # å¯¹æ–¹ç”¨æˆ· ID
  - last_message      # æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹
  - last_message_time # æœ€åæ¶ˆæ¯æ—¶é—´
  - unread_count      # æœªè¯»æ¶ˆæ¯æ•°
  - deleted           # è½¯åˆ é™¤æ ‡è®°
  - version           # ä¹è§‚é”ç‰ˆæœ¬å·

-- æ¶ˆæ¯è¡¨
message                # æ¶ˆæ¯è¡¨ï¼ˆæ‰€æœ‰èŠå¤©æ¶ˆæ¯ï¼‰
  - id                # æ¶ˆæ¯ ID
  - conversation_id   # æ‰€å±ä¼šè¯ ID
  - sender_id         # å‘é€è€… ID
  - receiver_id       # æ¥æ”¶è€… ID
  - message_type      # æ¶ˆæ¯ç±»å‹ï¼ˆtext/image/voice/videoï¼‰
  - content           # æ–‡å­—æ¶ˆæ¯å†…å®¹
  - media_url         # åª’ä½“æ–‡ä»¶ URL
  - thumbnail_url     # ç¼©ç•¥å›¾ URLï¼ˆè§†é¢‘ï¼‰
  - duration          # æ—¶é•¿ï¼ˆè¯­éŸ³/è§†é¢‘ï¼Œå•ä½ç§’ï¼‰
  - status            # çŠ¶æ€ï¼ˆ0=å‘é€ä¸­, 1=å·²é€è¾¾, 2=å·²è¯», 3=å¤±è´¥ï¼‰
  - is_recalled       # æ˜¯å¦å·²æ’¤å›
  - recalled_at       # æ’¤å›æ—¶é—´
  - deleted           # è½¯åˆ é™¤æ ‡è®°
  - create_time       # å‘é€æ—¶é—´
```

## ğŸ›ï¸ å¾®æœåŠ¡æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App å®¢æˆ·ç«¯      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ WebSocket (å®æ—¶æ¨é€)
         â”‚ REST API (æŸ¥è¯¢/å‘é€)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  xypai-chat     â”‚  â† æœ¬æ¨¡å—ï¼ˆèŠå¤©æœåŠ¡ï¼‰
â”‚  (å³æ—¶é€šè®¯)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ MyBatis Plus
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ xypai_chat      â”‚  â† MySQL æ•°æ®åº“ï¼ˆ2 å¼ è¡¨ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â†“ Redis
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ¨çº¿çŠ¶æ€ + ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â†“ OSS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åª’ä½“æ–‡ä»¶å­˜å‚¨     â”‚  â† å›¾ç‰‡/è¯­éŸ³/è§†é¢‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”¥ æŠ€æœ¯äº®ç‚¹
1. **WebSocket å®æ—¶æ¨é€**ï¼šåŸºäº Spring WebSocketï¼Œæ”¯æŒå•ç‚¹ç™»å½•å’Œæ¶ˆæ¯å®æ—¶æ¨é€
2. **æ¶ˆæ¯æ’¤å›æœºåˆ¶**ï¼š2 åˆ†é’Ÿå†…å¯æ’¤å›æ¶ˆæ¯ï¼Œè¶…æ—¶è‡ªåŠ¨å¤±æ•ˆï¼Œé˜²æ­¢æ»¥ç”¨
3. **å·²è¯»å›æ‰§**ï¼šæ¶ˆæ¯çŠ¶æ€è¿½è¸ªï¼ˆå‘é€ä¸­ â†’ å·²é€è¾¾ â†’ å·²è¯»ï¼‰ï¼Œæ”¯æŒæ‰¹é‡å·²è¯»
4. **ä¼šè¯ä¼˜åŒ–**ï¼šRedis ç¼“å­˜ä¼šè¯åˆ—è¡¨å’Œæœªè¯»æ•°ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
5. **ç¦»çº¿æ¶ˆæ¯**ï¼šç”¨æˆ·ç¦»çº¿æ—¶æ¶ˆæ¯å­˜å…¥ Redis é˜Ÿåˆ—ï¼Œä¸Šçº¿åæ‰¹é‡æ¨é€

## ğŸ“¦ ä¾èµ–å…³ç³»
```
App å®¢æˆ·ç«¯
  â†“ WebSocket / REST API
xypai-chat (æœ¬æ¨¡å—ï¼ŒèŠå¤©æœåŠ¡)
  â†“ MyBatis Plus
xypai_chat æ•°æ®åº“ (2 å¼ è¡¨)
  â†“ Redis + OSS
åœ¨çº¿çŠ¶æ€ç¼“å­˜ + åª’ä½“æ–‡ä»¶å­˜å‚¨
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨
```bash
# 1. ç¡®ä¿ä¾èµ–æœåŠ¡å·²å¯åŠ¨
#    - Nacosï¼ˆæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼‰
#    - MySQLï¼ˆxypai_chat æ•°æ®åº“ï¼Œå¯¼å…¥ sql/xypai_chat.sqlï¼‰
#    - Redisï¼ˆåœ¨çº¿çŠ¶æ€ + ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
#    - OSSï¼ˆåª’ä½“æ–‡ä»¶å­˜å‚¨ï¼‰

# 2. å¯åŠ¨æœ¬æœåŠ¡
cd xypai-chat
mvn clean package -DskipTests
java -jar target/xypai-chat.jar

# é»˜è®¤ç«¯å£ï¼š9404
# Swagger UI: http://localhost:9404/doc.html
# WebSocket: ws://localhost:9404/ws/chat
```

## ğŸ“Œ æ³¨æ„äº‹é¡¹
- **æ•°æ®åº“åˆå§‹åŒ–**ï¼šé¦–æ¬¡å¯åŠ¨å‰éœ€å¯¼å…¥ `sql/xypai_chat.sql` åˆ›å»º 2 å¼ è¡¨
- **WebSocket é‰´æƒ**ï¼šè¿æ¥æ—¶éœ€åœ¨ URL æˆ– Header ä¸­æºå¸¦ Sa-Token è¿›è¡Œèº«ä»½éªŒè¯
- **æ¶ˆæ¯æ’¤å›é™åˆ¶**ï¼šä»…æ”¯æŒ 2 åˆ†é’Ÿå†…æ’¤å›ï¼Œè¶…æ—¶åæ— æ³•æ’¤å›
- **æ¶ˆæ¯æ ¼å¼**ï¼š
  - æ–‡å­—æ¶ˆæ¯ï¼šcontent å­—æ®µå­˜å‚¨å†…å®¹
  - å›¾ç‰‡/è¯­éŸ³/è§†é¢‘ï¼šmedia_url å­˜å‚¨ OSS URLï¼Œcontent ä¸ºç©º
  - è§†é¢‘æ¶ˆæ¯ï¼šé¢å¤–å­˜å‚¨ thumbnail_urlï¼ˆç¼©ç•¥å›¾ï¼‰å’Œ durationï¼ˆæ—¶é•¿ï¼‰
- **åœ¨çº¿çŠ¶æ€**ï¼šåŸºäº WebSocket è¿æ¥çŠ¶æ€ï¼Œæ–­å¼€è¿æ¥ 30 ç§’åæ ‡è®°ä¸ºç¦»çº¿
- **ä¼šè¯å»é‡**ï¼šuser_id å’Œ other_user_id ç»„åˆå”¯ä¸€ç´¢å¼•ï¼Œé˜²æ­¢é‡å¤ä¼šè¯
- **æœªè¯»ç»Ÿè®¡**ï¼šæ¥æ”¶æ¶ˆæ¯æ—¶ unread_count +1ï¼Œæ ‡è®°å·²è¯»æ—¶æ¸…é›¶
- æ‰€æœ‰æ¥å£è¿”å›ç»Ÿä¸€æ ¼å¼ `R<T>` (code, message, data)
