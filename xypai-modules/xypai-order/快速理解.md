# XyPai-Order 订单服务快速理解

## 📌 核心定位
向娱拍订单服务，基于 Spring Cloud 微服务架构。

**本模块职责**：提供订单管理功能，处理技能服务订单和活动订单，管理订单状态流转，通过 Dubbo RPC 调用支付服务完成支付，直接连接 `xypai_order` 数据库。

## 🎯 主要功能
- **订单创建**：技能服务订单 + 活动订单创建
- **订单查询**：我的订单列表 + 订单详情 + 状态筛选
- **订单状态流转**：待支付 → 待服务 → 进行中 → 待评价 → 已完成
- **订单取消**：未支付订单取消 + 自动取消（超时）
- **订单退款**：申请退款 + 退款审核 + 退款完成

## 🏗️ 技术栈
```
Spring Boot 3.x + MyBatis Plus + Dubbo RPC + Nacos + Seata
MySQL (xypai_order 数据库，1 张表) + Redis (订单缓存)
```

## 📁 核心目录结构
```
xypai-order/
├── controller/
│   ├── OrderController.java           # 订单 REST API
│   └── feign/
│       └── RemoteOrderServiceImpl.java  # Dubbo RPC Provider
├── service/impl/
│   └── OrderServiceImpl.java          # 订单服务（状态机）
├── mapper/
│   └── OrderMapper.java               # 订单数据访问
└── domain/
    ├── entity/
    │   └── Order.java                 # 订单实体
    ├── dto/
    │   ├── OrderCreateDTO.java        # 创建订单 DTO
    │   └── OrderQueryDTO.java         # 查询订单 DTO
    └── vo/
        ├── OrderVO.java               # 订单 VO
        └── OrderDetailVO.java         # 订单详情 VO
```

## 🔑 核心接口

### 订单创建
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /order/create` | 创建订单 | 订单类型（service/activity） |
| `POST /order/pay/:orderNo` | 支付订单 | 调用支付服务创建支付单 |

### 订单查询
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `GET /order/my` | 我的订单列表 | 状态筛选 + 分页 |
| `GET /order/:orderNo` | 订单详情 | 完整订单信息 |
| `GET /order/count` | 各状态订单数 | 待支付/待服务/进行中等 |

### 订单操作
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `PUT /order/cancel/:orderNo` | 取消订单 | 仅待支付状态可取消 |
| `PUT /order/confirm/:orderNo` | 确认完成 | 买家确认服务完成 |
| `POST /order/refund/:orderNo` | 申请退款 | 退款原因 + 凭证 |
| `PUT /order/evaluate/:orderNo` | 评价订单 | 星级 + 评价内容 |

## 💾 数据库：xypai_order（1 张表）
```sql
-- 订单表
order                  # 订单主表
  - id                # 订单 ID
  - order_no          # 订单编号（唯一）
  - user_id           # 下单用户 ID
  - provider_id       # 服务提供者 ID
  - service_id        # 服务 ID
  - order_type        # 订单类型（service/activity）
  - quantity          # 数量
  - unit_price        # 单价
  - subtotal          # 小计
  - discount_amount   # 优惠金额
  - total_amount      # 总金额
  - status            # 订单状态（10=待支付, 20=待服务, 30=进行中, 40=待评价, 50=已完成, 90=已取消, 91=已退款）
  - payment_status    # 支付状态（0=未支付, 1=已支付, 2=退款中, 3=已退款）
  - payment_method    # 支付方式（alipay/wechat/balance）
  - paid_at           # 支付时间
  - service_time      # 服务时间
  - cancel_reason     # 取消原因
  - refund_reason     # 退款原因
  - refund_amount     # 退款金额
  - remark            # 订单备注
  - create_time       # 创建时间
  - update_time       # 更新时间
  - deleted           # 软删除标记
  - version           # 乐观锁版本号
```

## 🏛️ 微服务架构
```
┌─────────────────┐
│  App 客户端      │
└────────┬────────┘
         │ REST API
         ↓
┌─────────────────┐
│  xypai-order    │  ← 本模块（订单服务）
│  (订单管理)      │
└────────┬────────┘
         │ Dubbo RPC 调用
         ↓
┌─────────────────┐
│ xypai-payment   │  ← 支付服务（创建支付单）
└─────────────────┘

xypai-order
  ↓ MyBatis Plus
┌─────────────────┐
│ xypai_order     │  ← MySQL 数据库（1 张表）
└─────────────────┘

  ↓ Seata（分布式事务）
┌─────────────────┐
│ 订单 + 支付 + 库存  │  ← 保证数据一致性
└─────────────────┘
```

## 🔥 技术亮点
1. **订单状态机**：严格的状态流转控制，防止非法状态变更
   ```
   待支付(10) → 待服务(20) → 进行中(30) → 待评价(40) → 已完成(50)
                ↓ 取消                       ↓ 退款
            已取消(90)                    已退款(91)
   ```
2. **Seata 分布式事务**：订单创建 + 支付 + 库存扣减保证强一致性
3. **订单超时取消**：未支付订单 30 分钟自动取消（定时任务 + Redis 延时队列）
4. **幂等性控制**：订单编号唯一索引 + Redis 防重复提交
5. **订单金额计算**：subtotal（小计）- discount_amount（优惠）= total_amount（总金额）

## 📡 RPC 接口（供其他服务调用）

### RemoteOrderService - 订单服务 RPC
| 方法 | 说明 | 调用方 |
|------|------|--------|
| `createOrder(CreateOrderRequest request)` | 创建订单并完成余额支付 | xypai-app-bff |
| `getOrderById(Long orderId)` | 根据 ID 获取订单 | xypai-app-bff |
| `getOrderByOrderNo(String orderNo)` | 根据订单号获取订单 | xypai-app-bff |

**CreateOrderRequest 参数**:
- userId: 下单用户ID
- serviceId: 技能服务ID
- providerId: 服务提供者ID
- quantity: 数量(场次)
- unitPrice: 单价
- totalAmount: 总金额(用于二次验证)
- paymentMethod: 支付方式(balance/alipay/wechat)
- remark: 备注

**CreateOrderResult 返回**:
- success: 是否成功
- orderNo: 订单编号
- orderId: 订单ID
- amount: 实付金额
- remainingBalance: 剩余余额
- paymentStatus: 支付状态
- errorCode/errorMessage: 失败信息

## 📦 依赖关系
```
xypai-app-bff (BFF 服务)
  ↓ Dubbo RPC (订单确认支付)
xypai-order (本模块，订单服务)
  ↓ Dubbo RPC (余额支付)
xypai-payment (支付服务，扣减余额)
  ↓
xypai_order 数据库 (1 张表)
```

## 🚀 快速启动
```bash
# 1. 确保依赖服务已启动
#    - Nacos（服务注册中心）
#    - MySQL（xypai_order 数据库）
#    - Redis（订单缓存 + 延时队列）
#    - Seata（分布式事务协调器）
#    - xypai-payment 服务（支付服务）

# 2. 启动本服务
cd xypai-order
mvn clean package -DskipTests
java -jar target/xypai-order.jar

# 默认端口：9405
# Swagger UI: http://localhost:9405/doc.html
```

## 📌 注意事项
- **数据库初始化**：首次启动前需创建 `xypai_order` 数据库和 `order` 表
- **订单状态流转**：状态变更需严格遵守状态机规则，不能跨状态跳转
- **订单编号生成**：格式为 `ORDER{yyyyMMddHHmmss}{6位随机数}`，全局唯一
- **订单超时取消**：未支付订单创建后 30 分钟自动取消，释放库存
- **退款流程**：用户申请 → 商家审核 → 调用支付服务退款 → 更新订单状态
- **分布式事务**：订单创建涉及订单表、支付表、库存表，使用 Seata AT 模式保证一致性
- **订单类型**：
  - `service`：技能服务订单（如游戏陪玩）
  - `activity`：活动订单（如组局活动）
- 所有接口返回统一格式 `R<T>` (code, message, data)

---

**最后更新**: 2025-12-04
**状态**: ✅ 已完成 RPC 接口扩展 (createOrder)，支持订单确认支付流程
