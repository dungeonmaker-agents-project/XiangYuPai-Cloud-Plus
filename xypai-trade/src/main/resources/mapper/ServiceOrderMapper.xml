<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xypai.trade.mapper.ServiceOrderMapper">

    <!-- 查询用户购买的订单 -->
    <select id="selectBuyerOrders" resultType="com.xypai.trade.domain.entity.ServiceOrder">
        SELECT * FROM service_order
        WHERE buyer_id = #{buyerId}
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询用户出售的订单 -->
    <select id="selectSellerOrders" resultType="com.xypai.trade.domain.entity.ServiceOrder">
        SELECT * FROM service_order
        WHERE seller_id = #{sellerId}
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 根据订单编号查询 -->
    <select id="selectByOrderNo" resultType="com.xypai.trade.domain.entity.ServiceOrder">
        SELECT * FROM service_order
        WHERE order_no = #{orderNo}
        LIMIT 1
    </select>

    <!-- 查询用户的订单统计 -->
    <select id="selectUserOrderStats" resultType="map">
        SELECT
            COUNT(*) AS total_orders,
            SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) AS pending_count,
            SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS paid_count,
            SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS in_service_count,
            SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS completed_count,
            SUM(CASE WHEN status = 4 THEN 1 ELSE 0 END) AS cancelled_count,
            SUM(CASE WHEN status = 5 THEN 1 ELSE 0 END) AS refunded_count,
            SUM(CASE WHEN status = 3 THEN actual_amount ELSE 0 END) / 100.0 AS total_amount_yuan
        FROM service_order
        WHERE
        <choose>
            <when test="role == 'buyer'">
                buyer_id = #{userId}
            </when>
            <when test="role == 'seller'">
                seller_id = #{userId}
            </when>
        </choose>
    </select>

    <!-- 查询内容的订单统计 -->
    <select id="selectContentOrderStats" resultType="map">
        SELECT
            COUNT(*) AS total_orders,
            SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS completed_orders,
            SUM(CASE WHEN status = 3 THEN actual_amount ELSE 0 END) / 100.0 AS total_revenue_yuan,
            AVG(CASE WHEN status = 3 THEN actual_amount ELSE NULL END) / 100.0 AS avg_order_amount_yuan
        FROM service_order
        WHERE content_id = #{contentId}
    </select>

    <!-- 查询即将超时的订单 -->
    <select id="selectTimeoutOrders" resultType="com.xypai.trade.domain.entity.ServiceOrder">
        SELECT * FROM service_order
        WHERE status = #{status}
          AND created_at <![CDATA[<]]> DATE_SUB(NOW(), INTERVAL #{timeoutHours} HOUR)
        ORDER BY created_at ASC
        LIMIT 100
    </select>

    <!-- 批量更新订单状态 -->
    <update id="batchUpdateStatus">
        UPDATE service_order
        SET status = #{newStatus},
            updated_at = #{updateTime}
        WHERE id IN
        <foreach collection="orderIds" item="orderId" open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </update>

    <!-- 查询销售排行榜 -->
    <select id="selectSalesRanking" resultType="map">
        SELECT
            seller_id AS user_id,
            COUNT(*) AS order_count,
            SUM(actual_amount) / 100.0 AS total_revenue_yuan,
            AVG(actual_amount) / 100.0 AS avg_order_amount_yuan
        FROM service_order
        WHERE status = 3  /* 已完成 */
        <if test="startDate != null">
            AND completed_at >= #{startDate}
        </if>
        <if test="endDate != null">
            AND completed_at <![CDATA[<=]]> #{endDate}
        </if>
        GROUP BY seller_id
        ORDER BY total_revenue_yuan DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询热门技能内容 -->
    <select id="selectPopularSkills" resultType="map">
        SELECT
            content_id,
            COUNT(*) AS order_count,
            SUM(actual_amount) / 100.0 AS total_revenue_yuan,
            AVG(actual_amount) / 100.0 AS avg_price_yuan
        FROM service_order
        WHERE status = 3  /* 已完成 */
        <if test="startDate != null">
            AND completed_at >= #{startDate}
        </if>
        <if test="endDate != null">
            AND completed_at <![CDATA[<=]]> #{endDate}
        </if>
        GROUP BY content_id
        ORDER BY order_count DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询收入统计 -->
    <select id="selectIncomeStats" resultType="map">
        SELECT
            COUNT(*) AS total_orders,
            SUM(actual_amount - platform_fee) / 100.0 AS total_income_yuan,
            AVG(actual_amount - platform_fee) / 100.0 AS avg_income_yuan,
            SUM(platform_fee) / 100.0 AS total_platform_fee_yuan
        FROM service_order
        WHERE seller_id = #{sellerId}
          AND status = 3  /* 已完成 */
        <if test="startDate != null">
            AND completed_at >= #{startDate}
        </if>
        <if test="endDate != null">
            AND completed_at <![CDATA[<=]]> #{endDate}
        </if>
    </select>

    <!-- 查询支出统计 -->
    <select id="selectExpenseStats" resultType="map">
        SELECT
            COUNT(*) AS total_orders,
            SUM(actual_amount) / 100.0 AS total_expense_yuan,
            AVG(actual_amount) / 100.0 AS avg_expense_yuan,
            SUM(discount_amount) / 100.0 AS total_discount_yuan
        FROM service_order
        WHERE buyer_id = #{buyerId}
          AND status IN (1, 2, 3)  /* 已付款/服务中/已完成 */
        <if test="startDate != null">
            AND payment_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND payment_time <![CDATA[<=]]> #{endDate}
        </if>
    </select>

    <!-- 根据状态和时间范围统计订单数量 -->
    <select id="countOrdersByStatusAndTime" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM service_order
        WHERE 1=1
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="startDate != null">
            AND created_at >= #{startDate}
        </if>
        <if test="endDate != null">
            AND created_at <![CDATA[<=]]> #{endDate}
        </if>
    </select>

    <!-- 查询平台交易统计 -->
    <select id="selectPlatformTradeStats" resultType="map">
        SELECT
            COUNT(*) AS total_orders,
            SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS completed_orders,
            SUM(CASE WHEN status = 4 THEN 1 ELSE 0 END) AS cancelled_orders,
            SUM(CASE WHEN status = 5 THEN 1 ELSE 0 END) AS refunded_orders,
            SUM(CASE WHEN status = 3 THEN actual_amount ELSE 0 END) / 100.0 AS total_revenue_yuan,
            SUM(CASE WHEN status = 3 THEN platform_fee ELSE 0 END) / 100.0 AS total_platform_fee_yuan,
            AVG(CASE WHEN status = 3 THEN actual_amount ELSE NULL END) / 100.0 AS avg_order_amount_yuan,
            ROUND(SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS completion_rate
        FROM service_order
        WHERE 1=1
        <if test="startDate != null">
            AND created_at >= #{startDate}
        </if>
        <if test="endDate != null">
            AND created_at <![CDATA[<=]]> #{endDate}
        </if>
    </select>

</mapper>

