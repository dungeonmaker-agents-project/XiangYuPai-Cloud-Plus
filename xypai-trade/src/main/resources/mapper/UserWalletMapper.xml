<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xypai.trade.mapper.UserWalletMapper">

    <!-- ==========================================
         ⭐ 乐观锁核心实现（version字段）
         每次UPDATE都必须检查version，失败则返回0
         ========================================== -->

    <!-- ⭐ 扣减余额（乐观锁）- 核心方法 -->
    <update id="deductBalance">
        UPDATE user_wallet
        SET balance = balance - #{amount},
            total_expense = total_expense + #{amount},
            version = version + 1,
            updated_at = NOW()
        WHERE user_id = #{userId}
          AND version = #{version}
          AND balance >= #{amount}  /* 双重校验：余额必须足够 */
    </update>

    <!-- ⭐ 充值余额（乐观锁） -->
    <update id="rechargeBalance">
        UPDATE user_wallet
        SET balance = balance + #{amount},
            total_income = total_income + #{amount},
            version = version + 1,
            updated_at = NOW()
        WHERE user_id = #{userId}
          AND version = #{version}
    </update>

    <!-- ⭐ 冻结金额（乐观锁） -->
    <update id="freezeBalance">
        UPDATE user_wallet
        SET balance = balance - #{amount},
            frozen = frozen + #{amount},
            version = version + 1,
            updated_at = NOW()
        WHERE user_id = #{userId}
          AND version = #{version}
          AND balance >= #{amount}  /* 可用余额必须足够 */
    </update>

    <!-- ⭐ 解冻金额（乐观锁） -->
    <update id="unfreezeBalance">
        UPDATE user_wallet
        SET frozen = frozen - #{amount},
            balance = balance + #{amount},
            version = version + 1,
            updated_at = NOW()
        WHERE user_id = #{userId}
          AND version = #{version}
          AND frozen >= #{amount}  /* 冻结金额必须足够 */
    </update>

    <!-- ⭐ 扣减冻结金额（支付成功时） -->
    <update id="deductFrozen">
        UPDATE user_wallet
        SET frozen = frozen - #{amount},
            total_expense = total_expense + #{amount},
            version = version + 1,
            updated_at = NOW()
        WHERE user_id = #{userId}
          AND version = #{version}
          AND frozen >= #{amount}  /* 冻结金额必须足够 */
    </update>

    <!-- ⭐ 增加收入（卖家收款） -->
    <update id="addIncome">
        UPDATE user_wallet
        SET balance = balance + #{amount},
            total_income = total_income + #{amount},
            version = version + 1,
            updated_at = NOW()
        WHERE user_id = #{userId}
          AND version = #{version}
    </update>

    <!-- 增加金币 -->
    <update id="addCoins">
        UPDATE user_wallet
        SET coin_balance = coin_balance + #{coins},
            version = version + 1,
            updated_at = NOW()
        WHERE user_id = #{userId}
          AND version = #{version}
    </update>

    <!-- 扣减金币 -->
    <update id="deductCoins">
        UPDATE user_wallet
        SET coin_balance = coin_balance - #{coins},
            version = version + 1,
            updated_at = NOW()
        WHERE user_id = #{userId}
          AND version = #{version}
          AND coin_balance >= #{coins}  /* 金币余额必须足够 */
    </update>

    <!-- 查询余额分布统计 -->
    <select id="selectBalanceDistribution" resultType="map">
        SELECT
            CASE
                WHEN balance = 0 THEN '零余额'
                WHEN balance BETWEEN 1 AND 10000 THEN '1-100元'
                WHEN balance BETWEEN 10001 AND 50000 THEN '100-500元'
                WHEN balance BETWEEN 50001 AND 100000 THEN '500-1000元'
                ELSE '1000元以上'
            END AS balance_range,
            COUNT(*) AS user_count,
            ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM user_wallet), 2) AS percentage
        FROM user_wallet
        GROUP BY balance_range
        ORDER BY MIN(balance)
    </select>

    <!-- 查询钱包总览统计 -->
    <select id="selectWalletOverview" resultType="map">
        SELECT
            COUNT(*) AS total_users,
            SUM(balance) / 100.0 AS total_balance_yuan,
            SUM(frozen) / 100.0 AS total_frozen_yuan,
            SUM(balance + frozen) / 100.0 AS total_assets_yuan,
            AVG(balance) / 100.0 AS avg_balance_yuan,
            MAX(balance) / 100.0 AS max_balance_yuan,
            MIN(balance) / 100.0 AS min_balance_yuan,
            SUM(total_income) / 100.0 AS platform_total_income_yuan,
            SUM(total_expense) / 100.0 AS platform_total_expense_yuan,
            SUM(coin_balance) AS total_coins
        FROM user_wallet
    </select>

    <!-- 查询余额不足用户列表 -->
    <select id="selectLowBalanceUsers" resultType="java.lang.Long">
        SELECT user_id
        FROM user_wallet
        WHERE balance <![CDATA[<]]> #{minBalance}
        ORDER BY balance ASC
        LIMIT 100
    </select>

</mapper>

