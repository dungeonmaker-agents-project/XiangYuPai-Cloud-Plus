# XyPai-Common 通用服务快速理解

## 📌 核心定位
向娱拍通用服务，基于 Spring Cloud 微服务架构。

**本模块职责**：统一的基础业务服务集合，包含位置服务、媒体上传、通知系统、举报审核四大子服务，直接连接 `xypai_common` 数据库，无 RPC 依赖，作为平台基础设施支撑各业务模块。

## 🎯 主要功能
- **位置服务**：城市列表 + 附近地点查询（Haversine 算法）
- **媒体上传**：图片/视频上传 + MD5 秒传 + OSS 存储
- **通知系统**：系统通知 + 未读统计 + 消息推送
- **举报审核**：用户举报 + 管理员审核 + 处罚记录

## 🏗️ 技术栈
```
Spring Boot 3.x + MyBatis Plus + Nacos + Dubbo RPC
MySQL (xypai_common 数据库，7 张表) + Redis (缓存) + OSS (媒体存储)
```

## 📁 核心目录结构
```
xypai-common/
├── CommonApplication.java              # 统一启动类（4 个子服务共用）
├── location/                            # 位置服务
│   ├── controller/app/
│   │   ├── LocationController.java    # 附近地点 API
│   │   └── CityController.java        # 城市列表 API
│   ├── service/impl/
│   │   ├── LocationServiceImpl.java   # Haversine 距离计算
│   │   └── CityServiceImpl.java       # 城市列表 + 缓存
│   ├── mapper/
│   │   ├── LocationMapper.java        # 地点数据访问
│   │   └── CityMapper.java            # 城市数据访问
│   └── dubbo/
│       └── RemoteLocationServiceImpl.java  # RPC Provider
├── media/                               # 媒体上传服务
│   ├── controller/app/
│   │   └── MediaController.java       # 媒体上传 API
│   ├── service/impl/
│   │   └── MediaServiceImpl.java      # OSS 上传 + MD5 秒传
│   ├── mapper/
│   │   └── MediaFileMapper.java       # 媒体文件数据访问
│   └── dubbo/
│       └── RemoteMediaServiceImpl.java     # RPC Provider
├── notification/                        # 通知服务
│   ├── controller/app/
│   │   └── NotificationController.java  # 通知 API
│   ├── service/impl/
│   │   └── NotificationServiceImpl.java # 通知 CRUD + 未读统计
│   └── mapper/
│       └── NotificationMapper.java      # 通知数据访问
└── report/                              # 举报审核服务
    ├── controller/
    │   ├── app/
    │   │   └── ReportController.java    # C 端举报 API
    │   └── admin/
    │       └── ReportManageController.java  # B 端审核 API
    ├── service/impl/
    │   └── ReportServiceImpl.java       # 举报提交 + 审核 + 处罚
    └── mapper/
        ├── ReportMapper.java            # 举报数据访问
        └── PunishmentMapper.java        # 处罚数据访问
```

## 🔑 核心接口

### 位置服务
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `GET /common/location/nearby` | 附近地点查询 | 经纬度 + 半径（km） |
| `GET /common/city/list` | 城市列表 | 按拼音分组 + 热门城市 |
| `GET /common/city/hot` | 热门城市 | Top 10 |

### 媒体上传
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /common/media/upload` | 上传图片/视频 | MD5 秒传 + OSS URL |
| `GET /common/media/:fileId` | 获取文件信息 | 文件大小、类型、上传者 |
| `DELETE /common/media/:fileId` | 删除文件 | 软删除 |

### 通知系统
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `GET /common/notification/list` | 通知列表 | 分页 + 已读/未读筛选 |
| `GET /common/notification/unread` | 未读数统计 | 按类型分组统计 |
| `PUT /common/notification/:id/read` | 标记已读 | - |
| `PUT /common/notification/read-all` | 全部已读 | - |

### 举报审核
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /common/report` | 提交举报 | 举报类型 + 原因 + 截图 |
| `GET /admin/report/list` | 举报列表（B端） | 待审核/已处理筛选 |
| `PUT /admin/report/:id/review` | 审核举报（B端） | 通过/驳回 + 处罚措施 |

## 💾 数据库：xypai_common（7 张表）
```sql
-- 位置服务（2 张表）
location               # 地点表（POI + 空间索引）
city                   # 城市表（省市区 + 拼音 + 热度）

-- 媒体服务（1 张表）
media_file             # 媒体文件表（MD5、OSS URL、大小）

-- 通知服务（1 张表）
notification           # 通知表（类型、内容、已读状态）

-- 举报服务（3 张表）
report                 # 举报表（举报人、被举报对象、类型、原因）
punishment             # 处罚表（处罚类型、时长、原因）
report_evidence        # 举报证据表（截图 URL）
```

## 🏛️ 微服务架构
```
┌─────────────────┐
│  各业务服务      │  ← xypai-user、xypai-content 等
│  (调用基础服务)  │
└────────┬────────┘
         │ REST API / Dubbo RPC
         ↓
┌─────────────────┐
│  xypai-common   │  ← 本模块（统一通用服务）
│  (4 个子服务)    │
│  - location     │
│  - media        │
│  - notification │
│  - report       │
└────────┬────────┘
         │ MyBatis Plus
         ↓
┌─────────────────┐
│ xypai_common    │  ← MySQL 数据库（7 张表）
└─────────────────┘

         ↓ OSS（媒体存储）
┌─────────────────┐
│ 对象存储         │  ← 图片/视频文件
└─────────────────┘
```

## 🔥 技术亮点
1. **单一应用架构**：4 个子服务共用一个 Spring Boot 应用，减少运维成本
2. **Haversine 算法**：位置服务使用 Haversine 公式精确计算地球表面两点距离
3. **MD5 秒传**：媒体上传前校验 MD5，已存在文件直接返回 URL，节省存储和带宽
4. **通知分类统计**：未读消息按类型（系统通知/点赞/评论/关注）分组统计
5. **举报审核流程**：C 端提交 → B 端审核 → 自动/手动处罚 → 记录留痕

## 📦 依赖关系
```
各业务服务 (xypai-user / xypai-content)
  ↓ REST API / Dubbo RPC
xypai-common (本模块，基础服务集合)
  ↓ MyBatis Plus
xypai_common 数据库 (7 张表)
  ↓ OSS
对象存储 (图片/视频文件)
```

## 🚀 快速启动
```bash
# 1. 确保依赖服务已启动
#    - Nacos（服务注册中心）
#    - MySQL（xypai_common 数据库，导入 sql/xypai_common.sql）
#    - Redis（缓存）
#    - OSS（对象存储，用于媒体文件）

# 2. 启动本服务
cd xypai-common
mvn clean package -DskipTests
java -jar target/xypai-common.jar

# 默认端口：9407
# Swagger UI: http://localhost:9407/doc.html
```

## 📌 注意事项
- **统一服务**：本模块包含 4 个子服务（location、media、notification、report），共用一个启动类和数据库
- **数据库初始化**：首次启动前需导入 `sql/xypai_common.sql` 创建 7 张表
- **位置查询**：`location` 表需要创建空间索引（SPATIAL INDEX）以支持高效的附近查询
- **媒体上传**：支持图片格式（JPG/PNG/GIF）和视频格式（MP4/AVI），单文件最大 100MB
- **MD5 秒传**：上传前计算文件 MD5，如果数据库已存在相同文件则直接返回 URL
- **通知类型**：系统通知、点赞通知、评论通知、关注通知、举报结果通知
- **举报流程**：用户提交举报 → 管理员审核 → 通过则创建处罚记录 → 通知举报人和被举报人
- 所有接口返回统一格式 `R<T>` (code, message, data)
