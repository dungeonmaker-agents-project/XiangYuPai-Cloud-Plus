<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xypai.content.mapper.ContentStatsMapper">

    <!-- ===== 增加浏览数 ===== -->
    <update id="incrementViewCount">
        INSERT INTO content_stats (content_id, view_count, created_at)
        VALUES (#{contentId}, #{increment}, NOW())
        ON DUPLICATE KEY UPDATE
            view_count = view_count + #{increment},
            updated_at = NOW()
    </update>

    <!-- ===== 增加点赞数 ===== -->
    <update id="incrementLikeCount">
        INSERT INTO content_stats (content_id, like_count, created_at)
        VALUES (#{contentId}, #{increment}, NOW())
        ON DUPLICATE KEY UPDATE
            like_count = GREATEST(0, like_count + #{increment}),
            updated_at = NOW()
    </update>

    <!-- ===== 增加评论数 ===== -->
    <update id="incrementCommentCount">
        INSERT INTO content_stats (content_id, comment_count, created_at)
        VALUES (#{contentId}, #{increment}, NOW())
        ON DUPLICATE KEY UPDATE
            comment_count = GREATEST(0, comment_count + #{increment}),
            updated_at = NOW()
    </update>

    <!-- ===== 增加分享数 ===== -->
    <update id="incrementShareCount">
        INSERT INTO content_stats (content_id, share_count, created_at)
        VALUES (#{contentId}, #{increment}, NOW())
        ON DUPLICATE KEY UPDATE
            share_count = share_count + #{increment},
            updated_at = NOW()
    </update>

    <!-- ===== 增加收藏数 ===== -->
    <update id="incrementCollectCount">
        INSERT INTO content_stats (content_id, collect_count, created_at)
        VALUES (#{contentId}, #{increment}, NOW())
        ON DUPLICATE KEY UPDATE
            collect_count = GREATEST(0, collect_count + #{increment}),
            updated_at = NOW()
    </update>

    <!-- ===== 批量更新统计数据 ===== -->
    <update id="batchUpdateStats">
        <foreach collection="list" item="item" separator=";">
            INSERT INTO content_stats 
            (content_id, view_count, like_count, comment_count, share_count, collect_count, last_sync_time, created_at)
            VALUES 
            (#{item.contentId}, #{item.viewCount}, #{item.likeCount}, #{item.commentCount}, 
             #{item.shareCount}, #{item.collectCount}, #{item.lastSyncTime}, NOW())
            ON DUPLICATE KEY UPDATE
                view_count = VALUES(view_count),
                like_count = VALUES(like_count),
                comment_count = VALUES(comment_count),
                share_count = VALUES(share_count),
                collect_count = VALUES(collect_count),
                last_sync_time = VALUES(last_sync_time),
                updated_at = NOW()
        </foreach>
    </update>

    <!-- ===== 初始化统计记录 ===== -->
    <insert id="initStats">
        INSERT INTO content_stats (content_id, created_at)
        VALUES (#{contentId}, NOW())
        ON DUPLICATE KEY UPDATE content_id = content_id
    </insert>

</mapper>

