<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xypai.content.mapper.CommentMapper">

    <!-- ===== 查询一级评论列表 ===== -->
    <select id="selectFirstLevelComments" resultType="com.xypai.content.domain.entity.Comment">
        SELECT *
        FROM comment
        WHERE 
            content_id = #{contentId}
            AND parent_id IS NULL
            AND status = 1
        ORDER BY 
            is_top DESC,
            like_count DESC,
            created_at DESC
        LIMIT #{limit}
    </select>

    <!-- ===== 查询二级回复列表 ===== -->
    <select id="selectSecondLevelReplies" resultType="com.xypai.content.domain.entity.Comment">
        SELECT *
        FROM comment
        WHERE 
            parent_id = #{parentId}
            AND status = 1
        ORDER BY created_at ASC
        LIMIT #{limit}
    </select>

    <!-- ===== 查询所有二级回复 ===== -->
    <select id="selectAllRepliesByParentId" resultType="com.xypai.content.domain.entity.Comment">
        SELECT *
        FROM comment
        WHERE 
            parent_id = #{parentId}
            AND status = 1
        ORDER BY created_at ASC
    </select>

    <!-- ===== 增加回复数 ===== -->
    <update id="incrementReplyCount">
        UPDATE comment
        SET reply_count = GREATEST(0, reply_count + #{increment}),
            updated_at = NOW()
        WHERE id = #{commentId}
    </update>

    <!-- ===== 增加点赞数 ===== -->
    <update id="incrementLikeCount">
        UPDATE comment
        SET like_count = GREATEST(0, like_count + #{increment}),
            updated_at = NOW()
        WHERE id = #{commentId}
    </update>

    <!-- ===== 查询用户评论列表 ===== -->
    <select id="selectCommentsByUserId" resultType="com.xypai.content.domain.entity.Comment">
        SELECT *
        FROM comment
        WHERE 
            user_id = #{userId}
            AND status = 1
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    <!-- ===== 统计内容评论数 ===== -->
    <select id="countByContentId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM comment
        WHERE 
            content_id = #{contentId}
            AND status = 1
    </select>

</mapper>

