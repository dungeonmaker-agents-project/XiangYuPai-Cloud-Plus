# Same-Token å®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜æ€»ç»“

### ç°è±¡
- âœ… GatewayæˆåŠŸç”ŸæˆSame-Token
- âœ… GatewayæˆåŠŸå‘é€Same-Tokenåˆ°Content Service
- âŒ Redisä¸­è¯»å–Same-Tokenä¸ºnull
- âŒ Content ServiceéªŒè¯å¤±è´¥ï¼Œè¿”å›401

### æ ¹æœ¬åŸå› 
**Sa-Tokençš„`SaSameUtil.getToken()`æ–¹æ³•ç”Ÿæˆtokenä½†ä¸ä¼šè‡ªåŠ¨å­˜å‚¨åˆ°Redisï¼**

ä»æ—¥å¿—ç¡®è®¤ï¼š
```
[GATEWAY] Same-Tokenå®Œæ•´å€¼: QROPDYZchpe...
[GATEWAY] Redisä¸­å­˜å‚¨çš„Same-Token: null  â† é—®é¢˜ï¼
[CONTENT] Redisä¸­çš„Same-Token: null  â† éªŒè¯å¤±è´¥ï¼
```

**ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ**
1. Sa-Tokençš„Same-Tokenæœºåˆ¶å‡è®¾åœ¨Servletç¯å¢ƒä¸‹ä¼šè‡ªåŠ¨åˆå§‹åŒ–
2. Gatewayä½¿ç”¨WebFluxï¼ˆå“åº”å¼ç¼–ç¨‹ï¼‰ï¼Œåˆå§‹åŒ–æœºåˆ¶å¯èƒ½ä¸åŒ
3. `SaSameUtil.getToken()`åªç”Ÿæˆtokenï¼Œä¸è´Ÿè´£æŒä¹…åŒ–
4. éœ€è¦åº”ç”¨å±‚æ˜¾å¼å°†tokenå­˜å‚¨åˆ°Redis

---

## âœ… å®Œæ•´è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°
åœ¨Gatewayå¯åŠ¨æ—¶ï¼Œæ˜¾å¼åˆå§‹åŒ–Same-Tokenå¹¶å­˜å‚¨åˆ°Redisã€‚

### å®æ–½æ­¥éª¤

#### 1ï¸âƒ£ åˆ›å»ºSame-Tokenåˆå§‹åŒ–å™¨

**æ–‡ä»¶**: `ruoyi-gateway/src/main/java/org/dromara/gateway/config/SameTokenInitializer.java`

**åŠŸèƒ½**:
- âœ… åœ¨Gatewayå¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œï¼ˆ`ApplicationRunner`ï¼‰
- âœ… ç”ŸæˆSame-Token
- âœ… å­˜å‚¨åˆ°Redisï¼Œè®¾ç½®7å¤©æœ‰æ•ˆæœŸ
- âœ… éªŒè¯å­˜å‚¨æ˜¯å¦æˆåŠŸ
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

**æ ¸å¿ƒä»£ç **:
```java
@Component
public class SameTokenInitializer implements ApplicationRunner {
    
    private static final String SAME_TOKEN_KEY = "satoken:var:same-token";
    private static final Duration SAME_TOKEN_TTL = Duration.ofDays(7);

    @Override
    public void run(ApplicationArguments args) {
        // 1. ç”ŸæˆSame-Token
        String sameToken = SaSameUtil.getToken();
        
        // 2. å­˜å‚¨åˆ°Redis
        RedisUtils.setCacheObject(SAME_TOKEN_KEY, sameToken, SAME_TOKEN_TTL);
        
        // 3. éªŒè¯å­˜å‚¨
        String verifyToken = RedisUtils.getCacheObject(SAME_TOKEN_KEY);
        if (verifyToken != null && verifyToken.equals(sameToken)) {
            log.info("âœ… Same-Tokenåˆå§‹åŒ–æˆåŠŸ");
        }
    }
}
```

---

#### 2ï¸âƒ£ å¯åŠ¨é¡ºåº

1. **é‡å¯Gateway** - è§¦å‘Same-Tokenåˆå§‹åŒ–
2. **é‡å¯Content Service** - ä½¿ç”¨æ–°çš„éªŒè¯ä»£ç 
3. **è¿è¡Œæµ‹è¯•** - éªŒè¯å®Œæ•´æµç¨‹

---

## ğŸ“Š é¢„æœŸç»“æœ

### Gatewayå¯åŠ¨æ—¥å¿—ï¼š
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” [SAME-TOKEN INIT] å¼€å§‹åˆå§‹åŒ–Same-Token
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   âœ… ç”ŸæˆSame-Token: QROPDYZchpe...
   â„¹ï¸  Redisä¸­ä¸å­˜åœ¨Same-Tokenï¼Œå°†å­˜å‚¨æ–°ç”Ÿæˆçš„token
   âœ… Same-Tokenå·²å­˜å‚¨åˆ°Redis
   ğŸ“‹ Redis Key: satoken:var:same-token
   â° æœ‰æ•ˆæœŸ: 7 å¤©
   âœ… éªŒè¯æˆåŠŸï¼šSame-Tokenå·²æ­£ç¡®å­˜å‚¨åˆ°Redis
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‰ [SAME-TOKEN INIT] Same-Tokenåˆå§‹åŒ–å®Œæˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### Gatewayå¤„ç†è¯·æ±‚æ—¶ï¼š
```
ğŸ“Š [GATEWAY REDIS] Redisè¿æ¥ä¿¡æ¯:
   ConnectionFactory: RedissonConnectionFactory

ğŸ”‘ [SAME-TOKEN] Same-Tokenå®Œæ•´å€¼: QROPDYZchpe...
   Redisä¸­å­˜å‚¨çš„Same-Token: QROPDYZchpe...  â† âœ… æˆåŠŸï¼
   ä¸¤è€…æ˜¯å¦ä¸€è‡´: true  â† âœ… æˆåŠŸï¼
```

### Content ServiceéªŒè¯æ—¶ï¼š
```
ğŸ“Š [CONTENT REDIS] Redisè¿æ¥ä¿¡æ¯:
   ConnectionFactory: RedissonConnectionFactory
   
   Redis Key: satoken:var:same-token
   Redisä¸­çš„Same-Token: QROPDYZchpe...  â† âœ… æˆåŠŸï¼
   è¯·æ±‚ä¸­çš„Same-Token: QROPDYZchpe...
   ä¸¤è€…æ˜¯å¦ä¸€è‡´: true  â† âœ… æˆåŠŸï¼
   âœ… Same-TokenéªŒè¯é€šè¿‡
```

### æµ‹è¯•è¾“å‡ºï¼š
```
âœ… é˜¶æ®µ3æˆåŠŸ - å®Œæ•´ä¸šåŠ¡æµç¨‹é€šè¿‡ï¼
ğŸ“Š å®Œæ•´ä¸šåŠ¡éªŒè¯ç»“æœ:
   âœ… Gatewayè·¯ç”±æˆåŠŸ
   âœ… Sa-Tokenè®¤è¯é€šè¿‡
   âœ… Content Serviceå“åº”æ­£å¸¸
   âœ… Same-TokenéªŒè¯é€šè¿‡
   âœ… çœŸå®ä¸šåŠ¡æ¥å£å·¥ä½œæ­£å¸¸
```

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### Same-Tokenç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£ Gatewayå¯åŠ¨                                          â”‚
â”‚    â”œâ”€ SameTokenInitializer.run()                       â”‚
â”‚    â”œâ”€ ç”Ÿæˆ: QROPDYZchpe...                             â”‚
â”‚    â””â”€ å­˜å‚¨åˆ°Redis: satoken:var:same-token (7å¤©TTL)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£ Gatewayå¤„ç†è¯·æ±‚                                      â”‚
â”‚    â”œâ”€ SaSameUtil.getToken() ä»Redisè¯»å–                â”‚
â”‚    â”œâ”€ æ·»åŠ åˆ°è¯·æ±‚Header: Same-Token                     â”‚
â”‚    â””â”€ è½¬å‘åˆ°Content Service                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£ Content ServiceéªŒè¯                                  â”‚
â”‚    â”œâ”€ ä»è¯·æ±‚Headerè¯»å–: Same-Token                     â”‚
â”‚    â”œâ”€ ä»Redisè¯»å–é¢„æœŸå€¼: satoken:var:same-token        â”‚
â”‚    â”œâ”€ å¯¹æ¯”æ˜¯å¦ä¸€è‡´                                     â”‚
â”‚    â””â”€ ä¸€è‡´ âœ… â†’ æ”¾è¡Œ | ä¸ä¸€è‡´ âŒ â†’ è¿”å›401              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Redis Keyè¯´æ˜

| Key | å€¼ | TTL | è¯´æ˜ |
|-----|------|-----|------|
| `satoken:var:same-token` | `QROPDYZchpe...`ï¼ˆå›ºå®šå­—ç¬¦ä¸²ï¼‰ | 7å¤© | æ‰€æœ‰Gatewayå®ä¾‹å…±äº«åŒä¸€ä¸ªtoken |

**é‡è¦ç‰¹æ€§**ï¼š
- âœ… å¤šä¸ªGatewayå®ä¾‹ä¼šä½¿ç”¨åŒä¸€ä¸ªSame-Tokenï¼ˆä»Redisè¯»å–ï¼‰
- âœ… å¦‚æœRedisä¸­å·²å­˜åœ¨ï¼Œä¸ä¼šè¦†ç›–ï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
- âœ… 7å¤©åè‡ªåŠ¨è¿‡æœŸï¼ŒGatewayé‡å¯æ—¶ä¼šé‡æ–°ç”Ÿæˆ
- âœ… æ‰€æœ‰å¾®æœåŠ¡ä»åŒä¸€ä¸ªRedis databaseè¯»å–

---

## ğŸ¯ ä¸ºä»€ä¹ˆè¿™æ˜¯å®Œæ•´æ–¹æ¡ˆï¼Ÿ

### âœ… å½»åº•è§£å†³æ ¹æœ¬é—®é¢˜
- **ä¸æ˜¯ä¸´æ—¶ç¦ç”¨check-same-token**
- **ä¸æ˜¯ç»•è¿‡éªŒè¯**
- **ç›´æ¥ä¿®å¤Same-Tokenæœºåˆ¶æœ¬èº«**

### âœ… é€‚ç”¨äºæ‰€æœ‰ç¯å¢ƒ
- âœ… å¼€å‘ç¯å¢ƒ
- âœ… æµ‹è¯•ç¯å¢ƒ
- âœ… ç”Ÿäº§ç¯å¢ƒ

### âœ… ä¿æŒå®‰å…¨æ€§
- âœ… Same-TokenéªŒè¯ç»§ç»­å·¥ä½œ
- âœ… é˜²æ­¢ç»•è¿‡Gatewayç›´æ¥è®¿é—®å¾®æœåŠ¡
- âœ… ä¸é™ä½ç³»ç»Ÿå®‰å…¨æ€§

### âœ… å¯ç»´æŠ¤æ€§
- âœ… ä»£ç æ¸…æ™°ï¼Œæ˜“äºç†è§£
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- âœ… å¤±è´¥æ—¶æœ‰æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯

### âœ… å¥å£®æ€§
- âœ… æ”¯æŒå¤šå®ä¾‹Gatewayï¼ˆå…±äº«åŒä¸€ä¸ªtokenï¼‰
- âœ… æ”¯æŒGatewayé‡å¯ï¼ˆtokenæŒä¹…åŒ–åœ¨Redisï¼‰
- âœ… è‡ªåŠ¨éªŒè¯tokenæ˜¯å¦æ­£ç¡®å­˜å‚¨

---

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### 1. ç¼–è¯‘é¡¹ç›®
```
åœ¨IDEAä¸­ï¼šBuild â†’ Rebuild Project
```

### 2. é‡å¯Gateway
```
åœ¨IDEAä¸­ï¼š
1. åœæ­¢å½“å‰Gateway
2. è¿è¡Œ RuoYiGatewayApplication
3. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼Œç¡®è®¤çœ‹åˆ°ï¼š
   "ğŸ‰ [SAME-TOKEN INIT] Same-Tokenåˆå§‹åŒ–å®Œæˆ"
```

### 3. é‡å¯Content Service
```powershell
taskkill /PID <Content-PID> /F
# åœ¨IDEAä¸­è¿è¡Œ XyPaiContentApplication
```

### 4. è¿è¡Œæµ‹è¯•
```
SimpleSaTokenTest.java â†’ å³é”® â†’ Run Test
```

### 5. éªŒè¯ç»“æœ
æ£€æŸ¥æ—¥å¿—ä¸­ï¼š
- [ ] Gatewayå¯åŠ¨æ—¶æ˜¾ç¤º"Same-Tokenåˆå§‹åŒ–å®Œæˆ"
- [ ] Gatewayå¤„ç†è¯·æ±‚æ—¶"Redisä¸­å­˜å‚¨çš„Same-Token"ä¸ä¸ºnull
- [ ] Content ServiceéªŒè¯æ—¶"ä¸¤è€…æ˜¯å¦ä¸€è‡´: true"
- [ ] æµ‹è¯•è¾“å‡º"âœ… é˜¶æ®µ3æˆåŠŸ"

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¦‚æœGatewayå¯åŠ¨æ—¶Same-Tokenåˆå§‹åŒ–å¤±è´¥

**æ£€æŸ¥**ï¼š
1. Redisæ˜¯å¦æ­£å¸¸è¿è¡Œï¼Ÿ`redis-cli ping`
2. Gatewayèƒ½å¦è¿æ¥Redisï¼ŸæŸ¥çœ‹å¯åŠ¨æ—¥å¿—ä¸­çš„Redissonè¿æ¥ä¿¡æ¯
3. RedisUtilsæ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿå°è¯•æ‰‹åŠ¨å­˜å‚¨æµ‹è¯•æ•°æ®

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥Redis
redis-cli -h 127.0.0.1 -p 6379 -a ruoyi123 ping
# åº”è¯¥è¿”å›ï¼šPONG

# æ£€æŸ¥Same-Token
redis-cli -h 127.0.0.1 -p 6379 -a ruoyi123
SELECT 0
GET satoken:var:same-token
# åº”è¯¥è¿”å›ä¸€ä¸ªé•¿å­—ç¬¦ä¸²
```

### å¦‚æœéªŒè¯æ—¶Stillè¿”å›null

**æ£€æŸ¥**ï¼š
1. Gatewayå’ŒContent Serviceæ˜¯å¦è¿æ¥åˆ°åŒä¸€ä¸ªRedis databaseï¼Ÿ
2. `xypai-content.yml`ä¸­æ˜¯å¦è¿˜æœ‰`database: 3`é…ç½®ï¼Ÿ
3. ä¸¤ä¸ªæœåŠ¡å¯åŠ¨æ—¥å¿—ä¸­çš„Redisè¿æ¥ä¿¡æ¯æ˜¯å¦ä¸€è‡´ï¼Ÿ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **SameTokenInitializer.java** - Same-Tokenåˆå§‹åŒ–å™¨æºç 
- **é—®é¢˜è§£å†³_Redis_Databaseé…ç½®.md** - Redisé…ç½®é—®é¢˜åˆ†æ
- **SAME_TOKEN_DEBUG_GUIDE.md** - è°ƒè¯•æŒ‡å—
- **RediséªŒè¯æŒ‡å—.md** - RediséªŒè¯æ–¹æ³•

---

## ğŸ“Š å¯¹æ¯”ï¼šä¸´æ—¶æ–¹æ¡ˆ vs å®Œæ•´æ–¹æ¡ˆ

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **ä¸´æ—¶ï¼šç¦ç”¨check-same-token** | å¿«é€Ÿ | âŒ é™ä½å®‰å…¨æ€§<br>âŒ ç”Ÿäº§ç¯å¢ƒä¸å¯ç”¨<br>âŒ æ²¡æœ‰è§£å†³æ ¹æœ¬é—®é¢˜ | ä»…å¼€å‘è°ƒè¯• |
| **å®Œæ•´ï¼šåˆå§‹åŒ–Same-Token** | âœ… ä¿æŒå®‰å…¨æ€§<br>âœ… ç”Ÿäº§ç¯å¢ƒå¯ç”¨<br>âœ… å½»åº•è§£å†³é—®é¢˜ | éœ€è¦é‡å¯æœåŠ¡ | âœ… **æ‰€æœ‰ç¯å¢ƒ** |

---

## âœ… æ€»ç»“

### é—®é¢˜
Sa-Tokençš„Same-Tokenåœ¨WebFluxç¯å¢ƒä¸‹ä¸ä¼šè‡ªåŠ¨åˆå§‹åŒ–å¹¶å­˜å‚¨åˆ°Redisã€‚

### è§£å†³
åˆ›å»º`SameTokenInitializer`åœ¨Gatewayå¯åŠ¨æ—¶ä¸»åŠ¨åˆå§‹åŒ–å¹¶å­˜å‚¨Same-Tokenåˆ°Redisã€‚

### ç»“æœ
- âœ… Same-Tokenæœºåˆ¶å®Œå…¨æ­£å¸¸å·¥ä½œ
- âœ… Gatewayå’Œå¾®æœåŠ¡é—´è®¤è¯æˆåŠŸ
- âœ… ä¿æŒç³»ç»Ÿå®‰å…¨æ€§
- âœ… é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒ

---

## ğŸ“… åˆ›å»ºæ—¶é—´

- **æ—¥æœŸ**: 2025-11-08
- **é—®é¢˜**: Same-TokenéªŒè¯å¤±è´¥ï¼ˆRedisä¸­ä¸ºnullï¼‰
- **è§£å†³æ–¹æ¡ˆ**: Same-Tokenåˆå§‹åŒ–å™¨
- **çŠ¶æ€**: âœ… å®Œæ•´è§£å†³æ–¹æ¡ˆ

---

**è¿™æ˜¯ä¸€ä¸ªå®Œæ•´ã€å½»åº•ã€ç”Ÿäº§å°±ç»ªçš„è§£å†³æ–¹æ¡ˆï¼** ğŸ‰

