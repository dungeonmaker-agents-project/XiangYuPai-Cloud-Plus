# ğŸ” JWT Simple Mode æ¶æ„è¯´æ˜

## âœ… ä¿®å¤å®Œæˆ

### é—®é¢˜
```
æµ‹è¯•è¿”å›: {"code": 401, "msg": "è®¤è¯å¤±è´¥ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº"}
Gatewayæ—¥å¿—: âœ… è®¤è¯æˆåŠŸ
Content Service: è¿”å›401
```

### åŸå› 
Content Serviceä½¿ç”¨**JWT Simple Modeï¼ˆæ— çŠ¶æ€æ¨¡å¼ï¼‰**ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼š
- âŒ `@SaCheckLogin` æ³¨è§£ä¼šå¤±è´¥
- âŒ `StpUtil.checkLogin()` ä¼šå¤±è´¥  
- âœ… åªèƒ½ä½¿ç”¨ `LoginHelper` è·å–ç”¨æˆ·ä¿¡æ¯

### è§£å†³æ–¹æ¡ˆ
**ç§»é™¤æ‰€æœ‰ `@SaCheckLogin` æ³¨è§£**ï¼Œè®©Gatewayå¤„ç†æ‰€æœ‰è®¤è¯ã€‚

---

## ğŸ—ï¸ å¾®æœåŠ¡è®¤è¯æ¶æ„

### è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£  å‰ç«¯å‘é€è¯·æ±‚                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  GET /xypai-content/api/v1/homepage/users/list              â”‚
â”‚  Headers:                                                    â”‚
â”‚    Authorization: Bearer eyJ0eXAiOiJKV1Q...                â”‚
â”‚    clientid: app                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£  Gateway éªŒè¯Tokenï¼ˆå”¯ä¸€éªŒè¯ç‚¹ï¼‰                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  âœ… StpUtil.checkLogin() - éªŒè¯JWTç­¾å                      â”‚
â”‚  âœ… éªŒè¯Tokenæœ‰æ•ˆæœŸ                                         â”‚
â”‚  âœ… éªŒè¯ClientIdåŒ¹é…                                        â”‚
â”‚  âœ… è§£æJWT payloadï¼Œè®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£  è½¬å‘åˆ°Content Service                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  GatewayæŠŠéªŒè¯åçš„Tokenå’Œç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£  Content Service å¤„ç†è¯·æ±‚ï¼ˆä¸å†éªŒè¯Tokenï¼‰             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  âŒ ä¸è°ƒç”¨ @SaCheckLogin                                    â”‚
â”‚  âŒ ä¸è°ƒç”¨ StpUtil.checkLogin()                             â”‚
â”‚  âœ… ç›´æ¥ä½¿ç”¨ LoginHelper.getUserId()                        â”‚
â”‚  âœ… ç›´æ¥ä½¿ç”¨ LoginHelper.getUsername()                      â”‚
â”‚  âœ… ä¿¡ä»»Gatewayçš„éªŒè¯ç»“æœ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ä»£ç å¯¹æ¯”

### âŒ é”™è¯¯åšæ³•ï¼ˆä¼šå¯¼è‡´401ï¼‰

```java
@RestController
@RequestMapping("/api/v1/homepage")
public class HomepageController {

    @GetMapping("/users/list")
    @SaCheckLogin  // âŒ é”™è¯¯ï¼JWT Simple Modeä¸‹ä¼šå¤±è´¥
    public R<Map<String, Object>> getUserList() {
        // è¿™ä¸ªæ–¹æ³•æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œå› ä¸º @SaCheckLogin ä¼šæŠ›å‡ºå¼‚å¸¸
        return R.ok(...);
    }
}
```

**ç»“æœ**: è¿”å› 401ï¼Œå› ä¸º `@SaCheckLogin` æ— æ³•åœ¨JWT Simple Modeä¸‹å·¥ä½œã€‚

---

### âœ… æ­£ç¡®åšæ³•

```java
@RestController
@RequestMapping("/api/v1/homepage")
public class HomepageController {

    @GetMapping("/users/list")
    // âœ… ä¸ä½¿ç”¨ @SaCheckLoginï¼Œä¿¡ä»»Gateway
    public R<Map<String, Object>> getUserList() {
        // âœ… ç›´æ¥ä½¿ç”¨ LoginHelper è·å–ç”¨æˆ·ä¿¡æ¯
        // Gatewayå·²ç»éªŒè¯è¿‡Tokenï¼Œè¿™äº›æ–¹æ³•å¯ä»¥æ­£å¸¸å·¥ä½œ
        Long userId = LoginHelper.getUserId();
        String username = LoginHelper.getUsername();
        String clientId = (String) StpUtil.getExtra(LoginHelper.CLIENT_KEY);
        
        log.info("ç”¨æˆ· {} è¯·æ±‚ç”¨æˆ·åˆ—è¡¨", username);
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘...
        return R.ok(data);
    }
}
```

**ç»“æœ**: 
- âœ… GatewayéªŒè¯Token
- âœ… Content Serviceè·å–ç”¨æˆ·ä¿¡æ¯
- âœ… è¿”å›200æˆåŠŸ

---

## ğŸ¯ ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„æ¶æ„ï¼Ÿ

### JWT Simple Mode çš„ç‰¹ç‚¹

1. **æ— çŠ¶æ€**
   - JWTæ˜¯è‡ªåŒ…å«çš„ï¼ŒåŒ…å«æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
   - ä¸éœ€è¦Redis Session
   - ä¸éœ€è¦æŸ¥è¯¢æ•°æ®åº“éªŒè¯Token

2. **ç­¾åéªŒè¯ä¸€æ¬¡å³å¯**
   - GatewayéªŒè¯JWTç­¾å
   - ä¸‹æ¸¸æœåŠ¡ä¿¡ä»»Gatewayï¼Œä¸é‡å¤éªŒè¯
   - å‡å°‘æ€§èƒ½å¼€é”€

3. **å¾®æœåŠ¡æœ€ä½³å®è·µ**
   - ç»Ÿä¸€çš„è®¤è¯å…¥å£ï¼ˆGatewayï¼‰
   - ä¸‹æ¸¸æœåŠ¡ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
   - æ¸…æ™°çš„èŒè´£åˆ†ç¦»

---

## ğŸ”§ å…³é”®é…ç½®æ–‡ä»¶

### Content Service: `SaTokenConfig.java`

```java
@Configuration
public class SaTokenConfig {
    /**
     * âŒ å·²ç¦ç”¨ SaServletFilter
     * 
     * åŸå› ï¼šä½¿ç”¨ JWT Simple Modeï¼ˆæ— çŠ¶æ€æ¨¡å¼ï¼‰
     * - Gateway å·²ç»éªŒè¯äº†æ‰€æœ‰ token
     * - æœåŠ¡è°ƒç”¨ StpUtil.checkLogin() ä¼šå¤±è´¥ï¼ˆJWT æ—  sessionï¼‰
     * - å¾®æœåŠ¡æ¶æ„ä¸‹ï¼ŒæœåŠ¡åº”ä¿¡ä»» Gateway çš„éªŒè¯ç»“æœ
     */
    // SaServletFilter å·²ç¦ç”¨
}
```

### Gateway: `AuthFilter.java`

```java
@Configuration
public class AuthFilter {
    @Bean
    public SaReactorFilter getSaReactorFilter(IgnoreWhiteProperties ignoreWhite) {
        return new SaReactorFilter()
            .setAuth(obj -> {
                SaRouter.match("/**")
                    .notMatch(ignoreWhite.getWhites())
                    .check(r -> {
                        // âœ… Gatewayåœ¨è¿™é‡ŒéªŒè¯Token
                        StpUtil.checkLogin();
                        // âœ… éªŒè¯ClientId
                        // ...
                    });
            });
    }
}
```

---

## ğŸ“Š éªŒè¯æˆåŠŸçš„æ ‡å¿—

### Gatewayæ—¥å¿—
```
âœ… StpUtil.checkLogin() é€šè¿‡
âœ… ClientIdåŒ¹é…é€šè¿‡
âœ… [GATEWAY AUTH] è®¤è¯æˆåŠŸ
```

### Content Serviceæ—¥å¿—
```
ğŸ“‹ [HOMEPAGE] é¦–é¡µç”¨æˆ·åˆ—è¡¨æ¥å£è¢«è°ƒç”¨
   âœ… è®¤è¯æˆåŠŸ: userId=2000, username=app_tester, clientId=app
   âœ… è¿”å›ç”¨æˆ·æ•°é‡: 10
```

### æµ‹è¯•æ—¥å¿—
```
âœ… é˜¶æ®µ3æˆåŠŸ - å®Œæ•´ä¸šåŠ¡æµç¨‹é€šè¿‡ï¼
   âœ… Gatewayè·¯ç”±æˆåŠŸ
   âœ… Sa-Tokenè®¤è¯é€šè¿‡
   âœ… Content Serviceå“åº”æ­£å¸¸
   âœ… çœŸå®ä¸šåŠ¡æ¥å£å·¥ä½œæ­£å¸¸
```

---

## ğŸš€ ç°åœ¨é‡æ–°æµ‹è¯•

### 1. é‡å¯Content Service
```bash
# åœ¨IDEAä¸­é‡å¯ xypai-content
# æ–°ä»£ç å·²ç§»é™¤ @SaCheckLogin
```

### 2. è¿è¡Œæµ‹è¯•
```bash
cd RuoYi-Cloud-Plus/xypai-security/security-oauth
mvn test -Dtest=SimpleSaTokenTest
```

### 3. é¢„æœŸç»“æœ
```
âœ… é˜¶æ®µ1: ç”¨æˆ·ç™»å½•æˆåŠŸ
âœ… é˜¶æ®µ2: TokenéªŒè¯æˆåŠŸ
âœ… é˜¶æ®µ3: Gatewayè®¤è¯é€šè¿‡ + Content Serviceè¿”å›æ•°æ®
```

---

## ğŸ“ è®°ä½è¿™äº›è§„åˆ™

| åœºæ™¯ | æ˜¯å¦ä½¿ç”¨ @SaCheckLogin | åŸå›  |
|------|----------------------|------|
| Gateway | âœ… ä½¿ç”¨ StpUtil.checkLogin() | Gatewayè´Ÿè´£éªŒè¯æ‰€æœ‰Token |
| Content Service | âŒ ä¸ä½¿ç”¨ | JWT Simple Modeï¼Œä¿¡ä»»Gateway |
| Auth Service | âŒ ä¸ä½¿ç”¨ | è‡ªå·±å°±æ˜¯è®¤è¯æœåŠ¡ï¼Œä¸éœ€è¦éªŒè¯è‡ªå·± |
| å…¶ä»–å¾®æœåŠ¡ | âŒ ä¸ä½¿ç”¨ | éƒ½ä½¿ç”¨JWT Simple Mode |

---

## ğŸŠ æ ¸å¿ƒè¦ç‚¹

1. âœ… **Gatewayæ˜¯å”¯ä¸€çš„è®¤è¯ç‚¹** - æ‰€æœ‰TokenéªŒè¯åœ¨è¿™é‡Œå®Œæˆ
2. âœ… **ä¸‹æ¸¸æœåŠ¡ä¿¡ä»»Gateway** - ä¸é‡å¤éªŒè¯Token
3. âœ… **ä½¿ç”¨LoginHelperè·å–ç”¨æˆ·ä¿¡æ¯** - ä¸ä½¿ç”¨ @SaCheckLogin
4. âœ… **JWT Simple Mode** - æ— çŠ¶æ€ï¼Œæ€§èƒ½æ›´å¥½
5. âœ… **èŒè´£æ¸…æ™°** - Gatewayè®¤è¯ï¼ŒServiceä¸šåŠ¡

---

**ä¿®å¤æ—¶é—´**: 2025-11-08  
**æ¶æ„æ¨¡å¼**: JWT Simple Mode + Gateway Authentication  
**çŠ¶æ€**: ğŸŸ¢ Ready for Testing

