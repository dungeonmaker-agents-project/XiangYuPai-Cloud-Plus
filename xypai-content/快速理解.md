# XyPai-Content 内容服务快速理解

## 📌 核心定位
向娱拍内容服务，基于 Spring Cloud 微服务架构。

**本模块职责**：提供动态 Feed 流、评论系统、话题管理、互动功能（点赞/收藏/分享），直接连接 `xypai_content` 数据库，无 RPC 依赖。

## 🎯 主要功能
- **Feed 流**：关注 Tab + 热门 Tab + 同城 Tab（空间查询）
- **评论系统**：一级评论 + 二级回复 + 点赞 + 置顶
- **话题管理**：话题创建、关联、热度排序
- **互动功能**：点赞、收藏、分享 + 实时统计
- **内容举报**：举报动态/评论 + 审核流程

## 🏗️ 技术栈
```
Spring Boot 3.x + MyBatis Plus + Nacos + Elasticsearch
MySQL (xypai_content 数据库，9 张表) + Redis (缓存 + 热度计算)
```

## 📁 核心目录结构
```
xypai-content/
├── controller/
│   ├── FeedController.java            # Feed 流管理（发布/删除/查询）
│   ├── CommentController.java         # 评论系统（一级/二级）
│   ├── TopicController.java           # 话题管理（创建/关联）
│   ├── InteractionController.java     # 互动功能（点赞/收藏/分享）
│   └── ReportController.java          # 举报功能
├── service/impl/
│   ├── FeedServiceImpl.java           # Feed 服务（含推荐算法）
│   ├── CommentServiceImpl.java        # 评论服务（树形结构）
│   ├── TopicServiceImpl.java          # 话题服务（热度排序）
│   ├── InteractionServiceImpl.java    # 互动服务（统计更新）
│   └── ReportServiceImpl.java         # 举报服务
├── mapper/                             # MyBatis Plus Mapper（9 个）
│   ├── FeedMapper.java
│   ├── CommentMapper.java
│   └── ...
└── domain/
    ├── entity/                         # 实体类（9 张表）
    │   ├── Feed.java                  # 动态主表
    │   ├── FeedMedia.java             # 动态媒体（图片/视频）
    │   ├── Comment.java               # 评论表
    │   └── Like.java                  # 点赞表
    ├── dto/                            # 请求 DTO
    └── vo/                             # 响应 VO
```

## 🔑 核心接口

### Feed 流
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /content/feed` | 发布动态 | 支持图片（最多9张）/视频（1个） |
| `GET /content/feed/following` | 关注 Tab | 时间倒序 |
| `GET /content/feed/hot` | 热门 Tab | 热度算法排序 |
| `GET /content/feed/nearby` | 同城 Tab | 空间查询（基于经纬度） |
| `DELETE /content/feed/:id` | 删除动态 | 级联删除评论/点赞 |

### 评论系统
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /content/comment` | 发表评论 | 一级/二级回复 |
| `GET /content/comment/:feedId` | 评论列表 | 树形结构，二级前3条展开 |
| `DELETE /content/comment/:id` | 删除评论 | 级联删除二级回复 |
| `PUT /content/comment/:id/pin` | 置顶评论 | 仅作者可操作 |

### 互动功能
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /content/like/:feedId` | 点赞动态 | 幂等性处理 |
| `POST /content/collect/:feedId` | 收藏动态 | - |
| `POST /content/share/:feedId` | 分享动态 | 分享计数 +1 |
| `GET /content/like/my` | 我的点赞列表 | 分页 |

### 话题管理
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `GET /content/topic/hot` | 热门话题 | 热度排序（讨论数 + 关注数） |
| `GET /content/topic/:id/feeds` | 话题下的动态 | 时间倒序 |

## 💾 数据库：xypai_content（9 张表）
```sql
-- Feed 相关（3 张表）
feed                   # 动态主表（内容、位置、可见范围）
feed_media             # 动态媒体（图片/视频 URL）
feed_topic             # 动态-话题关联表

-- 评论（1 张表）
comment                # 评论表（parent_id 区分一级/二级）

-- 互动（3 张表）
like                   # 点赞表（用户-动态/评论）
content_collection     # 收藏表
share                  # 分享表

-- 话题（1 张表）
topic                  # 话题表（名称、热度、封面）

-- 举报（1 张表）
report                 # 举报表（类型、原因、状态）
```

## 🏛️ 微服务架构
```
┌─────────────────┐
│  App 客户端      │
└────────┬────────┘
         │ REST API
         ↓
┌─────────────────┐
│ xypai-content   │  ← 本模块（内容服务，独立运行）
│ (Feed/评论/互动) │
└────────┬────────┘
         │ MyBatis Plus
         ↓
┌─────────────────┐
│ xypai_content   │  ← MySQL 数据库（9 张表）
└─────────────────┘

         ↓ Elasticsearch（可选）
┌─────────────────┐
│ 内容搜索索引     │  ← Feed/话题全文搜索
└─────────────────┘
```

## 🔥 技术亮点
1. **三 Tab 设计**：关注流（时间序）+ 热门流（热度算法）+ 同城流（空间查询 Spatial Index）
2. **评论树形结构**：一级评论 + 二级回复，前 3 条二级自动展开，优化查询性能
3. **热度算法**：点赞数 × 1 + 评论数 × 2 + 分享数 × 3 + 时间衰减，实时计算热度
4. **幂等性设计**：点赞/收藏接口防重复提交（Redis + 唯一索引）
5. **Elasticsearch 集成**：Feed 内容全文搜索 + 话题搜索（可选开启）

## 📦 依赖关系
```
xypai-content (本模块，独立服务)
  ↓ MyBatis Plus
xypai_content 数据库 (9 张表)
  ↓ Elasticsearch（可选）
内容搜索索引
```

## 🚀 快速启动
```bash
# 1. 确保依赖服务已启动
#    - Nacos（服务注册中心）
#    - MySQL（xypai_content 数据库，导入 sql/xypai_content.sql）
#    - Redis（缓存 + 热度计算）
#    - Elasticsearch（可选，用于搜索功能）

# 2. 启动本服务
cd xypai-content
mvn clean package -DskipTests
java -jar target/xypai-content.jar

# 默认端口：9403
# Swagger UI: http://localhost:9403/doc.html
```

## 📌 注意事项
- **独立服务**：本模块不依赖其他微服务，可独立启动和运行
- **数据库初始化**：首次启动前需导入 `sql/xypai_content.sql` 创建 9 张表
- **媒体限制**：动态支持图片最多 9 张，视频最多 1 个
- **评论嵌套**：仅支持二级评论（一级评论 + 一级回复），不支持多级嵌套
- **话题关联**：一个动态最多关联 5 个话题
- **热度更新**：热度分数每 5 分钟异步计算一次（定时任务 + Redis）
- **Elasticsearch**：搜索功能为可选模块，不影响核心功能运行
- 所有接口返回统一格式 `R<T>` (code, message, data)
