<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xypai.chat.mapper.ChatConversationMapper">

    <!-- ========== 查询用户的会话列表 ========== -->
    <select id="selectUserConversations" resultType="com.xypai.chat.domain.entity.ChatConversation">
        SELECT DISTINCT c.*
        FROM chat_conversation c
        INNER JOIN chat_participant p ON c.id = p.conversation_id
        WHERE p.user_id = #{userId}
          AND p.status = 1
        <if test="type != null">
            AND c.type = #{type}
        </if>
        <if test="status != null">
            AND c.status = #{status}
        </if>
        ORDER BY 
            p.is_pinned DESC,
            c.last_message_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- ========== 查询私聊会话 ========== -->
    <select id="selectPrivateConversation" resultType="com.xypai.chat.domain.entity.ChatConversation">
        SELECT c.*
        FROM chat_conversation c
        WHERE c.type = 1
          AND c.status = 1
          AND EXISTS (
              SELECT 1 FROM chat_participant p1
              WHERE p1.conversation_id = c.id 
                AND p1.user_id = #{user1Id}
                AND p1.status = 1
          )
          AND EXISTS (
              SELECT 1 FROM chat_participant p2
              WHERE p2.conversation_id = c.id
                AND p2.user_id = #{user2Id}
                AND p2.status = 1
          )
        LIMIT 1
    </select>

    <!-- ========== 根据订单ID查询会话 ========== -->
    <select id="selectByOrderId" resultType="com.xypai.chat.domain.entity.ChatConversation">
        SELECT *
        FROM chat_conversation
        WHERE order_id = #{orderId}
          AND status = 1
        LIMIT 1
    </select>

    <!-- ========== 查询系统通知会话 ========== -->
    <select id="selectSystemNotificationConversation" resultType="com.xypai.chat.domain.entity.ChatConversation">
        SELECT c.*
        FROM chat_conversation c
        INNER JOIN chat_participant p ON c.id = p.conversation_id
        WHERE c.type = 3
          AND p.user_id = #{userId}
          AND p.status = 1
          AND c.status = 1
        LIMIT 1
    </select>

    <!-- ========== 更新最后活跃时间 ========== -->
    <update id="updateLastActiveTime">
        UPDATE chat_conversation
        SET updated_at = #{updateTime}
        WHERE id = #{conversationId}
    </update>

    <!-- ========== 批量更新会话状态 ========== -->
    <update id="batchUpdateStatus">
        UPDATE chat_conversation
        SET status = #{newStatus},
            updated_at = #{updateTime}
        WHERE id IN
        <foreach collection="conversationIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- ========== 查询需要归档的会话 ========== -->
    <select id="selectConversationsForAutoArchive" resultType="com.xypai.chat.domain.entity.ChatConversation">
        SELECT *
        FROM chat_conversation
        WHERE status = #{status}
          AND updated_at &lt; DATE_SUB(NOW(), INTERVAL #{inactiveDays} DAY)
        ORDER BY updated_at ASC
        LIMIT 100
    </select>

    <!-- ========== 搜索会话 ========== -->
    <select id="searchConversations" resultType="com.xypai.chat.domain.entity.ChatConversation">
        SELECT DISTINCT c.*
        FROM chat_conversation c
        INNER JOIN chat_participant p ON c.id = p.conversation_id
        WHERE p.user_id = #{userId}
          AND p.status = 1
        <if test="type != null">
            AND c.type = #{type}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                c.title LIKE CONCAT('%', #{keyword}, '%')
                OR c.description LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY c.updated_at DESC
        LIMIT #{limit}
    </select>

    <!-- ========== 查询用户会话统计 ========== -->
    <select id="selectUserConversationStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_conversations,
            SUM(CASE WHEN c.type = 1 THEN 1 ELSE 0 END) as private_count,
            SUM(CASE WHEN c.type = 2 THEN 1 ELSE 0 END) as group_count,
            SUM(CASE WHEN c.type = 3 THEN 1 ELSE 0 END) as system_count,
            SUM(CASE WHEN c.type = 4 THEN 1 ELSE 0 END) as order_count,
            SUM(p.unread_count) as total_unread,
            SUM(CASE WHEN p.unread_count > 0 THEN 1 ELSE 0 END) as unread_conversation_count
        FROM chat_participant p
        INNER JOIN chat_conversation c ON p.conversation_id = c.id
        WHERE p.user_id = #{userId}
          AND p.status = 1
          AND c.status = 1
    </select>

    <!-- ========== 查询热门群聊 ========== -->
    <select id="selectPopularGroupChats" resultType="java.util.Map">
        SELECT 
            c.id,
            c.title,
            c.avatar_url,
            c.member_count,
            c.total_message_count,
            COUNT(m.id) as recent_message_count
        FROM chat_conversation c
        LEFT JOIN chat_message m ON m.conversation_id = c.id
            AND m.created_at &gt; DATE_SUB(NOW(), INTERVAL #{days} DAY)
        WHERE c.type = 2
          AND c.status = 1
        GROUP BY c.id, c.title, c.avatar_url, c.member_count, c.total_message_count
        ORDER BY recent_message_count DESC, c.member_count DESC
        LIMIT #{limit}
    </select>

    <!-- ========== 查询用户创建的会话 ========== -->
    <select id="selectCreatedConversations" resultType="com.xypai.chat.domain.entity.ChatConversation">
        SELECT *
        FROM chat_conversation
        WHERE creator_id = #{creatorId}
        <if test="type != null">
            AND type = #{type}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- ========== 查询不活跃会话 ========== -->
    <select id="selectInactiveConversations" resultType="com.xypai.chat.domain.entity.ChatConversation">
        SELECT *
        FROM chat_conversation
        WHERE status = #{status}
          AND updated_at &lt; DATE_SUB(NOW(), INTERVAL #{days} DAY)
        ORDER BY updated_at ASC
        LIMIT 100
    </select>

</mapper>


