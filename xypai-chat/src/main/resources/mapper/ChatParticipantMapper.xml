<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xypai.chat.mapper.ChatParticipantMapper">

    <!-- ========== v7.1新增：增加未读数量（排除发送者） ========== -->
    <update id="incrementUnreadCountExcept">
        UPDATE chat_participant
        SET unread_count = unread_count + 1
        WHERE conversation_id = #{conversationId}
          AND user_id != #{excludeUserId}
          AND status = 1
    </update>

    <!-- ========== v7.1新增：更新已读位置 ========== -->
    <update id="updateReadPosition">
        UPDATE chat_participant
        SET last_read_message_id = #{messageId},
            last_read_time = #{readTime},
            unread_count = 0
        WHERE conversation_id = #{conversationId}
          AND user_id = #{userId}
    </update>

    <!-- ========== v7.1新增：更新置顶状态 ========== -->
    <update id="updatePinnedStatus">
        UPDATE chat_participant
        SET is_pinned = #{isPinned}
        WHERE conversation_id = #{conversationId}
          AND user_id = #{userId}
    </update>

    <!-- ========== v7.1新增：更新免打扰状态 ========== -->
    <update id="updateMutedStatus">
        UPDATE chat_participant
        SET is_muted = #{isMuted},
            mute_until = #{muteUntil}
        WHERE conversation_id = #{conversationId}
          AND user_id = #{userId}
    </update>

    <!-- ========== 查询会话参与者列表 ========== -->
    <select id="selectConversationParticipants" resultType="com.xypai.chat.domain.entity.ChatParticipant">
        SELECT *
        FROM chat_participant
        WHERE conversation_id = #{conversationId}
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY join_time ASC
    </select>

    <!-- ========== 查询用户参与的会话列表 ========== -->
    <select id="selectUserParticipations" resultType="com.xypai.chat.domain.entity.ChatParticipant">
        SELECT *
        FROM chat_participant
        WHERE user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY join_time DESC
    </select>

    <!-- ========== 查询用户在会话中的参与记录 ========== -->
    <select id="selectParticipant" resultType="com.xypai.chat.domain.entity.ChatParticipant">
        SELECT *
        FROM chat_participant
        WHERE conversation_id = #{conversationId}
          AND user_id = #{userId}
        LIMIT 1
    </select>

    <!-- ========== 检查是否为参与者 ========== -->
    <select id="isParticipant" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM chat_participant
        WHERE conversation_id = #{conversationId}
          AND user_id = #{userId}
          AND status = 1
    </select>

    <!-- ========== 统计参与者数量 ========== -->
    <select id="countParticipants" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM chat_participant
        WHERE conversation_id = #{conversationId}
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>

    <!-- ========== 批量插入参与者 ========== -->
    <insert id="batchInsertParticipants">
        INSERT INTO chat_participant 
            (conversation_id, user_id, role, join_time, status)
        VALUES
        <foreach collection="participants" item="p" separator=",">
            (#{p.conversationId}, #{p.userId}, #{p.role}, #{p.joinTime}, #{p.status})
        </foreach>
    </insert>

    <!-- ========== 批量更新参与者状态 ========== -->
    <update id="batchUpdateParticipantStatus">
        UPDATE chat_participant
        SET status = #{newStatus},
            leave_time = CASE WHEN #{newStatus} = 0 THEN NOW() ELSE leave_time END
        WHERE conversation_id = #{conversationId}
          AND user_id IN
        <foreach collection="userIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- ========== 更新最后已读时间 ========== -->
    <update id="updateLastReadTime">
        UPDATE chat_participant
        SET last_read_time = #{lastReadTime},
            unread_count = 0
        WHERE conversation_id = #{conversationId}
          AND user_id = #{userId}
    </update>

    <!-- ========== 查询管理员列表 ========== -->
    <select id="selectAdmins" resultType="com.xypai.chat.domain.entity.ChatParticipant">
        SELECT *
        FROM chat_participant
        WHERE conversation_id = #{conversationId}
          AND role IN (2, 3)
          AND status = 1
        ORDER BY role DESC, join_time ASC
    </select>

    <!-- ========== 查询群主 ========== -->
    <select id="selectOwner" resultType="com.xypai.chat.domain.entity.ChatParticipant">
        SELECT *
        FROM chat_participant
        WHERE conversation_id = #{conversationId}
          AND role = 3
          AND status = 1
        LIMIT 1
    </select>

    <!-- ========== 转让群主 ========== -->
    <update id="transferOwnership">
        UPDATE chat_participant
        SET role = CASE 
            WHEN user_id = #{oldOwnerId} THEN 1
            WHEN user_id = #{newOwnerId} THEN 3
            ELSE role
        END
        WHERE conversation_id = #{conversationId}
          AND user_id IN (#{oldOwnerId}, #{newOwnerId})
    </update>

    <!-- ========== 查询未读会话列表 ========== -->
    <select id="selectUnreadConversations" resultType="java.util.Map">
        SELECT 
            p.conversation_id,
            p.unread_count,
            c.type,
            c.title,
            c.avatar_url
        FROM chat_participant p
        INNER JOIN chat_conversation c ON p.conversation_id = c.id
        WHERE p.user_id = #{userId}
          AND p.unread_count > 0
          AND p.status = 1
          AND c.status = 1
        ORDER BY p.unread_count DESC
    </select>

    <!-- ========== 查询不活跃参与者 ========== -->
    <select id="selectInactiveParticipants" resultType="com.xypai.chat.domain.entity.ChatParticipant">
        SELECT *
        FROM chat_participant
        WHERE conversation_id = #{conversationId}
          AND status = 1
          AND last_read_time &lt; DATE_SUB(NOW(), INTERVAL #{days} DAY)
        ORDER BY last_read_time ASC
    </select>

    <!-- ========== 删除会话的所有参与者 ========== -->
    <delete id="deleteConversationParticipants">
        DELETE FROM chat_participant
        WHERE conversation_id = #{conversationId}
    </delete>

    <!-- ========== 查询参与者权限 ========== -->
    <select id="selectParticipantPermissions" resultType="java.util.Map">
        SELECT 
            user_id,
            role,
            status,
            is_muted,
            CASE 
                WHEN role = 3 THEN TRUE
                WHEN role = 2 THEN TRUE
                ELSE FALSE
            END as can_manage,
            CASE 
                WHEN status = 2 THEN FALSE
                ELSE TRUE
            END as can_speak
        FROM chat_participant
        WHERE conversation_id = #{conversationId}
          AND user_id = #{userId}
        LIMIT 1
    </select>

    <!-- ========== 统计用户会话数量 ========== -->
    <select id="selectUserConversationCount" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_count,
            SUM(CASE WHEN c.type = 1 THEN 1 ELSE 0 END) as private_count,
            SUM(CASE WHEN c.type = 2 THEN 1 ELSE 0 END) as group_count,
            SUM(CASE WHEN p.unread_count > 0 THEN 1 ELSE 0 END) as unread_conversation_count,
            SUM(p.unread_count) as total_unread_count
        FROM chat_participant p
        INNER JOIN chat_conversation c ON p.conversation_id = c.id
        WHERE p.user_id = #{userId}
          AND p.status = 1
          AND c.status = 1
        <if test="type != null">
            AND c.type = #{type}
        </if>
    </select>

    <!-- ========== 查询活跃参与者 ========== -->
    <select id="selectActiveParticipants" resultType="java.util.Map">
        SELECT 
            p.user_id,
            p.nickname,
            COUNT(m.id) as message_count,
            MAX(m.created_at) as last_message_time
        FROM chat_participant p
        LEFT JOIN chat_message m ON m.conversation_id = p.conversation_id 
            AND m.sender_id = p.user_id
            AND m.created_at &gt; DATE_SUB(NOW(), INTERVAL #{days} DAY)
        WHERE p.conversation_id = #{conversationId}
          AND p.status = 1
        GROUP BY p.user_id, p.nickname
        ORDER BY message_count DESC
        LIMIT #{limit}
    </select>

</mapper>


