# XyPai-User 用户服务快速理解

## 📌 核心定位
向娱拍用户服务，基于 Spring Cloud 微服务架构。

**本模块职责**：提供用户资料、社交关系、技能管理功能，直接连接 `xypai_user` 数据库，同时作为 Dubbo RPC Provider 为 `xypai-auth` 提供用户数据服务。

## 🎯 主要功能
- **用户资料管理**：11 个可编辑字段 + 实时保存
- **社交关系**：关注/取关、粉丝/关注列表、拉黑、举报
- **技能市场**：线上技能（游戏陪玩）+ 线下技能（本地服务）
- **RPC 服务**：为认证服务提供用户注册、登录、查询接口

## 🏗️ 技术栈
```
Spring Boot 3.x + MyBatis Plus + Dubbo RPC + Nacos
MySQL (xypai_user 数据库，9 张表) + Redis (缓存) + OSS (文件存储)
```

## 📁 核心目录结构
```
xypai-user/
├── controller/
│   ├── app/                                # App 端 API 控制器
│   │   ├── ProfileController.java         # 用户资料管理
│   │   ├── RelationController.java        # 社交关系（关注/拉黑/举报）
│   │   └── SkillController.java           # 技能管理（线上/线下）
│   └── feign/
│       └── RemoteAppUserServiceImpl.java  # Dubbo RPC Provider
├── service/impl/
│   ├── UserServiceImpl.java               # 用户服务（含 CRUD）
│   ├── RelationServiceImpl.java           # 关系服务（双向管理）
│   └── SkillServiceImpl.java              # 技能服务（空间查询）
├── mapper/                                 # MyBatis Plus Mapper（9 个）
│   ├── UserMapper.java
│   ├── UserRelationMapper.java
│   └── SkillMapper.java ...
└── domain/
    ├── entity/                             # 实体类（9 张表）
    ├── dto/                                # 请求 DTO
    └── vo/                                 # 响应 VO
```

## 🔑 核心接口

### 用户资料
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `GET /user/profile/me` | 获取我的资料 | 11 个可编辑字段 + JSON 扩展 |
| `PUT /user/profile/nickname` | 更新昵称 | - |
| `PUT /user/profile/avatar` | 更新头像 | OSS 上传 |
| `PUT /user/profile/birthday` | 更新生日 | - |

### 社交关系
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /user/relation/follow/:userId` | 关注用户 | 双向统计更新 |
| `DELETE /user/relation/unfollow/:userId` | 取消关注 | - |
| `GET /user/relation/followers` | 粉丝列表 | 分页 |
| `POST /user/relation/block/:userId` | 拉黑用户 | - |
| `POST /user/relation/report` | 举报用户 | 举报类型 + 原因 |

### 技能管理
| 接口 | 说明 | 特殊字段 |
|------|------|----------|
| `POST /user/skill/online` | 创建线上技能 | 游戏类型、段位、价格 |
| `POST /user/skill/offline` | 创建线下技能 | 服务类型、经纬度、可用时间 |
| `GET /user/skill/my` | 我的技能列表 | - |

## 💾 数据库：xypai_user（9 张表）
```sql
-- 用户相关（3 张表）
xy_user                # 用户主表（33 字段 + 8 个 JSON 扩展字段）
user_stats             # 用户统计（关注数、粉丝数、技能数等）
user_relation          # 关注关系（双向记录）

-- 社交相关（2 张表）
user_blacklist         # 黑名单
user_report            # 举报记录

-- 技能相关（4 张表）
skill                  # 技能主表（线上/线下区分）
skill_image            # 技能图片
skill_promise          # 技能承诺（陪玩保证）
skill_available_time   # 可用时间段（线下技能）
```

## 🏛️ 微服务架构
```
┌─────────────────┐
│  xypai-auth     │  ← 认证服务（无数据库）
│  (认证 API)     │
└────────┬────────┘
         │ Dubbo RPC 调用
         │ RemoteAppUserService
         ↓
┌─────────────────┐
│  xypai-user     │  ← 本模块（用户服务）
│  (用户 CRUD)    │
└────────┬────────┘
         │ MyBatis Plus
         ↓
┌─────────────────┐
│ xypai_user      │  ← MySQL 数据库（9 张表）
└─────────────────┘
```

## 🔥 技术亮点
1. **Dubbo RPC Provider**：为 `xypai-auth` 提供用户注册、登录、查询等 13 个远程接口
2. **MyBatis Plus**：LambdaQueryWrapper 无 XML 开发，9 个 Mapper 零 XML 配置
3. **双向统计管理**：关注/取关自动更新双方的粉丝数和关注数
4. **技能市场设计**：线上技能（游戏陪玩）+ 线下技能（本地服务 + 空间查询）
5. **JSON 扩展字段**：8 个 JSON 字段避免频繁修表（profile_json, stats_json, wallet_json 等）

## 📦 依赖关系
```
xypai-auth (认证服务)
  ↓ Dubbo RPC 调用
xypai-user (本模块) ← 实现 xypai-api-appuser 接口
  ↓ MyBatis Plus
xypai_user 数据库 (9 张表)
```

## 🚀 快速启动
```bash
# 1. 确保依赖服务已启动
#    - Nacos（服务注册中心）
#    - MySQL（xypai_user 数据库，导入 sql/xypai_user.sql）
#    - Redis（缓存）
#    - OSS（文件存储，可选）

# 2. 启动本服务
cd xypai-user
mvn clean package -DskipTests
java -jar target/xypai-user.jar

# 默认端口：9401
# Swagger UI: http://localhost:9401/doc.html
```

## 📌 注意事项
- **直接连接数据库**：本模块直接连接 `xypai_user` 数据库，包含 9 张表
- **Dubbo RPC Provider**：必须先启动本服务，`xypai-auth` 才能正常调用
- **数据库初始化**：首次启动前需导入 `sql/xypai_user.sql` 创建表结构
- `xy_user` 表有 8 个 JSON 扩展字段，存储非结构化数据
- 社交关系采用双向统计，关注/取关会同时更新两个用户的统计数据
- 线下技能支持空间查询（基于经纬度查找附近服务）
- 所有接口返回统一格式 `R<T>` (code, message, data)
