# 01-é¦–é¡µFeedæµé¡µé¢ - æ¥å£æœåŠ¡æ˜ å°„

## ğŸ“Œ é¡µé¢æ¦‚è¿°

**é¡µé¢åç§°**: é¦–é¡µFeedæµ
**è·¯ç”±è·¯å¾„**: `/home` æˆ– `/`
**æ ¸å¿ƒåŠŸèƒ½**: å±•ç¤ºæ¨èç”¨æˆ·å¡ç‰‡åˆ—è¡¨ï¼ˆçº¿ä¸Š/çº¿ä¸‹ä¸¤ç§Tabï¼‰

---

## ğŸ”— æ¥å£æœåŠ¡æ˜ å°„

### æ¥å£1: è·å–é¦–é¡µFeedæµ

| å±æ€§ | å€¼ |
|------|-----|
| **æ¥å£** | `GET /api/home/feed` |
| **æ‰€å±æœåŠ¡** | `xypai-app-bff` (èšåˆæœåŠ¡å±‚) |
| **ç«¯å£** | 9400 |
| **æ˜¯å¦æœ‰æ•°æ®åº“** | âŒ æ— ï¼Œé€šè¿‡ RPC è°ƒç”¨å…¶ä»–æœåŠ¡ |
| **æ•°æ®æ¥æº** | xypai-user (ç”¨æˆ·ä¿¡æ¯) + xypai-content (åŠ¨æ€ç»Ÿè®¡) |
| **æµ‹è¯•æ–‡ä»¶** | `xypai-app-bff/src/test/java/.../AppHomeFeedTest.java` |

**è¯·æ±‚å‚æ•°:**
```typescript
{
  type: 'online' | 'offline';  // Tabç±»å‹
  pageNum: number;              // é¡µç 
  pageSize: number;             // æ¯é¡µæ•°é‡
  cityCode?: string;            // åŸå¸‚ä»£ç 
  districtCode?: string;        // åŒºåŸŸä»£ç 
}
```

**BFF èšåˆé€»è¾‘:**
```
App â†’ GET /api/home/feed
      â†“
xypai-app-bff (èšåˆå±‚)
      â”œâ”€ RPC: xypai-user.getUsersByFilter()     // è·å–ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·åˆ—è¡¨
      â”œâ”€ RPC: xypai-user.getUserSkills()         // è·å–ç”¨æˆ·æŠ€èƒ½ä¿¡æ¯
      â”œâ”€ RPC: xypai-content.getUserActivityCount() // è·å–ç”¨æˆ·åŠ¨æ€æ•°
      â””â”€ ç®—æ³•: calculateDistance() + rankByScore() // è·ç¦»è®¡ç®— + æ¨èæ’åº
      â†“
è¿”å›èšåˆç»“æœ (UserCardVO[])
```

---

### æ¥å£2: å…³æ³¨/å–æ¶ˆå…³æ³¨ç”¨æˆ·

| å±æ€§ | å€¼ |
|------|-----|
| **æ¥å£** | `POST /api/user/relation/follow/{userId}` (å…³æ³¨) |
| | `DELETE /api/user/relation/follow/{userId}` (å–æ¶ˆå…³æ³¨) |
| **æ‰€å±æœåŠ¡** | `xypai-user` (ç”¨æˆ·é¢†åŸŸæœåŠ¡) |
| **ç«¯å£** | 9401 |
| **æ˜¯å¦æœ‰æ•°æ®åº“** | âœ… æœ‰ï¼Œxypai_user æ•°æ®åº“ |
| **æ•°æ®è¡¨** | `user_relation` |
| **æµ‹è¯•æ–‡ä»¶** | `xypai-user/src/test/java/.../AppFollowingListPageTest.java` |

**ä¸ºä»€ä¹ˆåœ¨ xypai-user è€Œä¸æ˜¯ BFF?**
- å…³æ³¨/å–æ¶ˆå…³æ³¨æ˜¯**ç”¨æˆ·é¢†åŸŸçš„æ ¸å¿ƒä¸šåŠ¡æ“ä½œ**
- æ¶‰åŠæ•°æ®åº“å†™æ“ä½œï¼ˆå†™å…¥ user_relation è¡¨ï¼‰
- éµå¾ª DDD åŸåˆ™ï¼šé¢†åŸŸæ“ä½œåº”åœ¨é¢†åŸŸæœåŠ¡ä¸­å®Œæˆ
- BFF å±‚åªè´Ÿè´£**è¯»å–èšåˆ**ï¼Œä¸è´Ÿè´£**å†™å…¥æ“ä½œ**

---

## ğŸ“Š æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        App å®¢æˆ·ç«¯                           â”‚
â”‚                   01-é¦–é¡µFeedæµé¡µé¢                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                â”‚
           â”‚ GET /api/home/feed            â”‚ POST /api/user/relation/follow
           â”‚ (è·å–ç”¨æˆ·æ¨èåˆ—è¡¨)              â”‚ (å…³æ³¨ç”¨æˆ·)
           â†“                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   xypai-app-bff      â”‚         â”‚    xypai-user        â”‚
â”‚   (èšåˆæœåŠ¡å±‚)        â”‚         â”‚    (ç”¨æˆ·é¢†åŸŸæœåŠ¡)     â”‚
â”‚   ç«¯å£: 9400         â”‚         â”‚    ç«¯å£: 9401        â”‚
â”‚                      â”‚         â”‚                      â”‚
â”‚   âŒ æ— æ•°æ®åº“        â”‚         â”‚   âœ… xypai_user åº“   â”‚
â”‚   ä»… RPC è°ƒç”¨        â”‚         â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                   â”‚
         â”‚ Feign RPC                         â”‚ MyBatis Plus
         â†“                                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   xypai-user (9401)  â”‚         â”‚     MySQL            â”‚
â”‚   xypai-content(9403)â”‚         â”‚   xypai_user æ•°æ®åº“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   - user_relation è¡¨ â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### xypai-app-bff æµ‹è¯• (AppHomeFeedTest.java)

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|
| ç”¨æˆ·ç™»å½• | âœ… | å‡†å¤‡æµ‹è¯• Token |
| çº¿ä¸Šç”¨æˆ·æ¨èåˆ—è¡¨ | âœ… | `type=online` |
| çº¿ä¸‹ç”¨æˆ·æ¨èåˆ—è¡¨ | âœ… | `type=offline` |
| åˆ†é¡µåŠ è½½ | âœ… | `pageNum=2` |
| åŸå¸‚ç­›é€‰ | âœ… | `cityCode=440300` |

### xypai-user æµ‹è¯• (AppFollowingListPageTest.java)

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|
| å…³æ³¨ç”¨æˆ· | âœ… | `POST /follow/{userId}` |
| å–æ¶ˆå…³æ³¨ | âœ… | `DELETE /follow/{userId}` |
| è·å–å…³æ³¨åˆ—è¡¨ | âœ… | åˆ†é¡µæŸ¥è¯¢ |
| æœç´¢å…³æ³¨åˆ—è¡¨ | âœ… | å…³é”®è¯æœç´¢ |

---

## ğŸ“ å¼€å‘æŒ‡å¼•

### å¦‚æœéœ€è¦åœ¨é¦–é¡µæ˜¾ç¤ºå…³æ³¨æŒ‰é’®çŠ¶æ€

å‰ç«¯éœ€è¦è°ƒç”¨ä¸¤ä¸ªæ¥å£ï¼š
1. `GET /api/home/feed` â†’ è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆä» BFFï¼‰
2. BFF å†…éƒ¨è°ƒç”¨ `xypai-user` è·å–å…³æ³¨çŠ¶æ€ï¼Œå¹¶åœ¨è¿”å›çš„ `UserCardVO` ä¸­åŒ…å« `isFollowed` å­—æ®µ

### BFF èšåˆç¤ºä¾‹

```java
// xypai-app-bff/service/HomeFeedBizService.java
public List<UserCardVO> getHomeFeed(String type, Long currentUserId) {
    // 1. è·å–æ¨èç”¨æˆ·åˆ—è¡¨
    List<Long> recommendedUserIds = recommendationEngine.recommend(type);

    // 2. æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯ (RPC)
    List<UserProfile> users = userClient.getUserProfiles(recommendedUserIds);

    // 3. æ‰¹é‡è·å–å…³æ³¨çŠ¶æ€ (RPC)
    Map<Long, Boolean> followStatus = userClient.getFollowStatus(currentUserId, recommendedUserIds);

    // 4. æ‰¹é‡è·å–åŠ¨æ€ç»Ÿè®¡ (RPC)
    Map<Long, Integer> feedCounts = contentClient.getUserFeedCounts(recommendedUserIds);

    // 5. èšåˆè¿”å›
    return aggregate(users, followStatus, feedCounts);
}
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä½ç½® | è¯´æ˜ |
|------|------|------|
| é¡µé¢æ–‡æ¡£ | `XiangYuPai-Doc/.../01-é¦–é¡µFeedæµé¡µé¢.md` | å‰ç«¯éœ€æ±‚æ–‡æ¡£ |
| BFF æµ‹è¯• | `xypai-app-bff/.../AppHomeFeedTest.java` | èšåˆæ¥å£æµ‹è¯• |
| User æµ‹è¯• | `xypai-user/.../AppFollowingListPageTest.java` | å…³æ³¨åŠŸèƒ½æµ‹è¯• |
| BFF å¿«é€Ÿç†è§£ | `xypai-aggregation/å¿«é€Ÿç†è§£.md` | èšåˆå±‚æ–‡æ¡£ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-20
**ç»´æŠ¤è€…**: XyPai åç«¯å›¢é˜Ÿ
