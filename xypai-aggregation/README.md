# XyPai-Aggregation èšåˆæœåŠ¡å±‚

## æ¦‚è¿°

å‘å¨±æ‹å¹³å°çš„ä¸šåŠ¡èšåˆå±‚ï¼ˆBFF - Backend For Frontendï¼‰ï¼Œè´Ÿè´£è·¨æœåŠ¡ä¸šåŠ¡ç¼–æ’ã€æ•°æ®èšåˆå’Œå¤æ‚ç®—æ³•å®ç°ã€‚

## æ¶æ„è®¾è®¡

### BFF æ¨¡å¼ï¼ˆBackend For Frontendï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å®¢æˆ·ç«¯å±‚ (Client Layer)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   App å®¢æˆ·ç«¯  â”‚  Web å®¢æˆ·ç«¯   â”‚  Admin åå°    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚                â”‚
       â†“               â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ xypai-app-bffâ”‚ â”‚ xypai-web-bffâ”‚ â”‚xypai-admin-  â”‚
â”‚   (9400)     â”‚ â”‚   (9410)     â”‚ â”‚   bff (9420) â”‚ èšåˆå±‚
â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ Feign/Dubbo RPC
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“              â†“               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ xypai-  â”‚   â”‚ xypai-  â”‚    â”‚ xypai-  â”‚
    â”‚  user   â”‚   â”‚ content â”‚    â”‚  order  â”‚  é¢†åŸŸæœåŠ¡å±‚
    â”‚ (9401)  â”‚   â”‚ (9403)  â”‚    â”‚ (9405)  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚             â”‚              â”‚
       MySQL         MySQL          MySQL      æ•°æ®åº“å±‚
```

## æ¨¡å—åˆ—è¡¨

### 1. xypai-app-bff (9400) âœ… å·²å®ç°
**ç”¨é€”**ï¼šä¸º App å®¢æˆ·ç«¯æä¾›èšåˆæ¥å£

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- é¦–é¡µç”¨æˆ·æ¨èæµï¼ˆçº¿ä¸Š/çº¿ä¸‹ï¼‰
- å‘ç°é¡µå†…å®¹èšåˆ
- ç”¨æˆ·ä¸»é¡µå®Œæ•´ä¿¡æ¯èšåˆ
- è®¢å•è¯¦æƒ…èšåˆ

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- æ¨èç®—æ³•å¼•æ“
- æ‰¹é‡ RPC è°ƒç”¨ä¼˜åŒ–
- Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®

### 2. xypai-web-bff (9410) â³ å¾…å®ç°
**ç”¨é€”**ï¼šä¸º Web ç«¯æä¾›èšåˆæ¥å£ï¼ˆPC ç½‘ç«™ï¼‰

**è®¡åˆ’åŠŸèƒ½**ï¼š
- é¦–é¡µå¤§å±å±•ç¤º
- SEO ä¼˜åŒ–æ•°æ®èšåˆ
- Web ä¸“ç”¨æ¨èç®—æ³•

### 3. xypai-admin-bff (9420) â³ å¾…å®ç°
**ç”¨é€”**ï¼šä¸ºåå°ç®¡ç†ç³»ç»Ÿæä¾›èšåˆæ¥å£

**è®¡åˆ’åŠŸèƒ½**ï¼š
- æ•°æ®çœ‹æ¿èšåˆ
- ç»Ÿè®¡æŠ¥è¡¨ç”Ÿæˆ
- æ‰¹é‡ç®¡ç†æ“ä½œ

## ä¸ºä»€ä¹ˆéœ€è¦ BFF å±‚ï¼Ÿ

### é—®é¢˜ï¼šä¼ ç»Ÿå¾®æœåŠ¡æ¶æ„çš„ç—›ç‚¹

```
âŒ å‰ç«¯éœ€è¦è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡
App â†’ GET /user/profile/{id}        (xypai-user)
    â†’ GET /content/feeds?userId={id} (xypai-content)
    â†’ GET /order/list?userId={id}    (xypai-order)
    â†’ GET /user/stats/{id}           (xypai-user)

ç»“æœï¼š
- 4 æ¬¡ HTTP è¯·æ±‚
- ç½‘ç»œå¾€è¿”å»¶è¿Ÿé«˜
- å‰ç«¯é€»è¾‘å¤æ‚
- æ•°æ®å†—ä½™ï¼ˆç”¨æˆ·æœåŠ¡è°ƒç”¨ 2 æ¬¡ï¼‰
```

### è§£å†³æ–¹æ¡ˆï¼šBFF èšåˆå±‚

```
âœ… å‰ç«¯åªè°ƒç”¨ä¸€ä¸ªèšåˆæ¥å£
App â†’ GET /api/profile/{id}/full (xypai-app-bff)
      â†“
      BFF å†…éƒ¨èšåˆï¼š
      â”œâ”€ RPC: xypai-user.getProfile()
      â”œâ”€ RPC: xypai-user.getStats()
      â”œâ”€ RPC: xypai-content.getUserFeeds()
      â””â”€ RPC: xypai-order.getUserOrders()
      â†“
      è¿”å›èšåˆç»“æœ

ç»“æœï¼š
- 1 æ¬¡ HTTP è¯·æ±‚ âœ…
- é™ä½ç½‘ç»œå»¶è¿Ÿ âœ…
- å‰ç«¯é€»è¾‘ç®€åŒ– âœ…
- åç«¯æ‰¹é‡ä¼˜åŒ– âœ…
```

## æŠ€æœ¯ç‰¹ç‚¹

### 1. èŒè´£åˆ†ç¦»

| å±‚çº§ | èŒè´£ | ç¤ºä¾‹ |
|------|------|------|
| **BFF å±‚** | ä¸šåŠ¡ç¼–æ’ã€æ•°æ®èšåˆã€ç®—æ³•å®ç° | æ¨èå¼•æ“ã€æ•°æ®ç»„åˆ |
| **é¢†åŸŸå±‚** | é¢†åŸŸä¸šåŠ¡é€»è¾‘ã€æ•°æ® CRUD | ç”¨æˆ· CRUDã€è®¢å•çŠ¶æ€æœº |
| **åŸºç¡€è®¾æ–½å±‚** | é€šç”¨èƒ½åŠ› | è®¤è¯ã€OSSã€é€šçŸ¥ |

### 2. æ— æ•°æ®åº“è®¾è®¡

BFF å±‚**ä¸ç›´æ¥è®¿é—®æ•°æ®åº“**ï¼Œæ‰€æœ‰æ•°æ®é€šè¿‡ RPC è·å–ï¼š
- âœ… ä¿æŒé¢†åŸŸæœåŠ¡ç‹¬ç«‹æ€§
- âœ… é¿å…æ•°æ®åº“è¿æ¥æµªè´¹
- âœ… å¼ºåˆ¶æœåŠ¡è¾¹ç•Œæ¸…æ™°

### 3. æ‰¹é‡ä¼˜åŒ–

```java
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼šå¾ªç¯è°ƒç”¨ï¼ˆN æ¬¡ RPCï¼‰
List<User> users = new ArrayList<>();
for (Long userId : userIds) {
    users.add(userClient.getUser(userId));  // N æ¬¡ç½‘ç»œè°ƒç”¨
}

// âœ… BFF ä¼˜åŒ–ï¼šæ‰¹é‡è°ƒç”¨ï¼ˆ1 æ¬¡ RPCï¼‰
List<User> users = userClient.getUserBatch(userIds);  // 1 æ¬¡ç½‘ç»œè°ƒç”¨
```

### 4. ç¼“å­˜ç­–ç•¥

```
çƒ­ç‚¹æ•°æ®ç¼“å­˜ï¼ˆRedisï¼‰ï¼š
- é¦–é¡µæ¨èåˆ—è¡¨ï¼š5 åˆ†é’Ÿ
- ç”¨æˆ·ç”»åƒï¼š30 åˆ†é’Ÿ
- çƒ­é—¨å†…å®¹ï¼š10 åˆ†é’Ÿ
```

## å¼€å‘è§„èŒƒ

### 1. å‘½åè§„èŒƒ

```
æ¨¡å—å‘½åï¼šxypai-{client}-bff
  - xypai-app-bff     (App ç«¯)
  - xypai-web-bff     (Web ç«¯)
  - xypai-admin-bff   (åå°ç«¯)

æ¥å£è·¯å¾„ï¼š/api/{ä¸šåŠ¡åŸŸ}/{æ“ä½œ}
  - GET  /api/home/feed           (é¦–é¡µæ¨è)
  - GET  /api/profile/{id}/full   (ç”¨æˆ·ä¸»é¡µèšåˆ)
  - POST /api/order/create        (åˆ›å»ºè®¢å•èšåˆ)
```

### 2. ä»£ç ç»“æ„

```
xypai-xxx-bff/
â”œâ”€â”€ controller/     # èšåˆæ¥å£ï¼ˆé¢å‘å‰ç«¯ï¼‰
â”œâ”€â”€ service/        # ä¸šåŠ¡ç¼–æ’é€»è¾‘
â”œâ”€â”€ client/         # Feign å®¢æˆ·ç«¯ï¼ˆRPC è°ƒç”¨ï¼‰
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ dto/        # è¯·æ±‚ DTO
â”‚   â””â”€â”€ vo/         # èšåˆå“åº” VO
â””â”€â”€ ğŸš« NO mapper/   # ä¸å…è®¸ç›´æ¥è®¿é—®æ•°æ®åº“ï¼
```

### 3. RPC è°ƒç”¨è§„èŒƒ

```java
// âœ… æ­£ç¡®ï¼šé€šè¿‡ Feign å®¢æˆ·ç«¯è°ƒç”¨
@Autowired
private UserServiceClient userClient;

public UserFullVO getUserFull(Long userId) {
    UserProfile profile = userClient.getProfile(userId);
    UserStats stats = userClient.getStats(userId);
    return aggregate(profile, stats);
}

// âŒ é”™è¯¯ï¼šç›´æ¥æ³¨å…¥ Mapper
@Autowired
private UserMapper userMapper;  // ä¸å…è®¸ï¼BFF å±‚ä¸èƒ½è®¿é—®æ•°æ®åº“
```

## å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

1. å·²å¯åŠ¨åŸºç¡€è®¾æ–½ï¼š
   - Nacos (8848)
   - Redis (6379)

2. å·²å¯åŠ¨é¢†åŸŸæœåŠ¡ï¼š
   - xypai-user (9401)
   - xypai-content (9403)
   - xypai-order (9405)
   - xypai-payment (9406)

### å¯åŠ¨ App BFF

```bash
cd xypai-aggregation/xypai-app-bff
mvn clean package -DskipTests
java -jar target/xypai-app-bff.jar

# è®¿é—® Swagger
http://localhost:9400/doc.html
```

## æ–‡æ¡£

- [xypai-aggregation å¿«é€Ÿç†è§£](./å¿«é€Ÿç†è§£.md)
- [xypai-app-bff å¿«é€Ÿç†è§£](./xypai-app-bff/å¿«é€Ÿç†è§£.md)

## ç›¸å…³èµ„æ–™

- [BFF æ¨¡å¼è¯¦è§£](https://www.thoughtworks.com/insights/blog/bff-soundcloud)
- [å¾®æœåŠ¡èšåˆæ¨¡å¼](https://microservices.io/patterns/data/api-composition.html)
- [Spring Cloud OpenFeign](https://spring.io/projects/spring-cloud-openfeign)

---

**æœ€åæ›´æ–°**: 2025-11-20
**ç»´æŠ¤å›¢é˜Ÿ**: XiangYuPai åç«¯å›¢é˜Ÿ
