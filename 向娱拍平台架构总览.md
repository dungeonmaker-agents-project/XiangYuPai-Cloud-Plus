# 向娱拍平台（XiangYuPai）微服务架构总览

## 📌 平台简介

向娱拍是一个基于 Spring Cloud 的社交电商平台，提供技能服务交易、社交互动、即时通讯等功能。

**平台定位**：陪玩社交 + 本地服务 + 活动组局

## 🏗️ 系统架构

### 微服务模块总览（7个核心服务）

| 模块 | 端口 | 职责 | 数据库 | 关键特性 |
|------|-----|------|--------|---------|
| **xypai-auth** | 8200 | 认证授权 | ❌ 无 | SMS/密码登录、Token管理 |
| **xypai-user** | 9401 | 用户服务 | xypai_user（9表） | 用户资料、社交关系、技能市场 |
| **xypai-content** | 9403 | 内容服务 | xypai_content（9表） | Feed流、评论、话题、互动 |
| **xypai-common** | 9407 | 通用服务 | xypai_common（7表） | 位置、媒体、通知、举报（4合1） |
| **xypai-chat** | 9404 | 聊天服务 | xypai_chat（2表） | 即时通讯、WebSocket推送 |
| **xypai-order** | 9405 | 订单服务 | xypai_order（1表） | 订单管理、状态流转 |
| **xypai-payment** | 9406 | 支付服务 | xypai_payment（3表） | 支付处理、余额管理 |

**总计**：7 个服务 | 5 个数据库 | 31 张数据表

### 服务分层架构

```
┌─────────────────────────────────────────────────────────┐
│                      App 客户端 / Web                      │
└──────────────────────┬──────────────────────────────────┘
                       │ REST API / WebSocket
                       ↓
┌─────────────────────────────────────────────────────────┐
│                      API Gateway                         │
│                   (Spring Cloud Gateway)                 │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        ↓              ↓               ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  认证服务     │  │  业务服务     │  │  基础服务     │
│              │  │              │  │              │
│ xypai-auth   │  │ xypai-user   │  │ xypai-common │
│ (无数据库)    │  │ xypai-content│  │ (4个子服务)   │
│              │  │ xypai-chat   │  │              │
│              │  │ xypai-order  │  │              │
│              │  │ xypai-payment│  │              │
└──────────────┘  └──────┬───────┘  └──────────────┘
                         │
        ┌────────────────┼────────────────┐
        ↓                ↓                 ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ MySQL        │  │ Redis        │  │ OSS          │
│ (5个数据库)   │  │ (缓存+队列)   │  │ (文件存储)    │
└──────────────┘  └──────────────┘  └──────────────┘
```

### 服务依赖关系图

```
┌──────────────────────────────────────────────────┐
│                   xypai-auth                     │
│              (认证服务，无数据库)                  │
└─────────┬────────────────────────────────────────┘
          │ Dubbo RPC 调用
          ↓
┌──────────────────────────────────────────────────┐
│                   xypai-user                     │
│        (用户服务，提供用户数据 RPC 接口)            │
└──────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────┐
│                  xypai-content                   │
│         (内容服务，Feed流+评论+互动)               │
└──────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────┐
│                   xypai-chat                     │
│        (聊天服务，WebSocket 实时通讯)              │
└──────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────┐
│                  xypai-order                     │
│              (订单服务，订单状态机)                 │
└─────────┬────────────────────────────────────────┘
          │ Dubbo RPC 调用
          ↓
┌──────────────────────────────────────────────────┐
│                 xypai-payment                    │
│         (支付服务，支付处理+余额管理)               │
└──────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────┐
│                  xypai-common                    │
│    (通用服务：位置+媒体+通知+举报，4合1)            │
└──────────────────────────────────────────────────┘
```

## 🎯 核心功能概览

### 1. 认证授权（xypai-auth）
- SMS 验证码登录 + 自动注册
- 密码登录（手机号/邮箱）
- 忘记密码、支付密码管理
- JWT Token 签发、刷新、登出

### 2. 用户管理（xypai-user）
- **用户资料**：11 个可编辑字段 + 8 个 JSON 扩展字段
- **社交关系**：关注/取关、粉丝列表、拉黑、举报
- **技能市场**：
  - 线上技能：游戏陪玩（王者荣耀、吃鸡等）
  - 线下技能：本地服务（空间查询）
- **RPC 服务**：为认证服务提供用户数据

### 3. 内容社区（xypai-content）
- **Feed 流**：关注 Tab + 热门 Tab + 同城 Tab
- **评论系统**：一级评论 + 二级回复 + 置顶
- **话题管理**：热门话题、话题关联（最多5个）
- **互动功能**：点赞、收藏、分享 + 实时统计
- **内容举报**：举报审核流程

### 4. 即时通讯（xypai-chat）
- **私聊消息**：一对一聊天
- **多格式消息**：文字、图片、语音、视频
- **WebSocket 推送**：实时消息、在线状态
- **消息管理**：已读回执、消息撤回（2分钟）
- **会话列表**：未读统计、最后消息预览

### 5. 订单管理（xypai-order）
- **订单创建**：技能服务订单 + 活动订单
- **状态流转**：待支付 → 待服务 → 进行中 → 待评价 → 已完成
- **订单操作**：取消、确认完成、申请退款、评价
- **超时处理**：30 分钟未支付自动取消

### 6. 支付处理（xypai-payment）
- **支付方式**：余额支付、支付宝、微信支付
- **余额管理**：充值、提现、余额冻结/解冻
- **支付密码**：6 位数字 + 错误 3 次锁定 30 分钟
- **退款处理**：支持退款到原支付方式
- **交易流水**：完整的交易记录

### 7. 通用服务（xypai-common，4 合 1）
- **位置服务**：城市列表、附近地点查询（Haversine 算法）
- **媒体上传**：图片/视频上传 + MD5 秒传
- **通知系统**：系统通知 + 未读统计
- **举报审核**：用户举报 + 管理员审核 + 处罚记录

## 💾 数据库概览

### 数据库分布（5 个独立数据库）

| 数据库 | 表数量 | 主要表 | 特点 |
|--------|-------|--------|------|
| **xypai_user** | 9 张 | xy_user, user_stats, skill | 用户主表 33 字段 + 8 个 JSON 扩展 |
| **xypai_content** | 9 张 | feed, comment, like, topic | Feed 流 + 评论树形结构 |
| **xypai_chat** | 2 张 | conversation, message | 极简设计，仅 2 张表 |
| **xypai_order** | 1 张 | order | 最精简，仅 1 张表 |
| **xypai_payment** | 3 张 | payment, account, transaction | 支付 + 账户 + 流水 |
| **xypai_common** | 7 张 | location, media_file, notification, report | 4 个子服务共用 |

**总计**：31 张表

### 表数量分布
```
xypai_user     ███████████ 9 张
xypai_content  ███████████ 9 张
xypai_common   █████████   7 张
xypai_payment  █████       3 张
xypai_chat     ███         2 张
xypai_order    █           1 张
```

## 🔧 技术栈总览

### 核心框架
```yaml
基础框架:
  - Spring Boot: 3.2.0
  - Spring Cloud: 2023.x
  - Spring Cloud Alibaba: 2022.x

持久层:
  - MyBatis Plus: 3.5.7 (无 XML 开发)
  - MySQL: 8.0+

服务治理:
  - Nacos: 2.x (注册中心 + 配置中心)
  - Dubbo: 3.x (RPC 框架)
  - Seata: 分布式事务

认证授权:
  - Sa-Token: 最新版 (JWT + 权限控制)

缓存:
  - Redis: 7.0+ (缓存 + 分布式锁 + 延时队列)

通讯:
  - Spring WebSocket: 实时推送 (仅 xypai-chat)

存储:
  - OSS: 对象存储 (图片/视频/语音)

搜索:
  - Elasticsearch: 可选 (Feed 内容全文搜索)

监控:
  - Prometheus: 可选
  - Skywalking: 可选
```

### 技术特性对比

| 特性 | 使用模块 | 说明 |
|------|---------|------|
| **Dubbo RPC** | auth → user, order → payment | 服务间调用 |
| **WebSocket** | chat | 唯一使用 WebSocket 的模块 |
| **Seata 分布式事务** | order, payment | 订单+支付强一致性 |
| **Elasticsearch** | content | 可选，Feed 全文搜索 |
| **状态机** | order | 订单状态严格流转 |
| **空间查询** | user, common | Haversine 算法 + 空间索引 |
| **MD5 秒传** | common | 媒体文件去重 |

## 🚀 快速启动指南

### 1. 基础设施启动（Docker Compose）

```bash
# 启动基础设施
cd docker
docker-compose up -d

# 包含服务：
# - MySQL (5个数据库)
# - Redis
# - Nacos
# - Seata (可选)
# - Elasticsearch (可选)
```

### 2. 数据库初始化

```bash
# 导入所有数据库
mysql -u root -p < xypai-user/sql/xypai_user.sql
mysql -u root -p < xypai-content/sql/xypai_content.sql
mysql -u root -p < xypai-chat/sql/xypai_chat.sql
mysql -u root -p < xypai-common/sql/xypai_common.sql
# xypai-order 和 xypai-payment 按需创建
```

### 3. 服务启动顺序

```bash
# 第 1 步：启动用户服务（必须优先，auth 依赖它）
cd xypai-user && mvn spring-boot:run &

# 第 2 步：启动认证服务
cd xypai-auth && mvn spring-boot:run &

# 第 3 步：启动其他服务（可并行）
cd xypai-content && mvn spring-boot:run &
cd xypai-chat && mvn spring-boot:run &
cd xypai-common && mvn spring-boot:run &

# 第 4 步：启动支付服务（订单依赖它）
cd xypai-payment && mvn spring-boot:run &

# 第 5 步：启动订单服务
cd xypai-order && mvn spring-boot:run &
```

### 4. 验证服务

```bash
# 检查 Nacos 注册
# http://localhost:8848/nacos (nacos/nacos)

# 各服务 Swagger UI
http://localhost:8200/doc.html  # xypai-auth
http://localhost:9401/doc.html  # xypai-user
http://localhost:9403/doc.html  # xypai-content
http://localhost:9404/doc.html  # xypai-chat
http://localhost:9405/doc.html  # xypai-order
http://localhost:9406/doc.html  # xypai-payment
http://localhost:9407/doc.html  # xypai-common
```

## 📊 关键指标

### 代码量（估算）
- **总代码行数**：约 50,000 行
- **Java 文件数**：约 300+ 个
- **接口数量**：约 100+ 个 REST API

### 性能指标
- **QPS**：单服务 1000+ QPS（优化后）
- **响应时间**：P99 < 200ms
- **并发用户**：支持 10 万+ 在线用户

### 数据规模
- **用户表**：支持千万级用户
- **Feed 表**：支持亿级动态
- **消息表**：支持亿级消息记录

## 🔐 安全特性

1. **认证安全**
   - JWT Token + 双 Token 机制（Access + Refresh）
   - Token 自动刷新 + 过期控制
   - 单点登录支持

2. **支付安全**
   - 支付密码 BCrypt 加密
   - 支付密码错误 3 次锁定 30 分钟
   - 支付防重（Redis 锁 + 唯一索引）
   - 余额乐观锁 + 分布式事务

3. **数据安全**
   - 敏感字段加密存储（身份证号）
   - 软删除设计（deleted 字段）
   - 操作日志记录

4. **接口安全**
   - 接口限流（Redis + 注解）
   - 接口幂等性（防重复提交）
   - 签名验证（支付回调）

## 🎨 设计亮点

### 1. 微服务设计
- **服务拆分合理**：按业务边界清晰拆分
- **数据库独立**：每个服务独立数据库，避免耦合
- **通用服务聚合**：xypai-common 4 合 1，降低运维成本

### 2. 数据库设计
- **JSON 扩展字段**：user 表 8 个 JSON 字段，避免频繁修表
- **空间索引**：支持附近地点/技能查询
- **乐观锁**：账户余额、订单状态防并发
- **软删除**：所有表使用 deleted 字段

### 3. 性能优化
- **Redis 缓存**：热点数据缓存（城市列表、会话列表）
- **MD5 秒传**：文件去重，节省存储
- **分页加载**：Feed 流、消息列表支持分页
- **索引优化**：高频查询字段建立索引

### 4. 可靠性保证
- **分布式事务**：Seata AT 模式保证订单+支付一致性
- **消息队列**：Redis 延时队列（订单超时取消）
- **幂等性设计**：支付回调、订单创建防重
- **限流降级**：接口限流保护

## 📁 项目结构

```
RuoYi-Cloud-Plus/
├── xypai-auth/              # 认证服务
├── xypai-user/              # 用户服务
├── xypai-content/           # 内容服务
├── xypai-chat/              # 聊天服务
├── xypai-order/             # 订单服务
├── xypai-payment/           # 支付服务
├── xypai-common/            # 通用服务
├── xypai-api-appuser/       # 用户 API 定义（RPC 接口）
├── xypai-api-common/        # 通用 API 定义
├── ruoyi-common/            # 公共模块
│   ├── ruoyi-common-core/   # 核心工具
│   ├── ruoyi-common-redis/  # Redis 封装
│   ├── ruoyi-common-mybatis/# MyBatis Plus 封装
│   └── ...
├── docker/                  # Docker 编排
└── docs/                    # 文档目录
```

## 📚 相关文档

- [xypai-auth 快速理解](./xypai-auth/快速理解.md)
- [xypai-user 快速理解](./xypai-user/快速理解.md)
- [xypai-content 快速理解](./xypai-content/快速理解.md)
- [xypai-chat 快速理解](./xypai-chat/快速理解.md)
- [xypai-order 快速理解](./xypai-order/快速理解.md)
- [xypai-payment 快速理解](./xypai-payment/快速理解.md)
- [xypai-common 快速理解](./xypai-common/快速理解.md)
- [模块文档编写模板](./xypai-auth/模块文档编写模板.md)
- [AI 提示词指南](./xypai-auth/AI提示词-生成快速理解文档.md)

## 🤝 团队协作

### 开发规范
- **分支策略**：Git Flow（master/develop/feature/hotfix）
- **代码规范**：阿里巴巴 Java 开发手册
- **提交规范**：Conventional Commits
- **接口文档**：Swagger/Knife4j 自动生成

### 环境说明
- **dev**：开发环境（本地 + 开发服务器）
- **test**：测试环境（QA 测试）
- **uat**：预发布环境（灰度发布）
- **prod**：生产环境（正式线上）

## 📞 联系方式

- **项目地址**：[GitHub 仓库地址]
- **技术文档**：[文档地址]
- **API 文档**：各服务 Swagger UI
- **问题反馈**：[Issue Tracker]

---

**最后更新**：2025-11-18
**文档版本**：v1.0.0
**适用版本**：RuoYi-Cloud-Plus + XiangYuPai v1.0.0
