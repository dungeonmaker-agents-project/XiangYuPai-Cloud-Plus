# ğŸ¯ Same-Token æœ€ç»ˆéªŒè¯æ­¥éª¤

> **æ—¥æœŸ**: 2025-11-09  
> **çŠ¶æ€**: å‡†å¤‡éªŒè¯  
> **ç›®æ ‡**: éªŒè¯Same-Tokené—®é¢˜å·²å®Œå…¨è§£å†³

---

## ğŸ“‹ éªŒè¯å‰å‡†å¤‡

### 1. ç¡®è®¤ä¿®æ”¹çš„æ–‡ä»¶

#### Gatewayæ¨¡å—
- âœ… `ruoyi-gateway/src/main/java/org/dromara/gateway/config/SameTokenInitializer.java`
- âœ… `ruoyi-gateway/src/main/java/org/dromara/gateway/filter/ForwardAuthFilter.java`

#### é€šç”¨å®‰å…¨æ¨¡å—
- âœ… `ruoyi-common/ruoyi-common-security/src/main/java/org/dromara/common/security/config/SecurityConfiguration.java`
- âœ… `ruoyi-common/ruoyi-common-security/src/main/java/org/dromara/common/security/config/SameTokenInitializer.java` (æ–°å¢)

---

## ğŸš€ éªŒè¯æ­¥éª¤

### Step 1: åœæ­¢æ‰€æœ‰æœåŠ¡

```powershell
# åœæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„æœåŠ¡
# Gateway, Content, Auth, User ç­‰
```

### Step 2: æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘

```powershell
cd E:\Users\Administrator\Documents\GitHub\RuoYi-Cloud-Plus

# æ¸…ç†å¹¶ç¼–è¯‘Gateway
mvn clean compile -pl ruoyi-gateway

# æ¸…ç†å¹¶ç¼–è¯‘å…¬å…±æ¨¡å—
mvn clean compile -pl ruoyi-common/ruoyi-common-security

# æ¸…ç†å¹¶ç¼–è¯‘ContentæœåŠ¡
mvn clean compile -pl xypai-content
```

### Step 3: å¯åŠ¨æœåŠ¡ (æŒ‰é¡ºåº)

#### 3.1 å¯åŠ¨Gateway

```powershell
cd E:\Users\Administrator\Documents\GitHub\RuoYi-Cloud-Plus
mvn spring-boot:run -pl ruoyi-gateway
```

**æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—**:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” [SAME-TOKEN INIT] å¼€å§‹åˆå§‹åŒ–Same-Token
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   âœ… é€šè¿‡Sa-Token APIç”ŸæˆSame-Token: Ia2nUsOD2rnE5mrzeTXCROEA9qhr0pZqfs9Yvt477s5...
   ğŸ“‹ Sa-Tokenå·²è‡ªåŠ¨å­˜å‚¨åˆ°Redis
   ğŸ” éªŒè¯ï¼šä»Sa-Token APIè¯»å–: Ia2nUsOD2rnE5mrzeTXCROEA9qhr0pZqfs9Yvt477s5...
   âœ… éªŒè¯æˆåŠŸï¼šSame-Tokenæ­£ç¡®å­˜å‚¨
   ğŸ“‹ åŒæ—¶å­˜å‚¨åˆ°Redis Key: satoken:var:same-token
   â° æœ‰æ•ˆæœŸ: 7 å¤©
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‰ [SAME-TOKEN INIT] Same-Tokenåˆå§‹åŒ–å®Œæˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

âœ… **éªŒè¯ç‚¹**: 
- çœ‹åˆ° "ğŸ‰ Same-Tokenåˆå§‹åŒ–å®Œæˆ"
- è®°ä¸‹Tokenå€¼ (å‰30ä¸ªå­—ç¬¦)

#### 3.2 å¯åŠ¨ContentæœåŠ¡

```powershell
cd E:\Users\Administrator\Documents\GitHub\RuoYi-Cloud-Plus
mvn spring-boot:run -pl xypai-content
```

**æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—**:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” [SAME-TOKEN INIT] å¾®æœåŠ¡å¯åŠ¨ï¼šåˆå§‹åŒ–Same-Token
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   âœ… ä»Redisè¯»å–åˆ°Gatewayç”Ÿæˆçš„Same-Token
   ğŸ“‹ Tokenå€¼: Ia2nUsOD2rnE5mrzeTXCROEA9qhr0pZqfs9Yvt477s5...
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‰ [SAME-TOKEN INIT] å¾®æœåŠ¡Same-Tokenåˆå§‹åŒ–å®Œæˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

âœ… **éªŒè¯ç‚¹**:
- çœ‹åˆ° "âœ… ä»Redisè¯»å–åˆ°Gatewayç”Ÿæˆçš„Same-Token"
- Tokenå€¼ä¸Gatewayçš„ä¸€è‡´

#### 3.3 å¯åŠ¨AuthæœåŠ¡ (å¦‚æœéœ€è¦)

```powershell
cd E:\Users\Administrator\Documents\GitHub\RuoYi-Cloud-Plus
mvn spring-boot:run -pl xypai-security/security-oauth
```

### Step 4: è¿è¡Œæµ‹è¯•

```powershell
cd E:\Users\Administrator\Documents\GitHub\RuoYi-Cloud-Plus\xypai-security\security-oauth
mvn test -Dtest=SimpleSaTokenTest#testCompleteAuthenticationFlow
```

**æœŸæœ›ç»“æœ**: æµ‹è¯•é€šè¿‡ âœ…

### Step 5: æŸ¥çœ‹ContentæœåŠ¡éªŒè¯æ—¥å¿—

åœ¨ContentæœåŠ¡çš„æ—¥å¿—ä¸­ï¼Œåº”è¯¥çœ‹åˆ°:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” [SAME-TOKEN CHECK] å¼€å§‹éªŒè¯è¯·æ±‚æ˜¯å¦æ¥è‡ªGateway
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š [CONTENT REDIS] Redisè¿æ¥ä¿¡æ¯:
   ConnectionFactory: RedissonConnectionFactory
   Redis Key: satoken:var:same-token
   Redisä¸­çš„Same-Token: Ia2nUsOD2rnE5mrzeTXCROEA9qhr0pZqfs9Yvt477s5...
   è¯·æ±‚ä¸­çš„Same-Token: Ia2nUsOD2rnE5mrzeTXCROEA9qhr0pZqfs9Yvt477s5...
   ä¸¤è€…æ˜¯å¦ä¸€è‡´: true
   ğŸ” å¼€å§‹éªŒè¯Same-Token (è‡ªå®šä¹‰éªŒè¯é€»è¾‘)
   âœ… Same-TokenéªŒè¯é€šè¿‡ (è‡ªå®šä¹‰éªŒè¯)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ [HOMEPAGE CONTROLLER] âœ… è¯·æ±‚æˆåŠŸåˆ°è¾¾Controllerï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

âœ… **å…³é”®éªŒè¯ç‚¹**:
1. âœ… Redisä¸­çš„tokenä¸è¯·æ±‚ä¸­çš„tokenä¸€è‡´
2. âœ… Same-TokenéªŒè¯é€šè¿‡ (è‡ªå®šä¹‰éªŒè¯)
3. âœ… è¯·æ±‚æˆåŠŸåˆ°è¾¾Controller

### Step 6: æ‰‹åŠ¨æµ‹è¯• (å¯é€‰)

ä½¿ç”¨Postmanæˆ–curl:

```bash
# 1. ç™»å½•è·å–token
curl -X POST http://localhost:9100/xypai-auth/oauth/login/sms/verify \
  -H "Content-Type: application/json" \
  -H "clientId: app" \
  -d '{
    "phoneNumber": "13800138000",
    "code": "123456"
  }'

# 2. ä½¿ç”¨è¿”å›çš„tokenè¯·æ±‚é¦–é¡µæ¥å£
curl -X GET "http://localhost:9100/xypai-content/api/v1/homepage/users/list?page=1&pageSize=10" \
  -H "Authorization: Bearer <YOUR_JWT_TOKEN>" \
  -H "clientId: app"
```

**æœŸæœ›ç»“æœ**:

```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "users": [...],
    "total": 100
  }
}
```

---

## âœ… éªŒè¯æ¸…å•

### Gatewayå¯åŠ¨éªŒè¯

- [ ] Gatewayå¯åŠ¨æˆåŠŸ
- [ ] çœ‹åˆ° "ğŸ” [SAME-TOKEN INIT] å¼€å§‹åˆå§‹åŒ–Same-Token"
- [ ] çœ‹åˆ° "âœ… é€šè¿‡Sa-Token APIç”ŸæˆSame-Token"
- [ ] çœ‹åˆ° "âœ… éªŒè¯æˆåŠŸï¼šSame-Tokenæ­£ç¡®å­˜å‚¨"
- [ ] çœ‹åˆ° "ğŸ“‹ åŒæ—¶å­˜å‚¨åˆ°Redis Key: satoken:var:same-token"
- [ ] çœ‹åˆ° "ğŸ‰ [SAME-TOKEN INIT] Same-Tokenåˆå§‹åŒ–å®Œæˆ"
- [ ] è®°å½•Tokenå€¼: `____________________`

### ContentæœåŠ¡å¯åŠ¨éªŒè¯

- [ ] ContentæœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] çœ‹åˆ° "ğŸ” [SAME-TOKEN INIT] å¾®æœåŠ¡å¯åŠ¨ï¼šåˆå§‹åŒ–Same-Token"
- [ ] çœ‹åˆ° "âœ… ä»Redisè¯»å–åˆ°Gatewayç”Ÿæˆçš„Same-Token"
- [ ] Tokenå€¼ä¸Gatewayçš„ä¸€è‡´: â˜‘ï¸
- [ ] çœ‹åˆ° "ğŸ‰ [SAME-TOKEN INIT] å¾®æœåŠ¡Same-Tokenåˆå§‹åŒ–å®Œæˆ"

### è¯·æ±‚éªŒè¯

- [ ] æµ‹è¯•é€šè¿‡: `mvn test -Dtest=SimpleSaTokenTest#testCompleteAuthenticationFlow`
- [ ] ContentæœåŠ¡æ—¥å¿—æ˜¾ç¤º "ğŸ” [SAME-TOKEN CHECK] å¼€å§‹éªŒè¯"
- [ ] ContentæœåŠ¡æ—¥å¿—æ˜¾ç¤º "ä¸¤è€…æ˜¯å¦ä¸€è‡´: true"
- [ ] ContentæœåŠ¡æ—¥å¿—æ˜¾ç¤º "âœ… Same-TokenéªŒè¯é€šè¿‡ (è‡ªå®šä¹‰éªŒè¯)"
- [ ] ContentæœåŠ¡æ—¥å¿—æ˜¾ç¤º "ğŸ¯ [HOMEPAGE CONTROLLER] âœ… è¯·æ±‚æˆåŠŸåˆ°è¾¾Controllerï¼"
- [ ] è¿”å›HTTP 200å’Œæ­£ç¡®çš„æ•°æ®

---

## âŒ å¦‚æœéªŒè¯å¤±è´¥

### åœºæ™¯1: Gatewayå¯åŠ¨å¤±è´¥

**å¯èƒ½åŸå› **:
- Redisæœªå¯åŠ¨
- Redisè¿æ¥é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```powershell
# æ£€æŸ¥Redis
redis-cli ping
# åº”è¯¥è¿”å›: PONG

# æ£€æŸ¥Redisé…ç½®
# 01A_xyp_doc/nacos/application-common.yml
spring:
  data:
    redis:
      host: 198.18.0.1
      port: 6379
      database: 0
```

### åœºæ™¯2: ContentæœåŠ¡å¯åŠ¨æ—¶æ‰¾ä¸åˆ°Same-Token

**æ—¥å¿—**:
```
âš ï¸ [SAME-TOKEN INIT] Redisä¸­æ²¡æœ‰Same-Token
   åŸå› ï¼šGatewayå¯èƒ½æœªå¯åŠ¨æˆ–Same-Tokenæœªç”Ÿæˆ
```

**è§£å†³æ–¹æ¡ˆ**:
1. å…ˆå¯åŠ¨Gateway
2. ç¡®è®¤Gatewayæ—¥å¿—æ˜¾ç¤º "Same-Tokenåˆå§‹åŒ–å®Œæˆ"
3. å†å¯åŠ¨ContentæœåŠ¡

### åœºæ™¯3: éªŒè¯å¤±è´¥

**æ—¥å¿—**:
```
âŒ Same-TokenéªŒè¯å¤±è´¥
   æœŸæœ›: Ia2nUs...
   å®é™…: XYZ789...
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥Gatewayå’ŒContentæœåŠ¡çš„Tokenå€¼æ˜¯å¦ä¸€è‡´
2. æ£€æŸ¥Redis databaseé…ç½®æ˜¯å¦éƒ½æ˜¯0
3. é‡å¯Gatewayå’ŒContentæœåŠ¡

### åœºæ™¯4: è¯·æ±‚æœªåˆ°è¾¾Controller

**æ—¥å¿—**:
```
âŒ Same-TokenéªŒè¯å¤±è´¥: Same-Tokenä¸åŒ¹é…
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥Gatewayçš„ForwardAuthFilteræ˜¯å¦æ­£ç¡®æ·»åŠ Same-Tokenåˆ°è¯·æ±‚å¤´
2. æ£€æŸ¥ContentæœåŠ¡çš„SecurityConfigurationæ˜¯å¦æ­£ç¡®éªŒè¯
3. æŸ¥çœ‹å®Œæ•´çš„é”™è¯¯æ—¥å¿—

---

## ğŸ“Š éªŒè¯å®Œæˆå

### 1. è®°å½•Tokenå€¼

```
Gatewayç”Ÿæˆçš„Same-Token: ______________________________
Contentè¯»å–çš„Same-Token: ______________________________
æ˜¯å¦ä¸€è‡´: â˜‘ï¸
```

### 2. è®°å½•æµ‹è¯•ç»“æœ

```
æµ‹è¯•æ—¶é—´: 2025-11-09 __:__:__
æµ‹è¯•ç»“æœ: âœ… é€šè¿‡ / âŒ å¤±è´¥
HTTPçŠ¶æ€ç : ____
å“åº”æ—¶é—´: ____ ms
```

### 3. æä¾›å®Œæ•´æ—¥å¿—

å¦‚æœéªŒè¯æˆåŠŸï¼Œè¯·æä¾›:
- âœ… Gatewayå¯åŠ¨æ—¥å¿— (SameTokenInitializeréƒ¨åˆ†)
- âœ… ContentæœåŠ¡å¯åŠ¨æ—¥å¿— (SameTokenInitializeréƒ¨åˆ†)
- âœ… ContentæœåŠ¡è¯·æ±‚éªŒè¯æ—¥å¿— (SecurityConfigurationéƒ¨åˆ†)
- âœ… æµ‹è¯•ç»“æœæˆªå›¾

---

## ğŸ‰ éªŒè¯æˆåŠŸæ ‡å¿—

çœ‹åˆ°ä»¥ä¸‹æ‰€æœ‰æ—¥å¿—ï¼Œè¯´æ˜é—®é¢˜å·²å®Œå…¨è§£å†³:

```
Gateway:
âœ… ğŸ‰ [SAME-TOKEN INIT] Same-Tokenåˆå§‹åŒ–å®Œæˆ

ContentæœåŠ¡:
âœ… ğŸ‰ [SAME-TOKEN INIT] å¾®æœåŠ¡Same-Tokenåˆå§‹åŒ–å®Œæˆ

ContentæœåŠ¡ (è¯·æ±‚éªŒè¯):
âœ… âœ… Same-TokenéªŒè¯é€šè¿‡ (è‡ªå®šä¹‰éªŒè¯)
âœ… ğŸ¯ [HOMEPAGE CONTROLLER] âœ… è¯·æ±‚æˆåŠŸåˆ°è¾¾Controllerï¼

æµ‹è¯•:
âœ… Tests run: 1, Failures: 0, Errors: 0, Skipped: 0
âœ… BUILD SUCCESS
```

---

**éªŒè¯æ—¶é—´**: 2025-11-09  
**é¢„æœŸç»“æœ**: âœ… æ‰€æœ‰éªŒè¯é€šè¿‡ï¼Œé—®é¢˜å®Œå…¨è§£å†³

