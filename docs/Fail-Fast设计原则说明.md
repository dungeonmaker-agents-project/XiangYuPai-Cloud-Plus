# Fail-Fast è®¾è®¡åŸåˆ™åœ¨ Same-Token ä¸­çš„åº”ç”¨

> **æ—¥æœŸ**: 2025-11-08  
> **ä½œè€…**: å¼€å‘å›¢é˜Ÿ  
> **ç‰ˆæœ¬**: v2.0 (Fail-Fastç‰ˆæœ¬)

---

## ğŸ“š èƒŒæ™¯

åœ¨ä¿®å¤Same-Tokené—®é¢˜æ—¶ï¼Œæˆ‘ä»¬æœ€åˆé‡‡ç”¨äº†"é™çº§å¤„ç†"çš„ç­–ç•¥ï¼šå¦‚æœRedisä¸­æ²¡æœ‰tokenï¼Œå°±ä¸´æ—¶ç”Ÿæˆä¸€ä¸ªã€‚

**ç”¨æˆ·çš„è´¨ç–‘** âœ…ï¼š
> "æˆ‘ä»¬æ˜¯å¦åº”è¯¥å…³æ³¨å¹¶ä¿®å¤Redisç›¸å…³é—®é¢˜ï¼Œè€Œä¸æ˜¯åœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ªæœ¬åœ°çš„é™çº§å¤„ç†ï¼Ÿ"

è¿™ä¸ªè´¨ç–‘æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼å®ƒä½“ç°äº†ä¼˜ç§€çš„å·¥ç¨‹å®è·µåŸåˆ™ï¼š**Fail-Fastï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰**ã€‚

---

## âŒ é”™è¯¯çš„è®¾è®¡ (v1.0)

### ä»£ç å®ç°

```java
// âŒ é”™è¯¯ï¼šé™çº§å¤„ç†
String sameToken = RedisUtils.getCacheObject(redisKey);

if (sameToken == null) {
    log.error("âŒ æ— æ³•ä»Redisè¯»å–Same-Token");
    // é™çº§å¤„ç†ï¼šç”Ÿæˆä¸´æ—¶token
    sameToken = SaSameUtil.getToken();  // â† æ©ç›–é—®é¢˜
    log.warn("âš ï¸ ä½¿ç”¨ä¸´æ—¶ç”Ÿæˆçš„tokenï¼Œå¯èƒ½å¯¼è‡´éªŒè¯å¤±è´¥");
}
```

### é—®é¢˜åˆ†æ

| é—®é¢˜ç±»å‹ | å…·ä½“å½±å“ |
|---------|---------|
| **éšè—çœŸæ­£çš„é—®é¢˜** | Redisè¿æ¥å¤±è´¥è¢«"ä¸´æ—¶token"æ©ç›– |
| **å»¶è¿Ÿé”™è¯¯å‘ç°** | å¯åŠ¨æ—¶ä¸æŠ¥é”™ï¼Œè¿è¡Œæ—¶æ‰å‘ç°401é”™è¯¯ |
| **éš¾ä»¥è°ƒè¯•** | å¼€å‘è€…ä¸çŸ¥é“æ ¹æœ¬åŸå› æ˜¯Redisé—®é¢˜ |
| **è¿åé¢„æœŸ** | ç³»ç»Ÿ"å¸¦ç—…è¿è¡Œ"ï¼Œç”¨æˆ·ä½“éªŒå·® |
| **ç”Ÿäº§é£é™©** | é—®é¢˜å¯èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒæ‰æš´éœ² |

### æµç¨‹å›¾

```
å¯åŠ¨é˜¶æ®µ:
  SameTokenInitializerå¤±è´¥
    â†“
  âŒ åªè®°å½•é”™è¯¯æ—¥å¿—
    â†“
  âœ… Gatewayç»§ç»­å¯åŠ¨  â† çœ‹èµ·æ¥"æˆåŠŸ"

è¿è¡Œé˜¶æ®µ:
  ç”¨æˆ·å‘èµ·è¯·æ±‚
    â†“
  ForwardAuthFilterå‘ç°Redisæ— token
    â†“
  âŒ ç”Ÿæˆä¸´æ—¶tokenï¼ˆæ¯æ¬¡éƒ½ä¸åŒï¼‰
    â†“
  å¾®æœåŠ¡éªŒè¯å¤±è´¥
    â†“
  âŒ è¿”å›401é”™è¯¯  â† ç”¨æˆ·å›°æƒ‘ï¼šä¸ºä»€ä¹ˆå¤±è´¥ï¼Ÿ
```

---

## âœ… æ­£ç¡®çš„è®¾è®¡ (v2.0 - Fail-Fast)

### Fail-Fast åŸåˆ™

> **æ ¸å¿ƒæ€æƒ³**: å¦‚æœç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œï¼Œåº”è¯¥ç«‹å³å¤±è´¥ï¼Œè€Œä¸æ˜¯å°è¯•"ç»•è¿‡"é—®é¢˜ã€‚

### ä»£ç å®ç°

#### 1. SameTokenInitializer (å¯åŠ¨æ£€æŸ¥)

```java
@Override
public void run(ApplicationArguments args) {
    try {
        // åˆå§‹åŒ–Same-Token
        String sameToken = SaSameUtil.getToken();
        RedisUtils.setCacheObject(SAME_TOKEN_KEY, sameToken, SAME_TOKEN_TTL);
        
        // éªŒè¯å­˜å‚¨
        String verifyToken = RedisUtils.getCacheObject(SAME_TOKEN_KEY);
        if (verifyToken == null || !verifyToken.equals(sameToken)) {
            throw new RuntimeException("Same-Tokenåˆå§‹åŒ–å¤±è´¥ï¼šæ— æ³•å­˜å‚¨åˆ°Redis");
        }
        
        log.info("âœ… Same-Tokenåˆå§‹åŒ–æˆåŠŸ");
        
    } catch (Exception e) {
        log.error("âŒ Same-Tokenåˆå§‹åŒ–å¤±è´¥: {}", e.getMessage());
        log.error("âš ï¸  Gatewayæ— æ³•å¯åŠ¨ï¼Œè¯·æ£€æŸ¥Redisè¿æ¥é…ç½®");
        
        // âœ… Fail-Fastï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè®©åº”ç”¨å¯åŠ¨å¤±è´¥
        throw new IllegalStateException(
            "Same-Tokenåˆå§‹åŒ–å¤±è´¥ï¼ŒGatewayæ— æ³•å¯åŠ¨ã€‚è¯·æ£€æŸ¥Redisè¿æ¥é…ç½®ã€‚", e
        );
    }
}
```

#### 2. ForwardAuthFilter (è¿è¡Œæ—¶æ£€æŸ¥)

```java
@Override
public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
    String redisKey = "satoken:var:same-token";
    String sameToken = RedisUtils.getCacheObject(redisKey);
    
    // âœ… Fail-Fastï¼šå¦‚æœRedisä¸­æ²¡æœ‰tokenï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸
    if (sameToken == null) {
        String errorMsg = String.format(
            "âŒ [SAME-TOKEN] Redisä¸­æ²¡æœ‰Same-Tokenï¼" +
            "\n   å¯èƒ½åŸå› ï¼š" +
            "\n   1. SameTokenInitializeræœªæ‰§è¡Œ" +
            "\n   2. Redisè¿æ¥å¤±è´¥" +
            "\n   3. Same-Tokenå·²è¿‡æœŸ" +
            "\n   è§£å†³æ–¹æ¡ˆï¼šé‡å¯GatewayæœåŠ¡"
        );
        log.error(errorMsg);
        throw new IllegalStateException("Same-Tokenæœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥Gatewayå¯åŠ¨æ—¥å¿—");
    }
    
    // ç»§ç»­å¤„ç†è¯·æ±‚
    // ...
}
```

### æµç¨‹å›¾

```
å¯åŠ¨é˜¶æ®µ:
  SameTokenInitializeræ‰§è¡Œ
    â†“
  å°è¯•åˆå§‹åŒ–Same-Token
    â”œâ”€ âœ… æˆåŠŸ â†’ Gatewayå¯åŠ¨æˆåŠŸ
    â””â”€ âŒ å¤±è´¥ â†’ æŠ›å‡ºå¼‚å¸¸ï¼ŒGatewayå¯åŠ¨å¤±è´¥
                   â†“
                 âŒ åº”ç”¨æ— æ³•å¯åŠ¨
                   â†“
                 å¼€å‘è€…ç«‹å³å‘ç°é—®é¢˜
                   â†“
                 ä¿®å¤Redisé…ç½®
                   â†“
                 é‡æ–°å¯åŠ¨
```

---

## ğŸ“Š ä¸¤ç§è®¾è®¡å¯¹æ¯”

| ç»´åº¦ | é™çº§å¤„ç† (v1.0) | Fail-Fast (v2.0) |
|-----|----------------|------------------|
| **å¯åŠ¨è¡Œä¸º** | âŒ å³ä½¿Rediså¤±è´¥ä¹Ÿå¯åŠ¨ | âœ… Rediså¤±è´¥åˆ™å¯åŠ¨å¤±è´¥ |
| **é”™è¯¯å‘ç°æ—¶æœº** | â° è¿è¡Œæ—¶ï¼ˆç”¨æˆ·è¯·æ±‚æ—¶ï¼‰ | âœ… å¯åŠ¨æ—¶ |
| **é”™è¯¯ä¿¡æ¯** | âš ï¸ ä¸æ˜ç¡®ï¼ˆ401é”™è¯¯ï¼‰ | âœ… æ˜ç¡®çš„å¯åŠ¨å¤±è´¥ä¿¡æ¯ |
| **è°ƒè¯•éš¾åº¦** | âŒ é«˜ï¼ˆéœ€è¦æ’æŸ¥æ—¥å¿—ï¼‰ | âœ… ä½ï¼ˆå¯åŠ¨æ—¥å¿—ç›´æ¥æ˜¾ç¤ºï¼‰ |
| **ç”¨æˆ·ä½“éªŒ** | âŒ å·®ï¼ˆè¯·æ±‚å¤±è´¥ï¼‰ | âœ… å¥½ï¼ˆæœåŠ¡ä¸å¯ç”¨æ¯”æ—¶å¥½æ—¶åå¥½ï¼‰ |
| **ç”Ÿäº§é£é™©** | âŒ é«˜ | âœ… ä½ |

---

## ğŸ¯ Fail-Fast çš„ä¼˜åŠ¿

### 1. ç«‹å³å‘ç°é—®é¢˜

```
âŒ é™çº§å¤„ç†:
  å¯åŠ¨ â†’ çœ‹èµ·æ¥æˆåŠŸ â†’ è¿è¡Œ â†’ 401é”™è¯¯ â†’ ç”¨æˆ·å›°æƒ‘ â†’ æ’æŸ¥æ—¥å¿—

âœ… Fail-Fast:
  å¯åŠ¨ â†’ å¤±è´¥ â†’ æŸ¥çœ‹å¯åŠ¨æ—¥å¿— â†’ ç«‹å³çŸ¥é“æ˜¯Redisé—®é¢˜ â†’ ä¿®å¤
```

### 2. æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯

**é™çº§å¤„ç†çš„é”™è¯¯**:
```
HTTP 401 Unauthorized
{
  "code": 401,
  "msg": "è®¤è¯å¤±è´¥ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº"
}
```
ç”¨æˆ·ï¼šğŸ¤” ä¸ºä»€ä¹ˆè®¤è¯å¤±è´¥ï¼ŸTokenæœ‰é—®é¢˜ï¼Ÿè¿˜æ˜¯æœåŠ¡å™¨é—®é¢˜ï¼Ÿ

**Fail-Fastçš„é”™è¯¯**:
```
***************************
APPLICATION FAILED TO START
***************************

Description:
Same-Tokenåˆå§‹åŒ–å¤±è´¥ï¼ŒGatewayæ— æ³•å¯åŠ¨ã€‚

Reason:
Redisè¿æ¥å¤±è´¥

Action:
è¯·æ£€æŸ¥Redisè¿æ¥é…ç½®:
1. æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€: redis-cli ping
2. æ£€æŸ¥Redisé…ç½®: spring.data.redis.*
3. æ£€æŸ¥Redisæ—¥å¿—
```
å¼€å‘è€…ï¼šâœ… ä¸€ç›®äº†ç„¶ï¼å»æ£€æŸ¥Redisï¼

### 3. é¿å…éƒ¨åˆ†åŠŸèƒ½å¤±æ•ˆ

**é™çº§å¤„ç†**:
```
Gatewayå¯åŠ¨ âœ…
  â”œâ”€ è®¤è¯åŠŸèƒ½ âœ…
  â”œâ”€ è·¯ç”±åŠŸèƒ½ âœ…
  â””â”€ Same-TokenéªŒè¯ âŒ â† éƒ¨åˆ†å¤±æ•ˆ
```
**é—®é¢˜**: ç³»ç»Ÿçœ‹èµ·æ¥æ­£å¸¸ï¼Œä½†éƒ¨åˆ†åŠŸèƒ½å¤±æ•ˆï¼Œéš¾ä»¥æ’æŸ¥ã€‚

**Fail-Fast**:
```
Gatewayå¯åŠ¨ âŒ â† å®Œå…¨å¤±è´¥
  åŸå› æ˜ç¡®ï¼šSame-Tokenåˆå§‹åŒ–å¤±è´¥
  è§£å†³æ–¹æ¡ˆæ˜ç¡®ï¼šä¿®å¤Redisé…ç½®
```
**ä¼˜åŠ¿**: è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å­˜åœ¨"éƒ¨åˆ†å¤±æ•ˆ"çš„ä¸­é—´çŠ¶æ€ã€‚

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### å¼‚å¸¸å¤„ç†å±‚çº§

```
Level 1: SameTokenInitializer
  â”œâ”€ èŒè´£ï¼šå¯åŠ¨æ—¶åˆå§‹åŒ–
  â””â”€ Fail-Fastï¼šåˆå§‹åŒ–å¤±è´¥ â†’ æŠ›å‡ºå¼‚å¸¸ â†’ åº”ç”¨å¯åŠ¨å¤±è´¥

Level 2: ForwardAuthFilter  
  â”œâ”€ èŒè´£ï¼šè¿è¡Œæ—¶è¯»å–token
  â””â”€ Fail-Fastï¼štokenä¸å­˜åœ¨ â†’ æŠ›å‡ºå¼‚å¸¸ â†’ è¯·æ±‚å¤±è´¥ï¼ˆä½†ç»™å‡ºæ˜ç¡®åŸå› ï¼‰

Level 3: SecurityConfiguration (å¾®æœåŠ¡)
  â”œâ”€ èŒè´£ï¼šéªŒè¯Same-Token
  â””â”€ Fail-Fastï¼šéªŒè¯å¤±è´¥ â†’ è¿”å›401 â†’ ä½†æ—¥å¿—æ˜ç¡®è®°å½•åŸå› 
```

### é™çº§ç­–ç•¥çš„é€‚ç”¨åœºæ™¯

**Fail-Fast ä¸æ˜¯åå¯¹æ‰€æœ‰çš„é™çº§å¤„ç†ï¼**

é™çº§å¤„ç†é€‚ç”¨äºï¼š
- âœ… éæ ¸å¿ƒåŠŸèƒ½ï¼ˆå¦‚æ¨èç³»ç»Ÿã€æœç´¢å»ºè®®ï¼‰
- âœ… æœ‰æ˜ç¡®çš„é™çº§ç›®æ ‡ï¼ˆå¦‚ç¼“å­˜å¤±æ•ˆï¼Œä»DBè¯»å–ï¼‰
- âœ… é™çº§åä»èƒ½æä¾›åŸºæœ¬æœåŠ¡

**Same-Token ä¸ºä»€ä¹ˆä¸é€‚åˆé™çº§ï¼Ÿ**
- âŒ æ˜¯æ ¸å¿ƒå®‰å…¨åŠŸèƒ½ï¼ˆä¸æ˜¯"å¯æœ‰å¯æ— "ï¼‰
- âŒ æ²¡æœ‰åˆç†çš„é™çº§ç›®æ ‡ï¼ˆä¸´æ—¶tokenæ— æ³•éªŒè¯ï¼‰
- âŒ é™çº§åæ— æ³•æä¾›åŸºæœ¬æœåŠ¡ï¼ˆè¯·æ±‚å¿…ç„¶å¤±è´¥ï¼‰

---

## ğŸ“– è¡Œä¸šæœ€ä½³å®è·µ

### Spring Boot çš„ Fail-Fast

Spring Boot æœ¬èº«å°±å¤§é‡ä½¿ç”¨Fail-FaståŸåˆ™ï¼š

```java
// æ•°æ®æºé…ç½®é”™è¯¯ â†’ å¯åŠ¨å¤±è´¥
@Bean
public DataSource dataSource() {
    // å¦‚æœé…ç½®é”™è¯¯ï¼ŒSpring Bootä¼šåœ¨å¯åŠ¨æ—¶æŠ›å‡ºå¼‚å¸¸
    return DataSourceBuilder.create().build();
}

// Redisé…ç½®é”™è¯¯ â†’ å¯åŠ¨å¤±è´¥
@Bean
public RedisConnectionFactory redisConnectionFactory() {
    // å¦‚æœRedisè¿æ¥å¤±è´¥ï¼ŒSpring Bootä¼šåœ¨å¯åŠ¨æ—¶æŠ›å‡ºå¼‚å¸¸
    return new LettuceConnectionFactory();
}
```

### å¾®æœåŠ¡æ¶æ„çš„å¥åº·æ£€æŸ¥

```yaml
# Kubernetes Liveness Probe
livenessProbe:
  httpGet:
    path: /actuator/health
    port: 8080
  # å¦‚æœå¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒK8sä¼šé‡å¯Pod
  # è€Œä¸æ˜¯è®©å®ƒ"å¸¦ç—…è¿è¡Œ"
```

---

## âœ… æ€»ç»“

### ç”¨æˆ·çš„è´¨ç–‘æ˜¯æ­£ç¡®çš„

> "æˆ‘ä»¬æ˜¯å¦åº”è¯¥å…³æ³¨å¹¶ä¿®å¤Redisç›¸å…³é—®é¢˜ï¼Œè€Œä¸æ˜¯åœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ªæœ¬åœ°çš„é™çº§å¤„ç†ï¼Ÿ"

**ç­”ï¼š100%æ­£ç¡®ï¼**

### è®¾è®¡åŸåˆ™

1. **Fail-Fast > é™çº§å¤„ç†**ï¼ˆå¯¹äºæ ¸å¿ƒåŠŸèƒ½ï¼‰
2. **æ˜ç¡®çš„é”™è¯¯ > æ¨¡ç³Šçš„æˆåŠŸ**
3. **å¯åŠ¨å¤±è´¥ > è¿è¡Œæ—¶å¤±è´¥**
4. **ç«‹å³æš´éœ²é—®é¢˜ > éšè—é—®é¢˜**

### ä»£ç æ”¹è¿›

```diff
# SameTokenInitializer
- log.error("åˆå§‹åŒ–å¤±è´¥"); // âŒ åªè®°å½•æ—¥å¿—
+ throw new IllegalStateException("åˆå§‹åŒ–å¤±è´¥"); // âœ… æŠ›å‡ºå¼‚å¸¸

# ForwardAuthFilter
- if (sameToken == null) {
-     sameToken = SaSameUtil.getToken(); // âŒ é™çº§å¤„ç†
- }
+ if (sameToken == null) {
+     throw new IllegalStateException("Same-Tokenæœªåˆå§‹åŒ–"); // âœ… æŠ›å‡ºå¼‚å¸¸
+ }
```

### å®é™…æ•ˆæœ

**Before (v1.0)**:
```
[å¯åŠ¨] Gatewayå¯åŠ¨æˆåŠŸ âœ…ï¼ˆå®é™…æœ‰é—®é¢˜ï¼‰
[è¿è¡Œ] è¯·æ±‚è¿”å›401 âŒï¼ˆç”¨æˆ·å›°æƒ‘ï¼‰
[è°ƒè¯•] æ’æŸ¥æ—¥å¿—30åˆ†é’Ÿ â°
```

**After (v2.0 - Fail-Fast)**:
```
[å¯åŠ¨] Gatewayå¯åŠ¨å¤±è´¥ âŒ
[é”™è¯¯] Same-Tokenåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥Redis âœ…
[è°ƒè¯•] ç›´æ¥ä¿®å¤Redisé—®é¢˜ â° 5åˆ†é’Ÿ
```

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ç”¨æˆ·æå‡ºçš„ä¼˜ç§€å»ºè®®ï¼è¿™ä¸ªè´¨ç–‘è®©æˆ‘ä»¬çš„ç³»ç»Ÿè®¾è®¡æ›´åŠ å¥å£®ã€‚

**ä¼˜ç§€çš„å·¥ç¨‹å¸ˆä¸æ˜¯å†™å‡º"çœ‹èµ·æ¥èƒ½è¿è¡Œ"çš„ä»£ç ï¼Œè€Œæ˜¯å†™å‡º"è¦ä¹ˆå®Œå…¨æ­£ç¡®ï¼Œè¦ä¹ˆç«‹å³å¤±è´¥"çš„ä»£ç ã€‚**

---

**ç‰ˆæœ¬**: v2.0 - Fail-Fast Edition  
**æ—¥æœŸ**: 2025-11-08  
**ä¸‹æ¬¡æ›´æ–°**: æ ¹æ®ç”Ÿäº§ç¯å¢ƒåé¦ˆæŒç»­æ”¹è¿›

