# ğŸ—ï¸ RuoYi-Cloud-Plus & XYç›¸é‡æ´¾ - Sa-Token å®Œæ•´æŠ€æœ¯æ¶æ„æ–‡æ¡£

> **ç‰ˆæœ¬**: v3.0  
> **æ›´æ–°æ—¥æœŸ**: 2025-11-08  
> **é€‚ç”¨èŒƒå›´**: å¾®æœåŠ¡æ¶æ„ä¸‹çš„å®Œæ•´æƒé™è®¤è¯æ–¹æ¡ˆ  
> **ä½œè€…**: AI Assistant + DevTeam

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#1-æ¶æ„æ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶](#2-æ ¸å¿ƒç»„ä»¶)
3. [è®¤è¯æµç¨‹](#3-è®¤è¯æµç¨‹)
4. [æƒé™ç®¡ç†](#4-æƒé™ç®¡ç†)
5. [å¾®æœåŠ¡é›†æˆ](#5-å¾®æœåŠ¡é›†æˆ)
6. [å®‰å…¨æœºåˆ¶](#6-å®‰å…¨æœºåˆ¶)
7. [æ€§èƒ½ä¼˜åŒ–](#7-æ€§èƒ½ä¼˜åŒ–)
8. [æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
9. [æ•…éšœæ’æŸ¥](#9-æ•…éšœæ’æŸ¥)
10. [å‡çº§æŒ‡å—](#10-å‡çº§æŒ‡å—)

---

## 1. æ¶æ„æ¦‚è¿°

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ğŸŒ å®¢æˆ·ç«¯å±‚                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ React-Appâ”‚    â”‚  Vue-Web â”‚    â”‚iOS/Androidâ”‚   â”‚ Mini-APP â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚
â”‚        â”‚               â”‚               â”‚              â”‚            â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ Bearer Token
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸšª Gateway å±‚ (ç«¯å£: 8080)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SaReactorFilter (WebFlux)                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ 1ï¸âƒ£ æå– Token (Authorization Header)                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ 2ï¸âƒ£ StpUtil.checkLogin() éªŒè¯ Token                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ 3ï¸âƒ£ éªŒè¯ ClientId ä¸€è‡´æ€§                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ 4ï¸âƒ£ ForwardAuthFilter æ·»åŠ  Same-Token                      â”‚  â”‚
â”‚  â”‚  â””â”€ 5ï¸âƒ£ è·¯ç”±è½¬å‘åˆ°åç«¯å¾®æœåŠ¡                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚            â”‚            â”‚
         Same-TokenéªŒè¯     â”‚            â”‚            â”‚
                            â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ“¦ å¾®æœåŠ¡å±‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ xypai-user   â”‚  â”‚xypai-content â”‚  â”‚  xypai-chat  â”‚               â”‚
â”‚  â”‚  (ç«¯å£:9401) â”‚  â”‚  (ç«¯å£:9403) â”‚  â”‚  (ç«¯å£:9404) â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                 â”‚                  â”‚                        â”‚
â”‚         â”‚   SecurityConfiguration            â”‚                        â”‚
â”‚         â”‚   â”œâ”€ Same-Token éªŒè¯               â”‚                        â”‚
â”‚         â”‚   â”œâ”€ JWT Simple Mode (ä¿¡ä»»Gateway) â”‚                        â”‚
â”‚         â”‚   â””â”€ LoginHelper è·å–ç”¨æˆ·ä¿¡æ¯      â”‚                        â”‚
â”‚         â”‚                 â”‚                  â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ğŸ’¾ æ•°æ®å­˜å‚¨å±‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚   MySQL      â”‚           â”‚    Redis     â”‚                         â”‚
â”‚  â”‚ ç”¨æˆ·/æƒé™æ•°æ®â”‚           â”‚ Token/Sessionâ”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒè®¾è®¡ç†å¿µ

| è®¾è®¡åŸåˆ™ | å®ç°æ–¹å¼ | ä¼˜åŠ¿ |
|---------|---------|------|
| **TokenåŒé‡éªŒè¯** | ç”¨æˆ·Token(JWT) + Same-Token(å›ºå®š) | æ—¢éªŒè¯ç”¨æˆ·èº«ä»½ï¼ŒåˆéªŒè¯è¯·æ±‚æ¥æº |
| **JWT Simple Mode** | å¾®æœåŠ¡ä¿¡ä»»Gatewayï¼Œæ— éœ€RedisæŸ¥è¯¢ | æ€§èƒ½æå‡10å€+ |
| **ç½‘å…³ç»Ÿä¸€é‰´æƒ** | æ‰€æœ‰è¯·æ±‚å¿…ç»Gateway | å®‰å…¨æ€§æœ€å¤§åŒ– |
| **æœåŠ¡é—´éš”ç¦»** | Same-Tokené˜²æ­¢ç›´æ¥è®¿é—® | å†…ç½‘å®‰å…¨ä¿éšœ |
| **å¤šç§Ÿæˆ·æ”¯æŒ** | LoginIdæ ¼å¼: `{userType}:{userId}:{tenantId}` | çµæ´»çš„ç§Ÿæˆ·éš”ç¦» |

### 1.3 æŠ€æœ¯æ ˆç‰ˆæœ¬

| ç»„ä»¶ | ç‰ˆæœ¬ | è¯´æ˜ |
|-----|------|------|
| **Sa-Token** | 1.44.0 | æƒé™è®¤è¯æ¡†æ¶ |
| **Spring Cloud Gateway** | 2023.0.x | APIç½‘å…³ (WebFlux) |
| **Spring Boot** | 3.2.x | åº”ç”¨æ¡†æ¶ |
| **Redis** | 7.0+ | ç¼“å­˜/Sessionå­˜å‚¨ |
| **MySQL** | 8.0+ | æ•°æ®æŒä¹…åŒ– |
| **Nacos** | 2.3.x | é…ç½®ä¸­å¿ƒ/æ³¨å†Œä¸­å¿ƒ |

---

## 2. æ ¸å¿ƒç»„ä»¶

### 2.1 LoginHelper - ç™»å½•åŠ©æ‰‹

**ä½ç½®**: `ruoyi-common-satoken/utils/LoginHelper.java`

**æ ¸å¿ƒåŠŸèƒ½**:
```java
public class LoginHelper {
    // å¸¸é‡å®šä¹‰
    public static final String LOGIN_USER_KEY = "loginUser";
    public static final String CLIENT_KEY = "clientid";
    public static final String USER_KEY = "userId";
    
    /**
     * ç™»å½•ç³»ç»Ÿ - æ ¸å¿ƒæ–¹æ³•
     * @param loginUser ç™»å½•ç”¨æˆ·ä¿¡æ¯
     * @param model ç™»å½•å‚æ•°é…ç½®
     */
    public static void login(LoginUser loginUser, SaLoginParameter model) {
        model = ObjectUtil.defaultIfNull(model, new SaLoginParameter());
        
        // æ‰§è¡ŒSa-Tokenç™»å½•ï¼Œå¹¶è®¾ç½®é¢å¤–ä¿¡æ¯
        StpUtil.login(loginUser.getLoginId(),
            model.setExtra(TENANT_KEY, loginUser.getTenantId())
                .setExtra(USER_KEY, loginUser.getUserId())
                .setExtra(USER_NAME_KEY, loginUser.getUsername())
                .setExtra(DEPT_KEY, loginUser.getDeptId())
                .setExtra(CLIENT_KEY, model.getDevice())  // âœ… å…³é”®ï¼šè®¾ç½®ClientId
        );
        
        // å°†å®Œæ•´ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°Token-Session
        StpUtil.getTokenSession().set(LOGIN_USER_KEY, loginUser);
    }
    
    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·
     */
    public static <T extends LoginUser> T getLoginUser() {
        SaSession session = StpUtil.getTokenSession();
        return (T) session.get(LOGIN_USER_KEY);
    }
    
    /**
     * è·å–ç”¨æˆ·ID
     */
    public static Long getUserId() {
        return Convert.toLong(getExtra(USER_KEY));
    }
    
    /**
     * è·å–ClientId
     */
    public static String getClient() {
        return (String) StpUtil.getExtra(CLIENT_KEY);
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```java
// ç™»å½•æ—¶
LoginUser loginUser = buildLoginUser(...);
SaLoginParameter model = new SaLoginParameter()
    .setDeviceType("app")
    .setTimeout(86400L);  // 24å°æ—¶
    
LoginHelper.login(loginUser, model);
String token = StpUtil.getTokenValue();  // è·å–ç”Ÿæˆçš„Token

// åç»­è¯·æ±‚ä¸­è·å–ç”¨æˆ·ä¿¡æ¯
Long userId = LoginHelper.getUserId();
String username = LoginHelper.getUsername();
LoginUser currentUser = LoginHelper.getLoginUser();
```

### 2.2 SaPermissionImpl - æƒé™æ¥å£å®ç°

**ä½ç½®**: `ruoyi-common-satoken/core/service/SaPermissionImpl.java`

**æ ¸å¿ƒåŠŸèƒ½**: å®ç° Sa-Token çš„ `StpInterface` æ¥å£ï¼Œä¸ºæ¡†æ¶æä¾›æƒé™å’Œè§’è‰²æ•°æ®

```java
@Component
public class SaPermissionImpl implements StpInterface {
    
    /**
     * è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
     * @param loginId ç™»å½•IDï¼ˆæ ¼å¼: app_user:2000ï¼‰
     * @param loginType ç™»å½•ç±»å‹ï¼ˆlogin/userï¼‰
     */
    @Override
    public List<String> getPermissionList(Object loginId, String loginType) {
        LoginUser loginUser = LoginHelper.getLoginUser();
        
        if (ObjectUtil.isNull(loginUser)) {
            // ä»PermissionServiceè¿œç¨‹è·å–
            PermissionService permissionService = getPermissionService();
            List<String> list = StringUtils.splitList(loginId.toString(), ":");
            return permissionService.getMenuPermission(Long.parseLong(list.get(1)));
        }
        
        // ä»LoginUserä¸­è·å–ç¼“å­˜çš„æƒé™
        UserType userType = UserType.getUserType(loginUser.getUserType());
        if (userType == UserType.APP_USER) {
            // APPç”¨æˆ·çš„æƒé™å¤„ç†é€»è¾‘
            return new ArrayList<>(loginUser.getMenuPermission());
        }
        
        return new ArrayList<>(loginUser.getMenuPermission());
    }
    
    /**
     * è·å–ç”¨æˆ·è§’è‰²åˆ—è¡¨
     */
    @Override
    public List<String> getRoleList(Object loginId, String loginType) {
        LoginUser loginUser = LoginHelper.getLoginUser();
        
        if (CollUtil.isNotEmpty(loginUser.getRolePermission())) {
            return new ArrayList<>(loginUser.getRolePermission());
        }
        
        return new ArrayList<>();
    }
}
```

**æƒé™æ ¡éªŒç¤ºä¾‹**:
```java
// Controllerä¸­ä½¿ç”¨æ³¨è§£é‰´æƒ
@SaCheckPermission("user:add")
@PostMapping("/users")
public R<Void> addUser(@RequestBody UserDTO dto) {
    // åªæœ‰æ‹¥æœ‰ user:add æƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®
    return userService.addUser(dto);
}

// æˆ–ä½¿ç”¨ç¼–ç¨‹å¼é‰´æƒ
if (StpUtil.hasPermission("user:add")) {
    // æœ‰æƒé™
}

// è§’è‰²æ ¡éªŒ
@SaCheckRole("admin")
@DeleteMapping("/users/{id}")
public R<Void> deleteUser(@PathVariable Long id) {
    // åªæœ‰adminè§’è‰²æ‰èƒ½è®¿é—®
    return userService.deleteUser(id);
}
```

### 2.3 Gateway è®¤è¯è¿‡æ»¤å™¨

**ä½ç½®**: `ruoyi-gateway/filter/AuthFilter.java`

**æ ¸å¿ƒåŠŸèƒ½**: Gatewayå±‚çš„è®¤è¯å…¥å£

```java
@Slf4j
@Configuration
public class AuthFilter {
    
    @Bean
    public SaReactorFilter getSaReactorFilter(IgnoreWhiteProperties ignoreWhite) {
        return new SaReactorFilter()
            .addInclude("/**")  // æ‹¦æˆªæ‰€æœ‰è·¯ç”±
            .addExclude("/favicon.ico", "/actuator", "/actuator/**")  // æ’é™¤å¥åº·æ£€æŸ¥
            .setAuth(obj -> {
                SaRouter.match("/**")
                    .notMatch(ignoreWhite.getWhites())  // æ’é™¤ç™½åå•
                    .check(r -> {
                        ServerHttpRequest request = SaReactorSyncHolder.getExchange().getRequest();
                        String path = request.getPath().value();
                        
                        log.info("ğŸ” [GATEWAY AUTH] å¼€å§‹è®¤è¯: {}", path);
                        
                        // 1ï¸âƒ£ ä»è¯·æ±‚å¤´ä¸­è·å–Token
                        String tokenValue = StpUtil.getTokenValue();
                        log.info("   ğŸ“‹ Tokenå€¼: {}...", tokenValue.substring(0, 30));
                        
                        // 2ï¸âƒ£ éªŒè¯Tokenæœ‰æ•ˆæ€§
                        StpUtil.checkLogin();
                        log.info("   âœ… TokenéªŒè¯é€šè¿‡");
                        
                        // 3ï¸âƒ£ éªŒè¯ClientIdä¸€è‡´æ€§ï¼ˆå…³é”®å®‰å…¨æ£€æŸ¥ï¼‰
                        String headerCid = request.getHeaders().getFirst(LoginHelper.CLIENT_KEY);
                        String paramCid = request.getQueryParams().getFirst(LoginHelper.CLIENT_KEY);
                        Object clientIdObj = StpUtil.getExtra(LoginHelper.CLIENT_KEY);
                        String clientId = clientIdObj != null ? clientIdObj.toString() : null;
                        
                        if (!StringUtils.equalsAny(clientId, headerCid, paramCid)) {
                            log.warn("   âŒ ClientIdä¸åŒ¹é…! Token={}, Header={}, Param={}", 
                                clientId, headerCid, paramCid);
                            throw NotLoginException.newInstance(StpUtil.getLoginType(),
                                "-100", "å®¢æˆ·ç«¯IDä¸Tokenä¸åŒ¹é…",
                                StpUtil.getTokenValue());
                        }
                        
                        log.info("   âœ… ClientIdåŒ¹é…é€šè¿‡");
                        log.info("   âœ… [GATEWAY AUTH] è®¤è¯æˆåŠŸ: {}", path);
                    });
            })
            .setError(e -> {
                log.error("ğŸš¨ [GATEWAY AUTH] è®¤è¯å¼‚å¸¸:");
                if (e instanceof NotLoginException) {
                    NotLoginException nle = (NotLoginException) e;
                    return SaResult.error(e.getMessage()).setCode(HttpStatus.UNAUTHORIZED);
                }
                return SaResult.error("è®¤è¯å¤±è´¥ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº").setCode(HttpStatus.UNAUTHORIZED);
            });
    }
}
```

### 2.4 Same-Token æœºåˆ¶

#### 2.4.1 Same-Token åˆå§‹åŒ–å™¨

**ä½ç½®**: `ruoyi-gateway/config/SameTokenInitializer.java`

**æ ¸å¿ƒåŠŸèƒ½**: Gatewayå¯åŠ¨æ—¶åˆå§‹åŒ–Same-Token

```java
@Slf4j
@Component
public class SameTokenInitializer implements ApplicationRunner {
    
    private static final String SAME_TOKEN_REDIS_KEY = "satoken:var:same-token";
    private static final Duration SAME_TOKEN_EXPIRE_TIME = Duration.ofDays(7);
    
    @Override
    public void run(ApplicationArguments args) {
        log.info("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
        log.info("ğŸ” [SAME-TOKEN INIT] å¼€å§‹åˆå§‹åŒ–Same-Token...");
        
        try {
            // 1. ç”ŸæˆSame-Token
            String sameToken = SaSameUtil.getToken();
            log.info("   âœ… ç”ŸæˆSame-Token: {}...", sameToken.substring(0, 30));
            
            // 2. å­˜å‚¨åˆ°Redis
            RedisUtils.setCacheObject(SAME_TOKEN_REDIS_KEY, sameToken, SAME_TOKEN_EXPIRE_TIME);
            log.info("   âœ… Same-Tokenå·²å­˜å‚¨åˆ°Redisï¼Œæœ‰æ•ˆæœŸ {} å¤©", SAME_TOKEN_EXPIRE_TIME.toDays());
            
            // 3. éªŒè¯å­˜å‚¨
            String storedToken = RedisUtils.getCacheObject(SAME_TOKEN_REDIS_KEY);
            if (sameToken.equals(storedToken)) {
                log.info("   âœ… éªŒè¯æˆåŠŸï¼šSame-Tokenå·²æ­£ç¡®å­˜å‚¨åˆ°Redis");
            } else {
                log.error("   âŒ éªŒè¯å¤±è´¥ï¼šå­˜å‚¨åˆ°Redisçš„Same-Tokenä¸ç”Ÿæˆçš„ä¸ä¸€è‡´ï¼");
            }
        } catch (Exception e) {
            log.error("âŒ [SAME-TOKEN INIT] Same-Tokenåˆå§‹åŒ–å¤±è´¥: {}", e.getMessage(), e);
        }
        
        log.info("ğŸ‰ [SAME-TOKEN INIT] Same-Tokenåˆå§‹åŒ–å®Œæˆï¼");
        log.info("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    }
}
```

#### 2.4.2 ForwardAuthFilter - æ·»åŠ Same-Token

**ä½ç½®**: `ruoyi-gateway/filter/ForwardAuthFilter.java`

```java
@Slf4j
@Component
@RequiredArgsConstructor
public class ForwardAuthFilter implements GlobalFilter, Ordered {
    
    private final RedisConnectionFactory redisConnectionFactory;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String path = exchange.getRequest().getURI().getPath();
        
        if (!SaManager.getConfig().getCheckSameToken()) {
            return chain.filter(exchange);
        }
        
        // ç”ŸæˆSame-Token
        String sameToken = SaSameUtil.getToken();
        log.info("ğŸ”‘ [SAME-TOKEN] ä¸ºè¯·æ±‚æ·»åŠ  Same-Token: {}", path);
        log.info("   Same-Tokenå®Œæ•´å€¼: {}", sameToken);
        
        // æ·»åŠ åˆ°è¯·æ±‚å¤´
        ServerHttpRequest newRequest = exchange
            .getRequest()
            .mutate()
            .header(SaSameUtil.SAME_TOKEN, sameToken)
            .build();
            
        ServerWebExchange newExchange = exchange.mutate().request(newRequest).build();
        return chain.filter(newExchange);
    }
    
    @Override
    public int getOrder() {
        return -200;  // åœ¨è®¤è¯è¿‡æ»¤å™¨ä¹‹åæ‰§è¡Œ
    }
}
```

#### 2.4.3 SecurityConfiguration - éªŒè¯Same-Token

**ä½ç½®**: `ruoyi-common-security/config/SecurityConfiguration.java`

```java
@Slf4j
@AutoConfiguration
@RequiredArgsConstructor
public class SecurityConfiguration implements WebMvcConfigurer {
    
    private final RedisConnectionFactory redisConnectionFactory;
    
    @Bean
    public SaServletFilter getSaServletFilter() {
        return new SaServletFilter()
            .addInclude("/**")
            .addExclude("/actuator", "/actuator/**")
            .setAuth(obj -> {
                if (SaManager.getConfig().getCheckSameToken()) {
                    log.info("ğŸ” [SAME-TOKEN CHECK] å¼€å§‹éªŒè¯è¯·æ±‚æ˜¯å¦æ¥è‡ªGateway");
                    
                    try {
                        // éªŒè¯Same-Token
                        SaSameUtil.checkCurrentRequestToken();
                        log.info("   âœ… Same-TokenéªŒè¯é€šè¿‡");
                    } catch (Exception e) {
                        log.error("   âŒ Same-TokenéªŒè¯å¤±è´¥: {}", e.getMessage());
                        throw e;
                    }
                }
            })
            .setError(e -> {
                log.error("ğŸš« [SECURITY FILTER] è®¤è¯å¤±è´¥: {}", e.getMessage());
                return SaResult.error("è®¤è¯å¤±è´¥ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº").setCode(HttpStatus.UNAUTHORIZED);
            });
    }
}
```

### 2.5 å¼‚å¸¸å¤„ç†å™¨

#### 2.5.1 SaTokenExceptionHandler

**ä½ç½®**: `ruoyi-common-satoken/handler/SaTokenExceptionHandler.java`

```java
@Slf4j
@RestControllerAdvice
public class SaTokenExceptionHandler {
    
    /**
     * æƒé™ç å¼‚å¸¸
     */
    @ExceptionHandler(NotPermissionException.class)
    public R<Void> handleNotPermissionException(NotPermissionException e, HttpServletRequest request) {
        String requestURI = request.getRequestURI();
        log.error("è¯·æ±‚åœ°å€'{}',æƒé™ç æ ¡éªŒå¤±è´¥'{}'", requestURI, e.getMessage());
        return R.fail(HttpStatus.HTTP_FORBIDDEN, "æ²¡æœ‰è®¿é—®æƒé™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æˆæƒ");
    }
    
    /**
     * è§’è‰²æƒé™å¼‚å¸¸
     */
    @ExceptionHandler(NotRoleException.class)
    public R<Void> handleNotRoleException(NotRoleException e, HttpServletRequest request) {
        String requestURI = request.getRequestURI();
        log.error("è¯·æ±‚åœ°å€'{}',è§’è‰²æƒé™æ ¡éªŒå¤±è´¥'{}'", requestURI, e.getMessage());
        return R.fail(HttpStatus.HTTP_FORBIDDEN, "æ²¡æœ‰è®¿é—®æƒé™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æˆæƒ");
    }
    
    /**
     * è®¤è¯å¤±è´¥
     */
    @ExceptionHandler(NotLoginException.class)
    public R<Void> handleNotLoginException(NotLoginException e, HttpServletRequest request) {
        String requestURI = request.getRequestURI();
        log.error("è¯·æ±‚åœ°å€'{}',è®¤è¯å¤±è´¥'{}',æ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº", requestURI, e.getMessage());
        return R.fail(HttpStatus.HTTP_UNAUTHORIZED, "è®¤è¯å¤±è´¥ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº");
    }
}
```

---

## 3. è®¤è¯æµç¨‹

### 3.1 ç”¨æˆ·ç™»å½•æµç¨‹

```
ç”¨æˆ·ç«¯                    xypai-security           Redis           Gateway           å…¶ä»–å¾®æœåŠ¡
  â”‚                           â”‚                      â”‚                â”‚                  â”‚
  â”‚  1. POST /auth/login     â”‚                      â”‚                â”‚                  â”‚
  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                      â”‚                â”‚                  â”‚
  â”‚  { phone, password }     â”‚                      â”‚                â”‚                  â”‚
  â”‚                           â”‚                      â”‚                â”‚                  â”‚
  â”‚                           â”‚  2. éªŒè¯å¯†ç           â”‚                â”‚                  â”‚
  â”‚                           â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>     â”‚                â”‚                  â”‚
  â”‚                           â”‚  BCrypt.matches()    â”‚                â”‚                  â”‚
  â”‚                           â”‚                      â”‚                â”‚                  â”‚
  â”‚                           â”‚  3. æ„å»ºLoginUser     â”‚                â”‚                  â”‚
  â”‚                           â”‚                      â”‚                â”‚                  â”‚
  â”‚                           â”‚  4. LoginHelper.login()                                  â”‚
  â”‚                           â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                  â”‚
  â”‚                           â”‚  StpUtil.login()      â”‚                â”‚                  â”‚
  â”‚                           â”‚  - ç”ŸæˆJWT Token      â”‚                â”‚                  â”‚
  â”‚                           â”‚  - è®¾ç½®Extraä¿¡æ¯       â”‚                â”‚                  â”‚
  â”‚                           â”‚                      â”‚                â”‚                  â”‚
  â”‚                           â”‚  5. å­˜å‚¨Token-Session â”‚                â”‚                  â”‚
  â”‚                           â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                  â”‚
  â”‚                           â”‚  Redis: token -> user â”‚                â”‚                  â”‚
  â”‚                           â”‚                      â”‚                â”‚                  â”‚
  â”‚  6. è¿”å›Token              â”‚                      â”‚                â”‚                  â”‚
  â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                      â”‚                â”‚                  â”‚
  â”‚  { accessToken, expiresIn }                     â”‚                â”‚                  â”‚
  â”‚                           â”‚                      â”‚                â”‚                  â”‚
  â”‚  7. å­˜å‚¨Tokenåˆ°æœ¬åœ°        â”‚                      â”‚                â”‚                  â”‚
  â”‚  SecureStore.setItem()    â”‚                      â”‚                â”‚                  â”‚
  â”‚                           â”‚                      â”‚                â”‚                  â”‚
```

**ä»£ç å®ç°**:

```java
// xypai-security/AuthServiceImpl.java

@Service
public class AuthServiceImpl implements IAuthService {
    
    @Override
    public LoginResultVO login(LoginDTO loginDTO) {
        // 1ï¸âƒ£ ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
        AuthUserDTO authUser = userMapper.selectByPhoneOrUsername(
            loginDTO.getPhoneNumber(), 
            loginDTO.getUsername()
        );
        
        // 2ï¸âƒ£ éªŒè¯å¯†ç 
        if (!BCrypt.checkpw(loginDTO.getPassword(), authUser.getPassword())) {
            throw new ServiceException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
        
        // 3ï¸âƒ£ æ„å»ºLoginUserå¯¹è±¡
        LoginUser loginUser = AuthUserConverter.toLoginUserWithDetails(authUser);
        
        // 4ï¸âƒ£ æ„å»ºç™»å½•å‚æ•°
        SaLoginParameter loginModel = new SaLoginParameter();
        loginModel.setDeviceType(loginDTO.getClientType());  // app/pc/ios
        loginModel.setTimeout(86400L);  // 24å°æ—¶æœ‰æ•ˆæœŸ
        loginModel.setExtra("clientType", loginDTO.getClientType());  // âœ… å…³é”®
        
        // 5ï¸âƒ£ æ‰§è¡Œç™»å½•ï¼ˆæ ¸å¿ƒï¼‰
        LoginHelper.login(loginUser, loginModel);
        
        // 6ï¸âƒ£ è·å–ç”Ÿæˆçš„Token
        String saToken = StpUtil.getTokenValue();
        
        // 7ï¸âƒ£ è¿”å›ç™»å½•ç»“æœ
        return LoginResultVO.builder()
            .accessToken(saToken)
            .tokenType("Bearer")
            .expiresIn(86400L)
            .userId(authUser.getId())
            .username(authUser.getUsername())
            .build();
    }
}
```

### 3.2 APIè¯·æ±‚è®¤è¯æµç¨‹

```
ç”¨æˆ·ç«¯                    Gateway (8080)            Redis           å¾®æœåŠ¡ (9401)
  â”‚                           â”‚                      â”‚                  â”‚
  â”‚  1. GET /users/profile    â”‚                      â”‚                  â”‚
  â”‚  Authorization: Bearer xxxâ”‚                      â”‚                  â”‚
  â”‚  clientid: app            â”‚                      â”‚                  â”‚
  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                      â”‚                  â”‚
  â”‚                           â”‚                      â”‚                  â”‚
  â”‚                           â”‚  2. AuthFilterè®¤è¯    â”‚                  â”‚
  â”‚                           â”‚  - æå–Token          â”‚                  â”‚
  â”‚                           â”‚  - StpUtil.checkLogin()                   â”‚
  â”‚                           â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>     â”‚                  â”‚
  â”‚                           â”‚  éªŒè¯Token (JWT)      â”‚                  â”‚
  â”‚                           â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚                  â”‚
  â”‚                           â”‚  éªŒè¯é€šè¿‡ âœ…          â”‚                  â”‚
  â”‚                           â”‚                      â”‚                  â”‚
  â”‚                           â”‚  3. éªŒè¯ClientId       â”‚                  â”‚
  â”‚                           â”‚  Token.clientId == Header.clientid?      â”‚
  â”‚                           â”‚  âœ… åŒ¹é…é€šè¿‡          â”‚                  â”‚
  â”‚                           â”‚                      â”‚                  â”‚
  â”‚                           â”‚  4. ForwardAuthFilter â”‚                  â”‚
  â”‚                           â”‚  æ·»åŠ Same-Token       â”‚                  â”‚
  â”‚                           â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>     â”‚                  â”‚
  â”‚                           â”‚  è¯»å–Same-Token       â”‚                  â”‚
  â”‚                           â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚                  â”‚
  â”‚                           â”‚                      â”‚                  â”‚
  â”‚                           â”‚  5. è½¬å‘è¯·æ±‚          â”‚                  â”‚
  â”‚                           â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
  â”‚                           â”‚  Headers:             â”‚                  â”‚
  â”‚                           â”‚  - Authorization: Bearer xxx             â”‚
  â”‚                           â”‚  - clientid: app      â”‚                  â”‚
  â”‚                           â”‚  - Same-Token: yyy    â”‚                  â”‚
  â”‚                           â”‚                      â”‚                  â”‚
  â”‚                           â”‚                      â”‚  6. SecurityConfigéªŒè¯â”‚
  â”‚                           â”‚                      â”‚  - Same-TokenéªŒè¯ â”‚
  â”‚                           â”‚                      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
  â”‚                           â”‚                      â”‚  éªŒè¯é€šè¿‡ âœ…    â”‚
  â”‚                           â”‚                      â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                           â”‚                      â”‚                  â”‚
  â”‚                           â”‚                      â”‚  7. Controllerå¤„ç†â”‚
  â”‚                           â”‚                      â”‚  LoginHelper.getUserId()â”‚
  â”‚                           â”‚                      â”‚  è·å–ç”¨æˆ·ä¿¡æ¯    â”‚
  â”‚                           â”‚                      â”‚                  â”‚
  â”‚                           â”‚  8. è¿”å›å“åº”          â”‚                  â”‚
  â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚  { code: 200, data: {...} }â”‚                      â”‚                  â”‚
  â”‚                           â”‚                      â”‚                  â”‚
```

---

## 4. æƒé™ç®¡ç†

### 4.1 æƒé™è®¾è®¡

```
ç”¨æˆ· (User)
  â”‚
  â”œâ”€ æ‹¥æœ‰å¤šä¸ªè§’è‰² (Role)
  â”‚     â”‚
  â”‚     â”œâ”€ è§’è‰²1: admin
  â”‚     â”œâ”€ è§’è‰²2: editor
  â”‚     â””â”€ è§’è‰²3: viewer
  â”‚
  â””â”€ æ‹¥æœ‰å¤šä¸ªæƒé™ (Permission)
        â”‚
        â”œâ”€ user:add
        â”œâ”€ user:delete
        â”œâ”€ user:update
        â”œâ”€ user:get
        â”œâ”€ content:*    (é€šé…ç¬¦æƒé™)
        â””â”€ *            (ä¸Šå¸æƒé™)
```

### 4.2 æƒé™æ ¡éªŒæ–¹å¼

#### æ–¹å¼1: æ³¨è§£é‰´æƒ (æ¨è)

```java
@RestController
@RequestMapping("/api/v2/users")
public class UserController {
    
    // âœ… ç™»å½•æ ¡éªŒ
    @SaCheckLogin
    @GetMapping("/profile")
    public R<UserProfileVO> getProfile() {
        Long userId = LoginHelper.getUserId();
        return R.ok(userService.getProfile(userId));
    }
    
    // âœ… æƒé™æ ¡éªŒ
    @SaCheckPermission("user:add")
    @PostMapping
    public R<Void> addUser(@RequestBody UserDTO dto) {
        return userService.addUser(dto);
    }
    
    // âœ… è§’è‰²æ ¡éªŒ
    @SaCheckRole("admin")
    @DeleteMapping("/{id}")
    public R<Void> deleteUser(@PathVariable Long id) {
        return userService.deleteUser(id);
    }
    
    // âœ… å¤šæƒé™æ ¡éªŒ (AND: å¿…é¡»å…¨éƒ¨æ‹¥æœ‰)
    @SaCheckPermission(value = {"user:update", "user:get"}, mode = SaMode.AND)
    @PutMapping("/{id}")
    public R<Void> updateUser(@PathVariable Long id, @RequestBody UserDTO dto) {
        return userService.updateUser(id, dto);
    }
    
    // âœ… å¤šæƒé™æ ¡éªŒ (OR: æ‹¥æœ‰å…¶ä¸€å³å¯)
    @SaCheckPermission(value = {"user:get", "user:list"}, mode = SaMode.OR)
    @GetMapping
    public R<List<UserVO>> listUsers() {
        return userService.listUsers();
    }
    
    // âœ… æƒé™æˆ–è§’è‰² (ä»»æ„ä¸€ä¸ªé€šè¿‡å³å¯)
    @SaCheckPermission(value = "user:delete", orRole = "admin")
    @DeleteMapping("/batch")
    public R<Void> batchDelete(@RequestBody List<Long> ids) {
        return userService.batchDelete(ids);
    }
    
    // âœ… æ‰¹é‡æ³¨è§£æ ¡éªŒ
    @SaCheckOr(
        login = @SaCheckLogin,
        role = @SaCheckRole("admin"),
        permission = @SaCheckPermission("user:sensitive")
    )
    @GetMapping("/sensitive")
    public R<SensitiveDataVO> getSensitiveData() {
        // åªè¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ¡ä»¶å³å¯è®¿é—®
        return userService.getSensitiveData();
    }
}
```

#### æ–¹å¼2: ç¼–ç¨‹å¼é‰´æƒ

```java
@Service
public class UserService {
    
    public void updateUserProfile(Long userId, UserProfileDTO dto) {
        // åˆ¤æ–­æƒé™
        if (!StpUtil.hasPermission("user:update")) {
            throw new ServiceException("æ²¡æœ‰ä¿®æ”¹æƒé™");
        }
        
        // åˆ¤æ–­è§’è‰²
        if (StpUtil.hasRole("admin")) {
            // ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹æ‰€æœ‰ç”¨æˆ·
        } else {
            // æ™®é€šç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±
            if (!userId.equals(LoginHelper.getUserId())) {
                throw new ServiceException("åªèƒ½ä¿®æ”¹è‡ªå·±çš„èµ„æ–™");
            }
        }
        
        // ä¸šåŠ¡é€»è¾‘...
    }
}
```

#### æ–¹å¼3: è·¯ç”±æ‹¦æˆªé‰´æƒ

```java
@Configuration
public class SaTokenConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ³¨å†ŒSa-Tokenæ‹¦æˆªå™¨
        registry.addInterceptor(new SaInterceptor(handler -> {
            
            // ç™»å½•æ ¡éªŒ - æ‹¦æˆªæ‰€æœ‰è·¯ç”±
            SaRouter.match("/**")
                .notMatch("/api/v1/auth/login", "/api/v1/auth/register")  // æ’é™¤ç™»å½•æ¥å£
                .check(r -> StpUtil.checkLogin());
            
            // è§’è‰²æ ¡éªŒ - adminè·¯ç”±å¿…é¡»æ˜¯ç®¡ç†å‘˜
            SaRouter.match("/api/v2/admin/**", r -> StpUtil.checkRole("admin"));
            
            // æƒé™æ ¡éªŒ - ä¸åŒæ¨¡å—ä¸åŒæƒé™
            SaRouter.match("/api/v2/users/**", r -> StpUtil.checkPermission("user"));
            SaRouter.match("/api/v2/content/**", r -> StpUtil.checkPermission("content"));
            SaRouter.match("/api/v2/orders/**", r -> StpUtil.checkPermission("order"));
            
        })).addPathPatterns("/**");
    }
}
```

### 4.3 æƒé™é€šé…ç¬¦

```java
// å½“ç”¨æˆ·æ‹¥æœ‰ "content.*" æƒé™æ—¶
StpUtil.hasPermission("content.add");      // true
StpUtil.hasPermission("content.delete");   // true
StpUtil.hasPermission("content.update");   // true
StpUtil.hasPermission("user.add");         // false

// å½“ç”¨æˆ·æ‹¥æœ‰ "*.delete" æƒé™æ—¶
StpUtil.hasPermission("content.delete");   // true
StpUtil.hasPermission("user.delete");      // true
StpUtil.hasPermission("user.add");         // false

// å½“ç”¨æˆ·æ‹¥æœ‰ "*" (ä¸Šå¸æƒé™) æ—¶
StpUtil.hasPermission("ä»»ä½•æƒé™");  // å…¨éƒ¨è¿”å› true
```

---

## 5. å¾®æœåŠ¡é›†æˆ

### 5.1 æœåŠ¡é—´Tokenä¼ é€’

#### æ–¹å¼1: RestTemplateè‡ªåŠ¨æ³¨å…¥ (æ¨è)

```java
// é…ç½®ç±»
@Slf4j
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        RestTemplate restTemplate = new RestTemplate();
        
        // æ·»åŠ Sa-Tokenæ‹¦æˆªå™¨ï¼Œè‡ªåŠ¨æ³¨å…¥Token
        restTemplate.setInterceptors(Collections.singletonList(
            (request, body, execution) -> {
                if (StpUtil.isLogin()) {
                    String token = StpUtil.getTokenValue();
                    String clientType = (String) StpUtil.getExtra(LoginHelper.CLIENT_KEY);
                    
                    // âœ… è‡ªåŠ¨æ·»åŠ Tokenåˆ°è¯·æ±‚å¤´
                    request.getHeaders().add("Authorization", "Bearer " + token);
                    request.getHeaders().add("clientid", clientType != null ? clientType : "app");
                    
                    log.debug("ğŸ” [RestTemplate] å·²æ³¨å…¥Token: {}", request.getURI());
                }
                return execution.execute(request, body);
            }
        ));
        
        return restTemplate;
    }
}

// ä½¿ç”¨ï¼ˆè‡ªåŠ¨æºå¸¦Tokenï¼‰
@Service
public class ContentService {
    
    @Autowired
    private RestTemplate restTemplate;  // ä½¿ç”¨é…ç½®å¥½çš„RestTemplate
    
    public UserProfileVO getUserProfile(Long userId) {
        String url = "http://localhost:9401/api/v2/users/" + userId;
        
        // âœ… ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ Tokenï¼Œæ‹¦æˆªå™¨ä¼šè‡ªåŠ¨æ·»åŠ 
        return restTemplate.getForObject(url, UserProfileVO.class);
    }
}
```

#### æ–¹å¼2: Feignè‡ªåŠ¨æ³¨å…¥

```java
// Feigné…ç½®ç±»
@Slf4j
@Configuration
public class FeignConfig {
    
    @Bean
    public RequestInterceptor saTokenRequestInterceptor() {
        return requestTemplate -> {
            if (StpUtil.isLogin()) {
                String token = StpUtil.getTokenValue();
                String clientType = (String) StpUtil.getExtra(LoginHelper.CLIENT_KEY);
                
                // âœ… è‡ªåŠ¨æ·»åŠ Token
                requestTemplate.header("Authorization", "Bearer " + token);
                requestTemplate.header("clientid", clientType != null ? clientType : "app");
            }
        };
    }
}

// Feignå®¢æˆ·ç«¯å®šä¹‰
@FeignClient(name = "xypai-user", path = "/api/v2/users", configuration = FeignConfig.class)
public interface UserFeignClient {
    
    @GetMapping("/{userId}")
    R<UserProfileVO> getUserProfile(@PathVariable("userId") Long userId);
}

// ä½¿ç”¨ï¼ˆè‡ªåŠ¨æºå¸¦Tokenï¼‰
@Service
public class ContentService {
    
    @Autowired
    private UserFeignClient userFeignClient;
    
    public UserProfileVO getUserProfile(Long userId) {
        // âœ… Feignè‡ªåŠ¨æºå¸¦Token
        R<UserProfileVO> result = userFeignClient.getUserProfile(userId);
        return result.getData();
    }
}
```

### 5.2 å¾®æœåŠ¡é…ç½®æ¸…å•

æ¯ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦ä»¥ä¸‹é…ç½®ï¼š

#### âœ… 1. RestTemplateConfig.java

```bash
# éƒ¨ç½²åˆ°æ‰€æœ‰å¾®æœåŠ¡
xypai-user/src/main/java/com/xypai/user/config/RestTemplateConfig.java
xypai-content/src/main/java/com/xypai/content/config/RestTemplateConfig.java
xypai-chat/src/main/java/com/xypai/chat/config/RestTemplateConfig.java
xypai-trade/src/main/java/com/xypai/trade/config/RestTemplateConfig.java
xypai-security/security-oauth/src/main/java/com/xypai/auth/config/RestTemplateConfig.java
```

#### âœ… 2. application.yml é…ç½®

```yaml
# æ¯ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦é…ç½®
sa-token:
  token-name: Authorization
  check-same-token: true          # âœ… å¯ç”¨Same-TokenéªŒè¯
  is-concurrent: true
  is-share: false
  jwt-secret-key: ${sa-token.jwt-secret-key}  # ä»Nacoså…¨å±€é…ç½®è¯»å–

spring:
  data:
    redis:
      database: 0  # âœ… æ‰€æœ‰å¾®æœåŠ¡ä½¿ç”¨åŒä¸€ä¸ªRedis database
```

#### âœ… 3. Nacoså…¨å±€é…ç½®

```yaml
# 01A_xyp_doc/nacos/application-common.yml

sa-token:
  token-name: Authorization
  timeout: 604800                 # 7å¤©
  active-timeout: 1800            # 30åˆ†é’Ÿæ´»è·ƒè¶…æ—¶
  is-concurrent: true
  is-share: false
  check-same-token: true          # âœ… å…¨å±€å¯ç”¨Same-Token
  same-token-timeout: 604800      # 7å¤©
  jwt-secret-key: abcdefghijklmnopqrstuvwxyz  # âœ… ç»Ÿä¸€å¯†é’¥
  
spring:
  data:
    redis:
      host: localhost
      port: 6379
      password: ${redis.password}
      database: 0                 # âœ… å…¨å±€ä½¿ç”¨database 0
```

---

## 6. å®‰å…¨æœºåˆ¶

### 6.1 å®‰å…¨å±‚çº§

```
ç¬¬1å±‚é˜²æŠ¤: ç½‘å…³å¼ºåˆ¶è·¯ç”±
  â†“
ç¬¬2å±‚é˜²æŠ¤: Gateway AuthFilter (TokenéªŒè¯)
  â†“
ç¬¬3å±‚é˜²æŠ¤: ClientIdä¸€è‡´æ€§æ ¡éªŒ
  â†“
ç¬¬4å±‚é˜²æŠ¤: Same-TokenéªŒè¯ (é˜²æ­¢ç»•è¿‡Gateway)
  â†“
ç¬¬5å±‚é˜²æŠ¤: å¾®æœåŠ¡Controlleræƒé™æ³¨è§£
  â†“
ç¬¬6å±‚é˜²æŠ¤: Serviceå±‚ä¸šåŠ¡æƒé™æ ¡éªŒ
```

### 6.2 å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•

| é…ç½®é¡¹ | ä½ç½® | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|------|
| **check-same-token** | application-common.yml | âœ… true | å…¨å±€å¯ç”¨Same-Token |
| **jwt-secret-key** | application-common.yml | âœ… å·²é…ç½® | ç»Ÿä¸€å¯†é’¥ |
| **redis.database** | application-common.yml | âœ… 0 | æ‰€æœ‰æœåŠ¡ç»Ÿä¸€ |
| **SameTokenInitializer** | Gateway | âœ… å·²å®ç° | å¯åŠ¨æ—¶åˆå§‹åŒ– |
| **ForwardAuthFilter** | Gateway | âœ… å·²å®ç° | æ·»åŠ Same-Token |
| **SecurityConfiguration** | å„å¾®æœåŠ¡ | âœ… å·²å®ç° | éªŒè¯Same-Token |
| **RestTemplateConfig** | å„å¾®æœåŠ¡ | âœ… å·²å®ç° | è‡ªåŠ¨ä¼ é€’Token |

### 6.3 æ”»å‡»é˜²æŠ¤

#### é˜²æŠ¤1: é˜²æ­¢ç»•è¿‡Gatewayç›´æ¥è®¿é—®

```java
// âŒ æ”»å‡»è€…å°è¯•ç›´æ¥è®¿é—®å¾®æœåŠ¡
curl http://localhost:9401/api/v2/users/profile

// âš ï¸ ç»“æœ: 401 Unauthorized
// åŸå› : ç¼ºå°‘Same-Tokenï¼ŒSecurityConfigurationæ‹¦æˆª
```

#### é˜²æŠ¤2: é˜²æ­¢Tokenä¼ªé€ 

```java
// âŒ æ”»å‡»è€…ä½¿ç”¨ä¼ªé€ çš„Token
curl -H "Authorization: Bearer fake_token_xxxxx" \
     http://localhost:8080/xypai-user/api/v2/users/profile

// âš ï¸ ç»“æœ: 401 Unauthorized
// åŸå› : Gatewayçš„AuthFilteréªŒè¯Tokenå¤±è´¥
```

#### é˜²æŠ¤3: é˜²æ­¢ClientIdä¸åŒ¹é…

```java
// âŒ æ”»å‡»è€…ä½¿ç”¨appçš„Tokenè®¿é—®pcçš„èµ„æº
// Tokenä¸­çš„clientId = "app"
curl -H "Authorization: Bearer valid_token" \
     -H "clientid: pc" \  // âŒ ä¸åŒ¹é…
     http://localhost:8080/xypai-user/api/v2/users/profile

// âš ï¸ ç»“æœ: 401 Unauthorized
// åŸå› : GatewayéªŒè¯clientIdä¸ä¸€è‡´
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 JWT Simple Modeä¼˜åŠ¿

| ä¼ ç»Ÿæ¨¡å¼ | JWT Simple Mode | æ€§èƒ½æå‡ |
|---------|----------------|---------|
| æ¯æ¬¡è¯·æ±‚æŸ¥è¯¢Redis | ä¸æŸ¥è¯¢Redis | **10x** |
| Tokenå­˜å‚¨åœ¨Redis | Tokenè‡ªåŒ…å« | å‡å°‘Rediså‹åŠ› |
| éœ€è¦Tokenåˆ·æ–° | æ— éœ€åˆ·æ–° | ç®€åŒ–æµç¨‹ |

### 7.2 æ€§èƒ½å¯¹æ¯”æµ‹è¯•

```bash
# æµ‹è¯•åœºæ™¯: 100å¹¶å‘ï¼Œ1000è¯·æ±‚

# ä¼ ç»Ÿæ¨¡å¼ (æ¯æ¬¡æŸ¥è¯¢Redis)
QPS: 100
å¹³å‡å“åº”æ—¶é—´: 50ms
RedisæŸ¥è¯¢æ¬¡æ•°: 1000æ¬¡

# JWT Simple Mode (ä¸æŸ¥è¯¢Redis)
QPS: 1000  # âœ… æå‡10å€
å¹³å‡å“åº”æ—¶é—´: 5ms  # âœ… é™ä½10å€
RedisæŸ¥è¯¢æ¬¡æ•°: 0æ¬¡  # âœ… é›¶å‹åŠ›
```

### 7.3 ä¼˜åŒ–å»ºè®®

#### ä¼˜åŒ–1: åˆç†è®¾ç½®Tokenæœ‰æ•ˆæœŸ

```yaml
sa-token:
  timeout: 604800  # 7å¤©ï¼ˆæ¨èï¼‰
  active-timeout: 1800  # 30åˆ†é’Ÿæ´»è·ƒè¶…æ—¶ï¼ˆæ¨èï¼‰
```

#### ä¼˜åŒ–2: å¯ç”¨Redisè¿æ¥æ± 

```yaml
spring:
  data:
    redis:
      lettuce:
        pool:
          max-active: 200    # âœ… æœ€å¤§è¿æ¥æ•°
          max-idle: 10       # âœ… æœ€å¤§ç©ºé—²è¿æ¥
          min-idle: 5        # âœ… æœ€å°ç©ºé—²è¿æ¥
          max-wait: -1ms     # âœ… æœ€å¤§ç­‰å¾…æ—¶é—´
```

#### ä¼˜åŒ–3: Gatewayè¶…æ—¶é…ç½®

```yaml
spring:
  cloud:
    gateway:
      httpclient:
        connect-timeout: 1000    # 1ç§’
        response-timeout: 5000   # 5ç§’
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 ç™»å½•å®ç°æœ€ä½³å®è·µ

```java
@Service
public class AuthServiceImpl implements IAuthService {
    
    @Override
    public LoginResultVO login(LoginDTO loginDTO) {
        // âœ… 1. æ•°æ®éªŒè¯
        ValidationUtils.validate(loginDTO);
        
        // âœ… 2. æŸ¥è¯¢ç”¨æˆ·ï¼ˆå»ºè®®ä½¿ç”¨ç´¢å¼•å­—æ®µï¼‰
        AuthUserDTO user = userMapper.selectByPhoneOrUsername(
            loginDTO.getPhoneNumber(), 
            loginDTO.getUsername()
        );
        
        if (user == null) {
            throw new ServiceException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // âœ… 3. éªŒè¯è´¦å·çŠ¶æ€
        if (user.getStatus() != 0) {
            throw new ServiceException("è´¦å·å·²è¢«ç¦ç”¨");
        }
        
        // âœ… 4. éªŒè¯å¯†ç ï¼ˆä½¿ç”¨BCryptï¼‰
        if (!BCrypt.checkpw(loginDTO.getPassword(), user.getPassword())) {
            // âœ… è®°å½•å¤±è´¥æ¬¡æ•°ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
            recordLoginFailure(user.getId());
            throw new ServiceException("å¯†ç é”™è¯¯");
        }
        
        // âœ… 5. æ£€æŸ¥ç™»å½•å¤±è´¥æ¬¡æ•°
        if (getLoginFailureCount(user.getId()) >= 5) {
            throw new ServiceException("å¯†ç é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œè¯·30åˆ†é’Ÿåå†è¯•");
        }
        
        // âœ… 6. æ„å»ºLoginUserï¼ˆåŒ…å«å¿…è¦ä¿¡æ¯ï¼‰
        LoginUser loginUser = LoginUser.builder()
            .tenantId("000000")
            .userId(user.getId())
            .username(user.getUsername())
            .userType(UserType.APP_USER.getUserType())
            .loginId(UserType.APP_USER.getLoginId(user.getId()))
            .menuPermission(Set.of("app:*"))  // APPç”¨æˆ·åŸºç¡€æƒé™
            .rolePermission(Set.of("app_user"))
            .build();
        
        // âœ… 7. é…ç½®ç™»å½•å‚æ•°
        SaLoginParameter loginModel = new SaLoginParameter();
        loginModel.setDeviceType(loginDTO.getClientType());  // è®¾å¤‡ç±»å‹
        loginModel.setTimeout(86400L);  // 24å°æ—¶
        loginModel.setExtra("clientType", loginDTO.getClientType());  // âœ… å…³é”®
        loginModel.setExtra("deviceId", loginDTO.getDeviceId());
        
        // âœ… 8. æ‰§è¡Œç™»å½•
        LoginHelper.login(loginUser, loginModel);
        
        // âœ… 9. è·å–Token
        String token = StpUtil.getTokenValue();
        
        // âœ… 10. è®°å½•ç™»å½•æ—¥å¿—ï¼ˆå¼‚æ­¥ï¼‰
        recordLoginLog(user.getId(), loginDTO);
        
        // âœ… 11. æ¸…ç©ºå¤±è´¥æ¬¡æ•°
        clearLoginFailureCount(user.getId());
        
        // âœ… 12. è¿”å›ç»“æœ
        return LoginResultVO.builder()
            .accessToken(token)
            .tokenType("Bearer")
            .expiresIn(86400L)
            .userId(user.getId())
            .username(user.getUsername())
            .build();
    }
}
```

### 8.2 Controlleræœ€ä½³å®è·µ

```java
@Slf4j
@Tag(name = "ç”¨æˆ·ç®¡ç†", description = "ç”¨æˆ·CRUDæ¥å£")
@RestController
@RequestMapping("/api/v2/users")
@RequiredArgsConstructor
@Validated
public class UserController {
    
    private final IUserService userService;
    
    /**
     * âœ… æœ€ä½³å®è·µ1: ä½¿ç”¨æ³¨è§£é‰´æƒ
     */
    @Operation(summary = "è·å–ç”¨æˆ·èµ„æ–™", description = "éœ€è¦ç™»å½•")
    @SaCheckLogin  // âœ… ç™»å½•æ ¡éªŒ
    @GetMapping("/profile")
    public R<UserProfileVO> getProfile() {
        // âœ… ä½¿ç”¨LoginHelperè·å–ç”¨æˆ·ä¿¡æ¯
        Long userId = LoginHelper.getUserId();
        String username = LoginHelper.getUsername();
        
        log.info("ç”¨æˆ· {} ({}) æŸ¥è¯¢ä¸ªäººèµ„æ–™", username, userId);
        
        return R.ok(userService.getProfile(userId));
    }
    
    /**
     * âœ… æœ€ä½³å®è·µ2: æƒé™+è§’è‰²åŒé‡æ ¡éªŒ
     */
    @Operation(summary = "åˆ é™¤ç”¨æˆ·", description = "éœ€è¦user:deleteæƒé™æˆ–adminè§’è‰²")
    @SaCheckPermission(value = "user:delete", orRole = "admin")
    @DeleteMapping("/{id}")
    public R<Void> deleteUser(@PathVariable Long id) {
        // âœ… é¢å¤–çš„ä¸šåŠ¡æƒé™æ ¡éªŒ
        Long currentUserId = LoginHelper.getUserId();
        if (id.equals(currentUserId)) {
            throw new ServiceException("ä¸èƒ½åˆ é™¤è‡ªå·±");
        }
        
        return userService.deleteUser(id);
    }
    
    /**
     * âœ… æœ€ä½³å®è·µ3: ä½¿ç”¨@SaIgnoreå¿½ç•¥æŸäº›æ¥å£
     */
    @Operation(summary = "è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆå…¬å¼€ï¼‰", description = "æ— éœ€ç™»å½•")
    @SaIgnore  // âœ… å¿½ç•¥ç™»å½•æ ¡éªŒ
    @GetMapping("/public/list")
    public R<List<UserVO>> getPublicList() {
        return R.ok(userService.getPublicUserList());
    }
    
    /**
     * âœ… æœ€ä½³å®è·µ4: æ‰¹é‡æ³¨è§£æ ¡éªŒ
     */
    @Operation(summary = "è·å–æ•æ„Ÿæ•°æ®", description = "éœ€è¦ç™»å½•+æƒé™æˆ–adminè§’è‰²")
    @SaCheckOr(
        login = @SaCheckLogin,
        permission = @SaCheckPermission("user:sensitive"),
        role = @SaCheckRole("admin")
    )
    @GetMapping("/sensitive/{id}")
    public R<SensitiveDataVO> getSensitiveData(@PathVariable Long id) {
        return R.ok(userService.getSensitiveData(id));
    }
}
```

### 8.3 è·¨æœåŠ¡è°ƒç”¨æœ€ä½³å®è·µ

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class ContentServiceImpl implements IContentService {
    
    private final RestTemplate restTemplate;  // ä½¿ç”¨é…ç½®å¥½çš„RestTemplate
    
    /**
     * âœ… æœ€ä½³å®è·µ: è·¨æœåŠ¡è°ƒç”¨è‡ªåŠ¨æºå¸¦Token
     */
    @Override
    public ContentDetailVO getContentDetail(Long contentId) {
        // 1ï¸âƒ£ è·å–å†…å®¹åŸºæœ¬ä¿¡æ¯
        Content content = contentMapper.selectById(contentId);
        
        // 2ï¸âƒ£ è°ƒç”¨ç”¨æˆ·æœåŠ¡è·å–ä½œè€…ä¿¡æ¯ï¼ˆâœ… è‡ªåŠ¨æºå¸¦Tokenï¼‰
        String userUrl = "http://localhost:9401/api/v2/users/" + content.getAuthorId();
        
        try {
            UserProfileVO author = restTemplate.getForObject(userUrl, UserProfileVO.class);
            
            // 3ï¸âƒ£ ç»„è£…è¿”å›æ•°æ®
            return ContentDetailVO.builder()
                .contentId(content.getId())
                .title(content.getTitle())
                .content(content.getContent())
                .author(author)  // âœ… æˆåŠŸè·å–ä½œè€…ä¿¡æ¯
                .build();
                
        } catch (Exception e) {
            log.error("è°ƒç”¨ç”¨æˆ·æœåŠ¡å¤±è´¥: {}", e.getMessage());
            // âœ… é™çº§å¤„ç†ï¼šè¿”å›åŸºæœ¬ä¿¡æ¯
            return ContentDetailVO.builder()
                .contentId(content.getId())
                .title(content.getTitle())
                .content(content.getContent())
                .build();
        }
    }
}
```

---

## 9. æ•…éšœæ’æŸ¥

### 9.1 å¸¸è§é—®é¢˜

#### é—®é¢˜1: 401 Unauthorized

**ç°è±¡**:
```json
{
  "code": 401,
  "msg": "è®¤è¯å¤±è´¥ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº"
}
```

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1ï¸âƒ£ æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:8080/xypai-user/api/v2/users/profile

# 2ï¸âƒ£ æ£€æŸ¥Tokenæ ¼å¼
# âœ… æ­£ç¡®: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
# âŒ é”™è¯¯: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...  (ç¼ºå°‘Bearerå‰ç¼€)

# 3ï¸âƒ£ æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
# ç™»å½•æ—¶è¿”å›çš„expiresInæ˜¯å¤šå°‘ç§’

# 4ï¸âƒ£ æ£€æŸ¥ClientIdæ˜¯å¦ä¸€è‡´
# ç™»å½•æ—¶ç”¨çš„æ˜¯ "app"ï¼Œè¯·æ±‚æ—¶ä¹Ÿå¿…é¡»æ˜¯ "app"

# 5ï¸âƒ£ æŸ¥çœ‹Gatewayæ—¥å¿—
# çœ‹æ˜¯å“ªä¸ªç¯èŠ‚å¤±è´¥çš„
```

#### é—®é¢˜2: ClientIdä¸åŒ¹é…

**ç°è±¡**:
```
å®¢æˆ·ç«¯IDä¸Tokenä¸åŒ¹é…
```

**åŸå› **: ç™»å½•æ—¶çš„ClientIdå’Œè¯·æ±‚æ—¶çš„ClientIdä¸ä¸€è‡´

**è§£å†³**:
```java
// âœ… ç¡®ä¿ç™»å½•æ—¶è®¾ç½®ClientId
SaLoginParameter loginModel = new SaLoginParameter();
loginModel.setDeviceType("app");  // âœ… è®¾å¤‡ç±»å‹
loginModel.setExtra("clientType", "app");  // âœ… ClientId

// âœ… ç¡®ä¿è¯·æ±‚æ—¶ä¼ é€’ç›¸åŒçš„ClientId
HttpHeaders headers = new HttpHeaders();
headers.set("Authorization", "Bearer " + token);
headers.set("clientid", "app");  // âœ… å¿…é¡»ä¸€è‡´
```

#### é—®é¢˜3: Same-TokenéªŒè¯å¤±è´¥

**ç°è±¡**:
```
æ— æ•ˆSame-Token
```

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1ï¸âƒ£ æ£€æŸ¥Gatewayæ˜¯å¦å¯åŠ¨äº†SameTokenInitializer
# æŸ¥çœ‹Gatewayå¯åŠ¨æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°:
ğŸ” [SAME-TOKEN INIT] å¼€å§‹åˆå§‹åŒ–Same-Token...
âœ… Same-Tokenå·²å­˜å‚¨åˆ°Redisï¼Œæœ‰æ•ˆæœŸ 7 å¤©

# 2ï¸âƒ£ æ£€æŸ¥Redisä¸­æ˜¯å¦æœ‰Same-Token
redis-cli
> GET satoken:var:same-token
# åº”è¯¥è¿”å›ä¸€ä¸ª64å­—ç¬¦çš„å­—ç¬¦ä¸²

# 3ï¸âƒ£ æ£€æŸ¥æ‰€æœ‰å¾®æœåŠ¡çš„Redisé…ç½®æ˜¯å¦ä¸€è‡´
# éƒ½å¿…é¡»ä½¿ç”¨ database: 0

# 4ï¸âƒ£ æ£€æŸ¥check-same-tokené…ç½®
# application-common.ymlä¸­åº”è¯¥æ˜¯ true

# 5ï¸âƒ£ é‡å¯Gatewayå’Œå¾®æœåŠ¡
```

#### é—®é¢˜4: è·¨æœåŠ¡è°ƒç”¨401

**ç°è±¡**: Gatewayè®¤è¯é€šè¿‡ï¼Œä½†è°ƒç”¨å…¶ä»–å¾®æœåŠ¡å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:

```java
// 1ï¸âƒ£ æ£€æŸ¥RestTemplateConfigæ˜¯å¦é…ç½®
@Configuration
public class RestTemplateConfig {
    @Bean
    public RestTemplate restTemplate() {
        // âœ… å¿…é¡»é…ç½®æ‹¦æˆªå™¨
    }
}

// 2ï¸âƒ£ æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„RestTemplate
@Autowired
private RestTemplate restTemplate;  // âœ… ä½¿ç”¨Beanæ³¨å…¥çš„
// âŒ ä¸è¦: RestTemplate restTemplate = new RestTemplate();

// 3ï¸âƒ£ æŸ¥çœ‹è¯·æ±‚æ—¥å¿—
// åº”è¯¥çœ‹åˆ°: ğŸ” [RestTemplate] å·²æ³¨å…¥Tokenåˆ°è¯·æ±‚

// 4ï¸âƒ£ ä½¿ç”¨curlæµ‹è¯•
curl -H "Authorization: Bearer TOKEN" \
     -H "clientid: app" \
     http://localhost:9401/api/v2/users/profile
```

### 9.2 è°ƒè¯•æŠ€å·§

#### æŠ€å·§1: å¼€å¯DEBUGæ—¥å¿—

```yaml
logging:
  level:
    com.xypai: DEBUG
    org.dromara: DEBUG
    cn.dev33.satoken: DEBUG
```

#### æŠ€å·§2: æ‰“å°Tokenä¿¡æ¯

```java
// åœ¨Controllerä¸­æ‰“å°
log.info("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
log.info("Tokenä¿¡æ¯:");
log.info("  Token: {}", StpUtil.getTokenValue());
log.info("  LoginId: {}", StpUtil.getLoginId());
log.info("  UserId: {}", LoginHelper.getUserId());
log.info("  Username: {}", LoginHelper.getUsername());
log.info("  ClientId: {}", LoginHelper.getClient());
log.info("  å‰©ä½™æ—¶é—´: {} ç§’", StpUtil.getTokenTimeout());
log.info("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
```

#### æŠ€å·§3: ä½¿ç”¨æµ‹è¯•æ¥å£

```bash
# æµ‹è¯•Tokenæœ‰æ•ˆæ€§
GET http://localhost:9405/api/v1/test/token/check
Authorization: Bearer YOUR_TOKEN
clientid: app

# è·å–Tokenè¯¦ç»†ä¿¡æ¯
GET http://localhost:9405/api/v1/test/token/info
Authorization: Bearer YOUR_TOKEN
clientid: app

# æµ‹è¯•è·¨æœåŠ¡è°ƒç”¨
GET http://localhost:9405/api/v1/test/token/call-other-service?targetUrl=http://localhost:9401/api/v2/users/profile
Authorization: Bearer YOUR_TOKEN
clientid: app
```

---

## 10. å‡çº§æŒ‡å—

### 10.1 ä»v1.0å‡çº§åˆ°v3.0

#### Step 1: æ›´æ–°ä¾èµ–

```xml
<!-- å‡çº§Sa-Tokenç‰ˆæœ¬ -->
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-spring-boot3-starter</artifactId>
    <version>1.44.0</version>
</dependency>
```

#### Step 2: æ·»åŠ SameTokenInitializer

```bash
# åœ¨Gatewayæ¨¡å—æ·»åŠ 
cp SameTokenInitializer.java ruoyi-gateway/src/main/java/org/dromara/gateway/config/
```

#### Step 3: æ›´æ–°Redisé…ç½®

```yaml
# æ‰€æœ‰å¾®æœåŠ¡çš„application.yml
spring:
  data:
    redis:
      database: 0  # âœ… ç»Ÿä¸€ä½¿ç”¨database 0
```

#### Step 4: æ·»åŠ RestTemplateConfig

```bash
# åœ¨æ‰€æœ‰éœ€è¦è·¨æœåŠ¡è°ƒç”¨çš„å¾®æœåŠ¡ä¸­æ·»åŠ 
xypai-user/src/main/java/com/xypai/user/config/RestTemplateConfig.java
xypai-content/src/main/java/com/xypai/content/config/RestTemplateConfig.java
xypai-chat/src/main/java/com/xypai/chat/config/RestTemplateConfig.java
```

#### Step 5: æµ‹è¯•éªŒè¯

```bash
# 1. é‡å¯Gateway
# 2. é‡å¯å„å¾®æœåŠ¡
# 3. è¿è¡Œæµ‹è¯•
mvn test -Dtest=SimpleSaTokenTest
```

---

## ğŸ“š é™„å½•

### A. é…ç½®æ–‡ä»¶æ¨¡æ¿

#### A.1 application-common.yml (Nacos)

```yaml
# Sa-Tokenå…¨å±€é…ç½®
sa-token:
  token-name: Authorization
  timeout: 604800  # 7å¤©
  active-timeout: 1800  # 30åˆ†é’Ÿ
  is-concurrent: true
  is-share: false
  check-same-token: true
  same-token-timeout: 604800
  jwt-secret-key: your-secret-key-here
  
spring:
  data:
    redis:
      host: ${redis.host:localhost}
      port: ${redis.port:6379}
      password: ${redis.password:}
      database: 0  # âœ… å…¨å±€ç»Ÿä¸€
```

#### A.2 å¾®æœåŠ¡application.ymlæ¨¡æ¿

```yaml
spring:
  application:
    name: xypai-user
  cloud:
    nacos:
      discovery:
        server-addr: ${nacos.server-addr:localhost:8848}
        
sa-token:
  token-name: Authorization
  check-same-token: true
```

### B. APIæ¥å£æ¸…å•

| æ¨¡å— | æ¥å£è·¯å¾„ | æ–¹æ³• | è¯´æ˜ | é‰´æƒ |
|-----|---------|------|------|------|
| **è®¤è¯** | `/api/v1/auth/login` | POST | å¯†ç ç™»å½• | å…¬å¼€ |
| **è®¤è¯** | `/api/v1/auth/logout` | POST | ç”¨æˆ·ç™»å‡º | âœ… |
| **ç”¨æˆ·** | `/api/v2/users/profile` | GET | è·å–èµ„æ–™ | âœ… |
| **ç”¨æˆ·** | `/api/v2/users/{id}` | GET | è·å–ç”¨æˆ· | âœ… |
| **å†…å®¹** | `/api/v1/homepage/users/list` | GET | é¦–é¡µåˆ—è¡¨ | âœ… |
| **å†…å®¹** | `/api/v2/content/{id}` | GET | å†…å®¹è¯¦æƒ… | âœ… |

### C. å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹Redisä¸­çš„Token
redis-cli
> KEYS satoken:*
> GET satoken:login:token:xxx
> GET satoken:var:same-token

# æŸ¥çœ‹Nacosé…ç½®
curl http://localhost:8848/nacos/v1/cs/configs?dataId=application-common.yml&group=DEFAULT_GROUP

# Gatewayæ—¥å¿—
docker logs -f ruoyi-gateway

# å¾®æœåŠ¡æ—¥å¿—
docker logs -f xypai-user

# æµ‹è¯•Token
curl -H "Authorization: Bearer TOKEN" \
     -H "clientid: app" \
     http://localhost:8080/xypai-user/api/v2/users/profile
```

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

| ç‰¹æ€§ | ä¼˜åŠ¿ |
|-----|------|
| **åŒTokenæœºåˆ¶** | æ—¢éªŒè¯ç”¨æˆ·èº«ä»½ï¼ŒåˆéªŒè¯è¯·æ±‚æ¥æº |
| **JWT Simple Mode** | æ€§èƒ½æå‡10å€+ï¼Œå‡å°‘Rediså‹åŠ› |
| **ç½‘å…³ç»Ÿä¸€é‰´æƒ** | å®‰å…¨æ€§æœ€å¤§åŒ–ï¼Œç»Ÿä¸€è®¤è¯å…¥å£ |
| **è‡ªåŠ¨Tokenä¼ é€’** | ç®€åŒ–å¼€å‘ï¼Œé™ä½å‡ºé”™æ¦‚ç‡ |
| **çµæ´»æƒé™ç®¡ç†** | æ”¯æŒæ³¨è§£/ç¼–ç¨‹/è·¯ç”±ä¸‰ç§é‰´æƒæ–¹å¼ |

### ç”Ÿäº§å°±ç»ªæ£€æŸ¥æ¸…å•

- [x] âœ… LoginHelper å®ç°å®Œæ•´
- [x] âœ… SaPermissionImpl æƒé™æ¥å£å®ç°
- [x] âœ… Gateway AuthFilter è®¤è¯è¿‡æ»¤å™¨
- [x] âœ… SameTokenInitializer åˆå§‹åŒ–å™¨
- [x] âœ… ForwardAuthFilter Same-Tokenæ·»åŠ 
- [x] âœ… SecurityConfiguration Same-TokenéªŒè¯
- [x] âœ… SaTokenExceptionHandler å¼‚å¸¸å¤„ç†
- [x] âœ… GlobalExceptionHandler å…¨å±€å¼‚å¸¸
- [x] âœ… RestTemplateConfig è‡ªåŠ¨æ³¨å…¥Token
- [x] âœ… Redisé…ç½®ç»Ÿä¸€ (database: 0)
- [x] âœ… æµ‹è¯•ç”¨ä¾‹é€šè¿‡

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0  
**æœ€åæ›´æ–°**: 2025-11-08  
**ç»´æŠ¤å›¢é˜Ÿ**: DevTeam + AI Assistant  

**æ¨èé˜…è¯»é¡ºåº**:
1. æœ¬æ–‡æ¡£ (å®Œæ•´æ¶æ„)
2. [Same-Tokenæ¶æ„è¯´æ˜.md](../xypai-content/Same-Tokenæ¶æ„è¯´æ˜.md)
3. [ğŸ“š_SA_TOKEN_ä½¿ç”¨æŒ‡å—.md](../xypai-security/ğŸ“š_SA_TOKEN_ä½¿ç”¨æŒ‡å—.md)
4. [ğŸ”—_è·¨æœåŠ¡Tokenä¼ é€’é…ç½®.md](../xypai-security/ğŸ”—_è·¨æœåŠ¡Tokenä¼ é€’é…ç½®.md)

ğŸš€ **é¡¹ç›®å·²å®Œæˆ Sa-Token å®Œæ•´é€‚é…ï¼Œå¯æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼**

