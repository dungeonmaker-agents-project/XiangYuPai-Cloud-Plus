# 🏗️ Token机制架构图

> **通过架构图全面理解Token在系统中的位置和作用**

---

## 🎨 系统架构全景图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                 RuoYi-Cloud-Plus 系统架构                                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                                    ┌───────────────┐
                                    │   客户端       │
                                    │  (Web/App)    │
                                    └───────┬───────┘
                                            │
                                            │ ① POST /login
                                            │    {username, password}
                                            │
                                            ↓
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│                                       Gateway 网关层                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│  │ AuthFilter (Token验证拦截器)                                                          │ │
│  │  ├─ 1. 提取Token from Header                                                         │ │
│  │  ├─ 2. StpUtil.checkLogin() [验证Token]                                             │ │
│  │  └─ 3. 转发到后端服务                                                                  │ │
│  └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                           │
│  路由规则:                                                                                 │
│  ├─ /auth/**  ──▶ Auth Service                                                           │
│  ├─ /system/** ──▶ RuoYi-System                                                          │
│  ├─ /demo/**   ──▶ RuoYi-Demo                                                            │
│  └─ /xypai-content/** ──▶ XYPai-Content                                                  │
└───────────────┬──────────────────────────────────────────────────────────────────────────┘
                │
                ├──────────────┬──────────────┬──────────────┬──────────────┐
                │              │              │              │              │
                ↓              ↓              ↓              ↓              ↓
    ┌─────────────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────────┐
    │  Auth Service   │  │  System  │  │   Demo   │  │  Content │  │   其他服务   │
    │   (认证服务)     │  │  (系统)   │  │  (演示)   │  │  (内容)   │  │   (业务)    │
    └────────┬────────┘  └─────┬────┘  └─────┬────┘  └─────┬────┘  └──────┬──────┘
             │                 │              │              │              │
             │                 │              │              │              │
             │                 └──────────────┴──────────────┴──────────────┤
             │                                                               │
             │                           使用LoginHelper获取用户信息          │
             │                           ├─ LoginHelper.getUserId()         │
             │                           ├─ LoginHelper.getUsername()       │
             │                           └─ LoginHelper.getLoginUser()      │
             │                                                               │
             └───────────────────────────────────────────────────────────────┤
                                                                             │
                                                                             ↓
┌────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  Sa-Token + Redis 缓存层                                    │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐ │
│  │ PlusSaTokenDao (多级缓存)                                                              │ │
│  │                                                                                        │ │
│  │  ┌─────────────────────────────┐         ┌─────────────────────────────┐            │ │
│  │  │  Caffeine本地缓存            │         │  Redis分布式缓存             │            │ │
│  │  │  ─────────────────────       │         │  ─────────────────────      │            │ │
│  │  │  - 缓存时间: 5秒             │         │  - 缓存时间: 1800秒          │            │ │
│  │  │  - 最大容量: 1000条          │  ◀────▶ │  - 持久化存储                │            │ │
│  │  │  - 响应时间: ~0.1ms          │         │  - 响应时间: ~5ms            │            │ │
│  │  │  - 作用: 减少网络IO           │         │  - 作用: 跨服务共享          │            │ │
│  │  └─────────────────────────────┘         └─────────────────────────────┘            │ │
│  │                                                                                        │ │
│  │  存储内容:                                                                              │ │
│  │  ├─ satoken:login:token:{token}         = "1" (用户ID)                               │ │
│  │  ├─ satoken:login:session:{token}       = {LoginUser对象}                            │ │
│  │  ├─ satoken:login:extra:{token}:userId  = "1"                                        │ │
│  │  ├─ satoken:login:extra:{token}:tenantId = "000000"                                  │ │
│  │  ├─ satoken:login:id:1                  = ["token1", "token2"]                       │ │
│  │  └─ satoken:login:last-active:{token}   = 1699999999999                              │ │
│  └──────────────────────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────────────────────────┘

                                            ↓ 持久化
┌────────────────────────────────────────────────────────────────────────────────────────────┐
│                                       数据库层                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                                    │
│  │  sys_user    │  │  sys_role    │  │  sys_menu    │  ...                               │
│  │  (用户表)     │  │  (角色表)     │  │  (菜单表)     │                                    │
│  └──────────────┘  └──────────────┘  └──────────────┘                                    │
└────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Token创建时序图

```
客户端         Gateway         Auth Service         LoginHelper         Sa-Token         Redis
  │               │                 │                    │                  │              │
  ├──POST /login──▶               │                    │                  │              │
  │               │                 │                    │                  │              │
  │               ├─────转发────────▶                   │                  │              │
  │               │                 │                    │                  │              │
  │               │                 ├─验证密码(BCrypt)    │                  │              │
  │               │                 │                    │                  │              │
  │               │                 ├─调用login()────────▶                 │              │
  │               │                 │                    │                  │              │
  │               │                 │                    ├─StpUtil.login()─▶              │
  │               │                 │                    │                  │              │
  │               │                 │                    │                  ├─生成JWT Token │
  │               │                 │                    │                  │              │
  │               │                 │                    │                  ├─存储Token────▶
  │               │                 │                    │                  │              │
  │               │                 │                    │                  │ 存储Extra信息▶
  │               │                 │                    │                  │              │
  │               │                 │                    ├─存储LoginUser────────────────────▶
  │               │                 │                    │                  │              │
  │               │                 │◀─────返回Token─────┤                  │              │
  │               │                 │                    │                  │              │
  │               │◀────返回Token───┤                    │                  │              │
  │               │                 │                    │                  │              │
  │◀──返回Token───┤                 │                    │                  │              │
  │               │                 │                    │                  │              │
  │ 保存Token     │                 │                    │                  │              │
  │ (LocalStorage)│                 │                    │                  │              │
  │               │                 │                    │                  │              │

耗时分析:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤                │ 耗时      │ 说明
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Gateway转发         │ ~1ms     │ 网络延迟
BCrypt密码验证      │ ~100ms   │ 加密算法计算密集
数据库查询用户      │ ~10ms    │ MySQL查询
Sa-Token生成JWT     │ ~1ms     │ JWT签名
Redis存储Token      │ ~5ms     │ 网络IO + 序列化
总耗时             │ ~120ms   │ 主要耗时在BCrypt
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🚀 Token使用时序图

```
客户端         Gateway         Service         LoginHelper         Caffeine         Redis
  │               │                │                 │                  │              │
  ├─GET /api/user─▶               │                 │                  │              │
  │  +Token       │                │                 │                  │              │
  │               │                │                 │                  │              │
  │               ├─验证Token────────────────────────────────────────────────────────▶ 查询
  │               │                │                 │                  │              │
  │               │◀──Token有效────────────────────────────────────────────────────────┤
  │               │                │                 │                  │              │
  │               ├───转发请求─────▶                 │                  │              │
  │               │  +Token        │                 │                  │              │
  │               │                │                 │                  │              │
  │               │                ├─getUserId()─────▶                  │              │
  │               │                │                 │                  │              │
  │               │                │                 ├─查询Caffeine─────▶              │
  │               │                │                 │                  │              │
  │               │                │                 │◀─未命中──────────┤              │
  │               │                │                 │                  │              │
  │               │                │                 ├─查询Redis──────────────────────▶
  │               │                │                 │                  │              │
  │               │                │                 │◀────userId=1────────────────────┤
  │               │                │                 │                  │              │
  │               │                │                 ├─写回Caffeine─────▶              │
  │               │                │                 │                  │              │
  │               │                │◀────userId=1────┤                  │              │
  │               │                │                 │                  │              │
  │               │                ├─查询数据库       │                  │              │
  │               │                │                 │                  │              │
  │               │                ├─构建响应        │                  │              │
  │               │                │                 │                  │              │
  │               │◀───返回结果────┤                 │                  │              │
  │               │                │                 │                  │              │
  │◀──返回结果────┤                │                 │                  │              │
  │               │                │                 │                  │              │

性能分析:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤                      │ 首次    │ 后续     │ 缓存命中
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Gateway验证Token         │ ~5ms   │ ~0.5ms  │ Caffeine
Service获取userId        │ ~5ms   │ ~0.1ms  │ Caffeine
数据库查询               │ ~10ms  │ ~10ms   │ 无缓存
总耗时                   │ ~20ms  │ ~10ms   │ 50%性能提升
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 📦 Redis存储结构详图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         Redis存储结构（以Token为中心）                        │
└────────────────────────────────────────────────────────────────────────────┘

Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2dpbklkIjoiMSJ9.xxxxx
  │
  ├─ 📦 Key 1: Token基础映射（快速查找UserId）
  │   ┌────────────────────────────────────────────────────────┐
  │   │ satoken:login:token:{tokenValue}                       │
  │   ├────────────────────────────────────────────────────────┤
  │   │ Value: "1"                                             │
  │   │ Type: String                                           │
  │   │ TTL: 1800秒                                             │
  │   │ Size: ~10 bytes                                        │
  │   │ 作用: Token → UserId 快速映射                            │
  │   └────────────────────────────────────────────────────────┘
  │
  ├─ 📦 Key 2: Token会话（完整用户对象）
  │   ┌────────────────────────────────────────────────────────┐
  │   │ satoken:login:session:{tokenValue}                     │
  │   ├────────────────────────────────────────────────────────┤
  │   │ Value: {                                               │
  │   │   "loginUser": {                                       │
  │   │     "userId": 1,                                       │
  │   │     "username": "admin",                               │
  │   │     "tenantId": "000000",                              │
  │   │     "deptId": 103,                                     │
  │   │     "deptName": "研发部门",                             │
  │   │     "roles": ["admin"],                                │
  │   │     "roleIds": [1],                                    │
  │   │     "permissions": ["*:*:*"],                          │
  │   │     "menuIds": [1, 2, 3, ...],                         │
  │   │     "clientKey": "e5cd7e48...",                        │
  │   │     "deviceType": "pc"                                 │
  │   │   }                                                    │
  │   │ }                                                      │
  │   │ Type: Object (序列化)                                   │
  │   │ TTL: 1800秒                                             │
  │   │ Size: ~2KB                                             │
  │   │ 作用: 存储完整用户信息（需要反序列化）                     │
  │   │ 性能: 读取耗时 ~5ms                                      │
  │   └────────────────────────────────────────────────────────┘
  │
  ├─ 📦 Key 3-7: Token Extra（轻量级元数据）
  │   ┌────────────────────────────────────────────────────────┐
  │   │ satoken:login:extra:{tokenValue}:userId                │
  │   ├────────────────────────────────────────────────────────┤
  │   │ Value: "1"                                             │
  │   │ TTL: 1800秒                                             │
  │   │ 作用: 快速获取用户ID（无需反序列化）                      │
  │   └────────────────────────────────────────────────────────┘
  │   ┌────────────────────────────────────────────────────────┐
  │   │ satoken:login:extra:{tokenValue}:tenantId              │
  │   ├────────────────────────────────────────────────────────┤
  │   │ Value: "000000"                                        │
  │   │ TTL: 1800秒                                             │
  │   │ 作用: 快速获取租户ID                                     │
  │   └────────────────────────────────────────────────────────┘
  │   ┌────────────────────────────────────────────────────────┐
  │   │ satoken:login:extra:{tokenValue}:userName              │
  │   ├────────────────────────────────────────────────────────┤
  │   │ Value: "admin"                                         │
  │   │ TTL: 1800秒                                             │
  │   │ 作用: 快速获取用户名                                     │
  │   └────────────────────────────────────────────────────────┘
  │   ┌────────────────────────────────────────────────────────┐
  │   │ satoken:login:extra:{tokenValue}:clientid              │
  │   ├────────────────────────────────────────────────────────┤
  │   │ Value: "e5cd7e4891bf95d1d19206ce24a7b32e"             │
  │   │ TTL: 1800秒                                             │
  │   │ 作用: 快速获取客户端ID                                   │
  │   └────────────────────────────────────────────────────────┘
  │   ┌────────────────────────────────────────────────────────┐
  │   │ satoken:login:extra:{tokenValue}:deptId                │
  │   ├────────────────────────────────────────────────────────┤
  │   │ Value: "103"                                           │
  │   │ TTL: 1800秒                                             │
  │   │ 作用: 快速获取部门ID                                     │
  │   └────────────────────────────────────────────────────────┘
  │
  ├─ 📦 Key 8: 用户Token列表（多设备支持）
  │   ┌────────────────────────────────────────────────────────┐
  │   │ satoken:login:id:1                                     │
  │   ├────────────────────────────────────────────────────────┤
  │   │ Value: [                                               │
  │   │   "eyJhbGc...token1",   // PC设备Token                 │
  │   │   "eyJhbGc...token2"    // App设备Token                │
  │   │ ]                                                      │
  │   │ Type: List                                             │
  │   │ TTL: 永久（会随着Token删除自动更新）                       │
  │   │ 作用: 管理用户的所有在线设备                              │
  │   │ 功能: 支持踢出指定设备、查看在线设备列表                    │
  │   └────────────────────────────────────────────────────────┘
  │
  └─ 📦 Key 9: 最后活跃时间（活跃超时检测）
      ┌────────────────────────────────────────────────────────┐
      │ satoken:login:last-active:{tokenValue}                 │
      ├────────────────────────────────────────────────────────┤
      │ Value: 1699999999999                                   │
      │ Type: Long (时间戳)                                     │
      │ TTL: 1800秒                                             │
      │ 作用: 记录最后一次活跃时间                               │
      │ 功能: 支持活跃超时（N分钟无操作自动失效）                  │
      └────────────────────────────────────────────────────────┘

存储统计:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Key类型          │ 数量  │ 大小     │ 用途         │ 访问频率
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Token基础映射    │  1   │ ~10B    │ 快速查找     │ 中
Token Session    │  1   │ ~2KB    │ 完整信息     │ 低
Token Extra      │  5   │ ~50B    │ 元数据       │ 极高 ⭐⭐⭐⭐⭐
用户Token列表    │  1   │ ~100B   │ 设备管理     │ 低
最后活跃时间     │  1   │ ~20B    │ 超时检测     │ 中
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总计            │  9   │ ~2.2KB  │ 单Token占用  │ -
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 优化建议:
  - 优先使用Token Extra（访问频率极高，大小小）
  - 避免频繁访问Token Session（大小大，需要反序列化）
  - Caffeine缓存覆盖Token Extra（减少Redis访问）
```

---

## 🔍 多级缓存架构详图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                           多级缓存工作流程                                    │
└────────────────────────────────────────────────────────────────────────────┘

请求: LoginHelper.getUserId()
  │
  ↓
┌──────────────────────────────────────────────────────────────────────────┐
│ 第1层: Caffeine本地缓存（JVM内存）                                         │
│ ─────────────────────────────────────────────────────────────────────── │
│                                                                          │
│  Key: satoken:login:extra:{token}:userId                                │
│  Value: "1"                                                             │
│                                                                          │
│  配置:                                                                   │
│  ├─ 过期策略: expireAfterWrite(5秒)                                      │
│  ├─ 初始容量: 100条                                                       │
│  ├─ 最大容量: 1000条                                                      │
│  └─ 淘汰策略: LRU                                                         │
│                                                                          │
│  性能:                                                                   │
│  ├─ 命中率: 80% (5秒内的重复请求)                                         │
│  ├─ 响应时间: ~0.1ms                                                      │
│  ├─ 网络IO: 无                                                            │
│  └─ QPS: 50,000+                                                         │
│                                                                          │
│  特点:                                                                   │
│  ✅ 极快速度（纳秒级）                                                     │
│  ✅ 零网络开销                                                            │
│  ⚠️  不跨服务共享                                                         │
│  ⚠️  5秒过期（需要刷新）                                                   │
└──────────────────────────────────────────────────────────────────────────┘
           │
           ├─ 命中 ──────────────────────────────────┐
           │                                         │
           └─ 未命中                                   │
              ↓                                      │
┌──────────────────────────────────────────────────────────────────────────┐
│ 第2层: Redis分布式缓存（网络存储）                                          │
│ ─────────────────────────────────────────────────────────────────────── │
│                                                                          │
│  Key: satoken:login:extra:{token}:userId                                │
│  Value: "1"                                                             │
│                                                                          │
│  配置:                                                                   │
│  ├─ 过期时间: 1800秒（30分钟）                                            │
│  ├─ 持久化: RDB + AOF                                                    │
│  └─ 连接池: lettuce (默认)                                                │
│                                                                          │
│  性能:                                                                   │
│  ├─ 响应时间: ~5ms                                                        │
│  ├─ 网络IO: 有（局域网）                                                   │
│  └─ QPS: 5,000                                                           │
│                                                                          │
│  特点:                                                                   │
│  ✅ 跨服务共享                                                            │
│  ✅ 持久化可靠                                                            │
│  ✅ 支持集群                                                              │
│  ⚠️  有网络延迟                                                           │
└──────────────────────────────────────────────────────────────────────────┘
              │                                      │
              └─ 查询成功 ─┐                          │
                          ↓                          │
              ┌────────────────────────┐             │
              │ 写回Caffeine缓存         │             │
              │ (下次请求直接命中)        │             │
              └────────────────────────┘             │
                          │                          │
                          └──────────────────────────┤
                                                     ↓
                          ┌────────────────────────────────────┐
                          │ 返回结果: userId = 1                │
                          │ 响应时间:                           │
                          │   - 首次: ~5ms (查Redis)            │
                          │   - 后续: ~0.1ms (命中Caffeine)     │
                          └────────────────────────────────────┘

缓存写入流程:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  LoginHelper.login(loginUser, model)
       │
       ↓
  StpUtil.login() 调用 PlusSaTokenDao.setObject()
       │
       ├─ Step 1: 写入Redis（持久化）
       │   └─ RedisUtils.setCacheObject(key, value, 1800秒)
       │
       └─ Step 2: 清除Caffeine缓存
           └─ CAFFEINE.invalidate(key)
              └─ 原因: 保证数据一致性，下次读取时重新加载
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

性能统计（1000次请求）:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
场景                    │ Caffeine命中  │ Redis查询  │ 平均响应    │ QPS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
无缓存（直接查Redis）     │ 0次          │ 1000次    │ ~5ms       │ 2,000
单层Redis缓存           │ 0次          │ 1000次    │ ~5ms       │ 5,000
双层缓存（5秒内重复）     │ 800次        │ 200次     │ ~1.1ms     │ 18,000
双层缓存（高频访问）      │ 950次        │ 50次      │ ~0.5ms     │ 20,000
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 结论: 双层缓存在高频访问场景下性能提升10倍！
```

---

## 🎯 核心类关系图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              Sa-Token核心类关系                               │
└────────────────────────────────────────────────────────────────────────────┘

                     ┌──────────────────────┐
                     │   TokenController    │ ⭐⭐⭐⭐⭐
                     │  (登录入口控制器)      │
                     └──────────┬───────────┘
                                │
                                │ 调用
                                ↓
              ┌───────────────────────────────────┐
              │      IAuthStrategy (策略接口)      │
              └────────────┬──────────────────────┘
                           │
            ┌──────────────┼──────────────┬────────────┐
            │              │              │            │
            ↓              ↓              ↓            ↓
   ┌─────────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
   │ Password    │  │   Sms    │  │  Social  │  │  Email   │
   │ Strategy    │  │ Strategy │  │ Strategy │  │ Strategy │
   │ (密码认证)   │  │ (短信)    │  │ (第三方)  │  │ (邮箱)    │
   └──────┬──────┘  └─────┬────┘  └─────┬────┘  └─────┬────┘
          │               │              │             │
          └───────────────┴──────────────┴─────────────┤
                                                        │
                                 所有策略都调用           │
                                        ↓               │
                              ┌──────────────────┐      │
                              │  LoginHelper     │ ⭐⭐⭐⭐⭐
                              │  (Token工具类)    │      │
                              └────────┬─────────┘      │
                                       │                │
                        ┌──────────────┼────────────────┘
                        │              │
            ┌───────────▼──────┐      │
            │  StpUtil         │      │
            │  (Sa-Token核心)   │      │
            └───────────┬──────┘      │
                        │              │
                        └──────────────┤
                                       │
                                       ↓
                          ┌──────────────────────┐
                          │   PlusSaTokenDao     │ ⭐⭐⭐⭐
                          │   (多级缓存DAO)        │
                          └──────────┬───────────┘
                                     │
                        ┌────────────┴────────────┐
                        │                         │
                        ↓                         ↓
              ┌──────────────────┐     ┌──────────────────┐
              │  Caffeine缓存     │     │   Redis缓存       │
              │  (本地内存)        │     │   (分布式)        │
              └──────────────────┘     └──────────────────┘

类职责说明:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
类名                    │ 职责                     │ 重要度
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TokenController        │ 接收登录请求              │ ⭐⭐⭐⭐⭐
IAuthStrategy          │ 认证策略接口              │ ⭐⭐⭐⭐
PasswordAuthStrategy   │ 密码认证实现              │ ⭐⭐⭐⭐⭐
LoginHelper            │ Token操作统一接口          │ ⭐⭐⭐⭐⭐
StpUtil                │ Sa-Token核心API           │ ⭐⭐⭐⭐
PlusSaTokenDao         │ 多级缓存实现              │ ⭐⭐⭐⭐
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🔐 安全架构图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              Token安全机制                                   │
└────────────────────────────────────────────────────────────────────────────┘

1️⃣ CSRF防护
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ┌────────────────┐         ┌────────────────┐
  │ 攻击者网站       │         │ 正常网站        │
  │ evil.com       │         │ app.com        │
  └────────┬───────┘         └────────┬───────┘
           │                          │
           │ ❌ 无法获取Token            │ ✅ 有Token
           │    (不在Cookie中)          │    (在Header中)
           │                          │
           ↓                          ↓
  ┌──────────────────────────────────────────┐
  │ Gateway                                  │
  │ ├─ is-read-cookie: false (关闭Cookie)    │
  │ ├─ is-read-header: true  (只读Header)    │
  │ └─ 结果: 攻击请求被拒绝                    │
  └──────────────────────────────────────────┘

2️⃣ Token过期机制
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Token创建                 使用中                  过期
     │                       │                      │
     ├─ timeout: 1800秒      ├─ 每次请求             ├─ 超过30分钟
     │  (固定30分钟)          │  自动刷新活跃时间        │  自动失效
     │                       │  (如果配置了动态续期)     │
     ↓                       ↓                      ↓
  [━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━] 时间轴
  0分钟                    15分钟                  30分钟
  
  活跃超时（可选）:
  ├─ activeTimeout: -1 (不启用)
  └─ 或设置为1800秒（30分钟无操作自动失效）

3️⃣ JWT签名验证
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Token结构:
  ┌──────────────────────────────────────────────────────┐
  │ Header.Payload.Signature                             │
  │ ────────────────────────────────────────────────     │
  │ eyJhbGc.eyJsb2dpbk.HMACSHA256(Header+Payload+Secret)│
  │                                        ↑              │
  │                                        │              │
  │                              使用密钥签名，防止篡改     │
  └──────────────────────────────────────────────────────┘
  
  验证流程:
  ├─ 1. 提取Token
  ├─ 2. 分离Header、Payload、Signature
  ├─ 3. 使用相同算法和密钥重新计算签名
  ├─ 4. 对比签名
  └─ 5. 签名一致→Token有效，否则→Token被篡改

4️⃣ 多设备管理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  用户: admin (userId=1)
    │
    ├─ PC设备 (deviceType=pc)
    │   └─ Token1: eyJhbGc...
    │      └─ 状态: 在线
    │
    ├─ App设备 (deviceType=app)
    │   └─ Token2: eyJhbGc...
    │      └─ 状态: 在线
    │
    └─ iOS设备 (deviceType=ios)
        └─ Token3: eyJhbGc...
           └─ 状态: 在线
  
  管理操作:
  ├─ 查看所有在线设备: StpUtil.getTokenValueListByLoginId("1")
  ├─ 踢出指定设备: StpUtil.kickout("1", "app")
  └─ 踢出所有设备: StpUtil.logout("1")
```

---

## 📈 性能监控图

```
Token操作性能对比（1000次请求）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

操作: LoginHelper.getUserId()

无缓存（直接查Redis）:
[████████████████████████████████████████████████] 5000ms (100%)
QPS: 2,000

单层Redis缓存:
[████████████████████████████████████████████████] 5000ms (100%)
QPS: 5,000

双层缓存（Caffeine + Redis）:
[█████] 500ms (10%)
QPS: 20,000 ✅ 推荐

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

操作: LoginHelper.getLoginUser()

无缓存:
[████████████████████████████████████████████████] 5000ms (100%)

Caffeine + Redis:
[████████████████████████████████████████████████] 5000ms (100%)
原因: 需要反序列化完整对象，Caffeine优化效果有限

⚠️ 结论: 优先使用 getUserId() 等轻量级方法！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

缓存命中率统计（5秒内重复请求）:
┌────────────────────────────────────────┐
│ Caffeine命中率: 80%                     │ ████████
│ Redis命中率:    100%                    │ ██████████
│ 平均响应时间:   0.5ms                    │
└────────────────────────────────────────┘
```

---

**本架构图完整展示了Token在系统中的位置、工作流程和核心机制。**

**建议结合 [Token创建流程可视化](./Token创建流程可视化.md) 和 [Sa-Token创建与存储机制详解](./Sa-Token创建与存储机制详解.md) 一起阅读。**

